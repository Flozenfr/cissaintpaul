<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Calendrier CIS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --primary-lighter: rgba(67, 97, 238, 0.1);
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --info: #4895ef;
      --warning: #f8961e;
      --danger: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --white: #ffffff;
      --dark-blue: #1a237e;
      --amicale: #9d4edd;
      --defile: #f3722c;
      --sport: #43aa8b;
      
      --border-radius: 12px;
      --border-radius-sm: 8px;
      --box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      --box-shadow-sm: 0 5px 10px rgba(0,0,0,0.05);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #f5f7ff;
      color: var(--dark);
      line-height: 1.6;
      padding-bottom: 80px;
      -webkit-tap-highlight-color: transparent;
    }
    
    .container-app {
      max-width: 1600px;
      background-color: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 1rem;
      margin: 1rem auto;
      min-height: calc(100vh - 2rem);
    }
    
    .app-header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      position: relative;
    }
    
    .app-title {
      font-weight: 700;
      color: var(--secondary);
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      font-size: 1.5rem;
    }
    
    .app-version {
      position: absolute;
      right: 1rem;
      top: 0.5rem;
      font-size: 0.7rem;
      color: var(--gray);
    }
    
    .calendar-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
    
    .events-sidebar {
      background-color: var(--white);
      border-radius: var(--border-radius);
      padding: 1rem;
      height: fit-content;
      box-shadow: var(--box-shadow-sm);
      border: 1px solid rgba(0,0,0,0.05);
      order: 2;
    }
    
    .calendar {
      background-color: white;
      border-radius: var(--border-radius);
      padding: 1rem;
      box-shadow: var(--box-shadow-sm);
      border: 1px solid rgba(0,0,0,0.05);
      order: 1;
    }
    
    .calendar-header {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .calendar-title {
      font-weight: 600;
      font-size: 1.25rem;
      margin: 0;
      color: var(--dark-blue);
    }
    
    .calendar-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    
    .calendar-nav button {
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      color: var(--gray);
    }
    
    .calendar-nav button:hover {
      background-color: var(--primary-lighter);
      color: var(--primary);
    }
    
    .calendar-nav .today-btn {
      font-size: 0.8rem;
      padding: 0.4rem 0.8rem;
      border-radius: 50px;
      border: 1px solid var(--primary);
      color: var(--primary);
      background-color: transparent;
      font-weight: 500;
    }
    
    .calendar-nav .today-btn:hover {
      background-color: var(--primary);
      color: white;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }
    
    .calendar-day-header {
      text-align: center;
      font-weight: 600;
      padding: 0.5rem 0.25rem;
      color: var(--primary);
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.5px;
    }
    
    .calendar-day {
      min-height: 60px;
      border-radius: var(--border-radius-sm);
      padding: 0.5rem;
      background-color: white;
      border: 1px solid rgba(0,0,0,0.05);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      aspect-ratio: 1;
    }
    
    .calendar-day:hover {
      transform: translateY(-3px);
      box-shadow: var(--box-shadow-sm);
      border-color: var(--primary-light);
    }
    
    .calendar-day-number {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--dark);
      font-size: 0.9rem;
    }
    
    .calendar-day.today .calendar-day-number {
      color: var(--primary);
      font-weight: 700;
    }
    
    .calendar-day.today {
      background-color: rgba(67, 97, 238, 0.05);
      border: 2px solid var(--primary);
    }
    
    .calendar-day.other-month {
      opacity: 0.5;
      background-color: rgba(0,0,0,0.02);
    }
    
    .calendar-day.weekend {
      background-color: rgba(0,0,0,0.01);
    }
    
    .calendar-event {
      font-size: 0.6rem;
      padding: 0.25rem 0.35rem;
      margin-bottom: 0.15rem;
      border-radius: 3px;
      background-color: var(--primary-light);
      color: white;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      transition: var(--transition);
      font-weight: 500;
    }
    
    .calendar-event:hover {
      background-color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .calendar-event.urgent {
      background-color: var(--danger);
    }
    
    .calendar-event.important {
      background-color: var(--warning);
      color: var(--dark);
    }
    
    .calendar-event.meeting {
      background-color: var(--success);
    }
    
    .calendar-event.training {
      background-color: var(--info);
    }
    
    .calendar-event.amicale {
      background-color: var(--amicale);
    }
    
    .calendar-event.defile {
      background-color: var(--defile);
    }
    
    .calendar-event.sport {
      background-color: var(--sport);
    }
    
    .event-item {
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      border-radius: var(--border-radius-sm);
      background-color: white;
      box-shadow: var(--box-shadow-sm);
      transition: var(--transition);
      border-left: 4px solid var(--primary);
      cursor: pointer;
    }
    
    .event-item:hover {
      transform: translateY(-3px);
      box-shadow: var(--box-shadow);
    }
    
    .event-item.urgent {
      border-left-color: var(--danger);
    }
    
    .event-item.important {
      border-left-color: var(--warning);
    }
    
    .event-item.meeting {
      border-left-color: var(--success);
    }
    
    .event-item.training {
      border-left-color: var(--info);
    }
    
    .event-item.amicale {
      border-left-color: var(--amicale);
    }
    
    .event-item.defile {
      border-left-color: var(--defile);
    }
    
    .event-item.sport {
      border-left-color: var(--sport);
    }
    
    .event-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.25rem;
    }
    
    .event-item-title {
      font-weight: 600;
      margin: 0;
      color: var(--dark);
      font-size: 0.9rem;
    }
    
    .event-item-date {
      font-size: 0.75rem;
      color: var(--gray);
      text-align: right;
      min-width: 100px;
    }
    
    .event-item-description {
      font-size: 0.8rem;
      color: var(--gray);
      margin-bottom: 0.25rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .event-item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      font-size: 0.7rem;
    }
    
    .event-item-location {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: var(--gray);
    }
    
    .event-item-participants {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: var(--danger);
      font-weight: 600;
    }
    
    .participant-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background-color: var(--primary-lighter);
      color: var(--primary);
      padding: 0.2rem 0.4rem;
      border-radius: 50px;
      font-size: 0.7rem;
      font-weight: 500;
    }
    
    .participant-badge .btn-close {
      font-size: 0.5rem;
      margin-left: 0.15rem;
    }
    
    .btn {
      font-weight: 600;
      padding: 0.6rem 1rem;
      border-radius: var(--border-radius-sm);
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    .btn-sm {
      padding: 0.4rem 0.6rem;
      font-size: 0.8rem;
    }
    
    .btn i {
      font-size: 1em;
    }
    
    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-primary:hover {
      background-color: var(--secondary);
      border-color: var(--secondary);
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-sm);
    }
    
    .btn-outline-primary {
      color: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-outline-primary:hover {
      background-color: var(--primary);
      color: white;
    }
    
    .btn-outline-amicale {
      color: var(--amicale);
      border-color: var(--amicale);
    }
    
    .btn-outline-amicale:hover {
      background-color: var(--amicale);
      color: white;
    }
    
    .btn-outline-defile {
      color: var(--defile);
      border-color: var(--defile);
    }
    
    .btn-outline-defile:hover {
      background-color: var(--defile);
      color: white;
    }
    
    .btn-outline-sport {
      color: var(--sport);
      border-color: var(--sport);
    }
    
    .btn-outline-sport:hover {
      background-color: var(--sport);
      color: white;
    }
    
    .modal-content {
      border-radius: var(--border-radius);
      border: none;
      box-shadow: var(--box-shadow);
    }
    
    .modal-header {
      border-bottom: none;
      background-color: var(--primary);
      color: white;
      border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
      padding: 1rem;
    }
    
    .modal-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .modal-body {
      padding: 1rem;
    }
    
    .modal-footer {
      border-top: none;
      padding: 0.75rem 1rem;
      background-color: #f8f9fa;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
    }
    
    .form-label {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    .form-control, .form-select {
      border-radius: var(--border-radius-sm);
      padding: 0.6rem 0.8rem;
      border: 1px solid rgba(0,0,0,0.1);
      transition: var(--transition);
      font-size: 0.9rem;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-light);
      box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.15);
    }
    
    .form-check-input:checked {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    
    .badge {
      font-weight: 500;
      padding: 0.4em 0.6em;
      border-radius: 50px;
      font-size: 0.8rem;
    }
    
    .badge-primary {
      background-color: var(--primary);
    }
    
    .badge-urgent {
      background-color: var(--danger);
    }
    
    .badge-important {
      background-color: var(--warning);
      color: var(--dark);
    }
    
    .badge-meeting {
      background-color: var(--success);
    }
    
    .badge-training {
      background-color: var(--info);
    }
    
    .badge-amicale {
      background-color: var(--amicale);
    }
    
    .badge-defile {
      background-color: var(--defile);
    }
    
    .badge-sport {
      background-color: var(--sport);
    }
    
    .toast-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1100;
    }
    
    .toast {
      border-radius: var(--border-radius-sm);
      border: none;
      box-shadow: var(--box-shadow);
    }
    
    .search-box {
      position: relative;
      margin-bottom: 1rem;
    }
    
    .search-box i {
      position: absolute;
      left: 0.8rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-size: 0.9rem;
    }
    
    .search-box input {
      padding-left: 2rem;
      border-radius: 50px;
      border: 1px solid rgba(0,0,0,0.1);
      font-size: 0.9rem;
    }
    
    .no-events {
      text-align: center;
      padding: 1.5rem;
      color: var(--gray);
    }
    
    .no-events i {
      font-size: 1.5rem;
      margin-bottom: 0.75rem;
      opacity: 0.5;
    }
    
    .event-type-badge {
      font-size: 0.6rem;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      margin-left: 0.5rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .event-detail-item {
      margin-bottom: 0.75rem;
    }
    
    .event-detail-label {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    .event-detail-value {
      padding-left: 1.5rem;
      font-size: 0.9rem;
    }
    
    .participants-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    
    .participant-card {
      background-color: white;
      border-radius: var(--border-radius-sm);
      padding: 0.5rem;
      text-align: center;
      box-shadow: var(--box-shadow-sm);
      transition: var(--transition);
    }
    
    .participant-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--box-shadow);
    }
    
    .participant-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background-color: var(--primary-lighter);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.25rem;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .participant-name {
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .event-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    /* Filtres responsive */
    .filter-dropdown {
      display: none;
    }
    
    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    /* Vue semaine */
    .week-view {
      display: none;
      margin-top: 1rem;
    }
    
    .week-day {
      margin-bottom: 1rem;
    }
    
    .week-day-header {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      background-color: var(--primary-lighter);
      border-radius: var(--border-radius-sm);
      margin-bottom: 0.5rem;
    }
    
    .week-day-name {
      font-weight: 600;
      color: var(--primary);
      margin-right: 0.5rem;
    }
    
    .week-day-date {
      font-size: 0.9rem;
      color: var(--gray);
    }
    
    .week-day-today .week-day-header {
      background-color: rgba(67, 97, 238, 0.2);
    }
    
    .week-day-today .week-day-name {
      font-weight: 700;
    }
    
    /* Vue liste */
    .list-view {
      display: none;
      margin-top: 1rem;
    }
    
    /* Switch vue */
    .view-switcher {
      display: none; /* Caché sur mobile - remplacé par la barre du bas */
    }
    
    .view-switcher button {
      background: none;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }
    
    .view-switcher button.active {
      background-color: var(--primary);
      color: white;
    }
    
    /* Swipe pour changer de mois */
    .calendar-swipe-area {
      position: relative;
      overflow: hidden;
      touch-action: pan-y;
    }
    
    /* Mobile optimizations */
    .mobile-nav-buttons {
      display: none;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    
    .mobile-nav-btn {
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius-sm);
      background-color: var(--primary-lighter);
      color: var(--primary);
      font-weight: 600;
      border: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Barre de navigation mobile */
    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: var(--white);
      padding: 0.5rem;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      display: flex;
      justify-content: space-around;
      align-items: center;
    }
    
    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: var(--gray);
      font-size: 0.7rem;
      padding: 0.5rem;
      border-radius: var(--border-radius-sm);
      transition: var(--transition);
      flex: 1;
    }
    
    .mobile-nav-item i {
      font-size: 1.2rem;
      margin-bottom: 0.25rem;
    }
    
    .mobile-nav-item.active {
      color: var(--primary);
      background-color: var(--primary-lighter);
    }
    
    .mobile-nav-item .badge {
      position: absolute;
      top: -5px;
      right: 15px;
      font-size: 0.6rem;
      padding: 0.2rem 0.4rem;
    }
    
    /* Offline indicator */
    .offline-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: var(--danger);
      color: white;
      text-align: center;
      padding: 0.5rem;
      z-index: 1100;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
    }
    
    .offline-indicator.show {
      transform: translateY(0);
    }
    
    /* Quick join form */
    .quick-join-form {
      display: none;
      padding: 1rem;
      background-color: var(--light);
      border-radius: var(--border-radius-sm);
      margin-top: 1rem;
    }
    
    .quick-join-form.show {
      display: block;
    }
    
    .quick-join-btn {
      margin-top: 0.5rem;
      width: 100%;
    }
    
    /* Toggle events button */
    .toggle-events-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-bottom: 0.5rem;
    }
    
    /* Styles pour les écrans moyens et grands */
    @media (min-width: 768px) {
      .container-app {
        padding: 2rem;
        margin: 2rem auto;
      }
      
      .app-title {
        font-size: 1.75rem;
      }
      
      .calendar-container {
        grid-template-columns: 300px 1fr;
      }
      
      .events-sidebar {
        order: 1;
      }
      
      .calendar {
        order: 2;
      }
      
      .calendar-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      
      .calendar-nav {
        width: auto;
        gap: 0.5rem;
      }
      
      .calendar-title {
        font-size: 1.5rem;
      }
      
      .calendar-day {
        min-height: 100px;
      }
      
      .calendar-event {
        font-size: 0.7rem;
        padding: 0.3rem 0.5rem;
      }
      
      .event-item {
        padding: 1rem;
      }
      
      .event-item-title {
        font-size: 1rem;
      }
      
      .modal-body {
        padding: 1.5rem;
      }
      
      /* Afficher le view-switcher sur desktop */
      .view-switcher {
        display: flex;
        justify-content: center;
        margin-bottom: 1rem;
        gap: 0.5rem;
      }
      
      /* Cacher la barre du bas sur desktop */
      .mobile-bottom-nav {
        display: none;
      }
    }
    
    @media (min-width: 992px) {
      .calendar-container {
        grid-template-columns: 350px 1fr;
      }
      
      .calendar-day {
        aspect-ratio: 1;
        min-height: auto;
      }
    }
    
    /* Styles spécifiques pour mobile */
    @media (max-width: 767px) {
      .container-app {
        padding: 0;
        margin: 0;
        border-radius: 0;
        min-height: 100vh;
        padding-bottom: 60px; /* Espace pour la barre du bas */
      }
      
      .app-header {
        padding: 1rem;
        margin-bottom: 0.5rem;
      }
      
      .calendar-day {
        min-height: 50px;
        padding: 0.25rem;
      }
      
      .calendar-day-number {
        font-size: 0.8rem;
      }
      
      .calendar-event {
        font-size: 0.5rem;
        padding: 0.1rem 0.2rem;
        margin-bottom: 0.1rem;
      }
      
      .filter-dropdown {
        display: block;
        margin-bottom: 1rem;
      }
      
      .filter-buttons {
        display: none;
      }
      
      /* Afficher la navigation mobile */
      .mobile-nav-buttons {
        display: flex;
      }
      
      /* Masquer la navigation desktop */
      .calendar-nav {
        display: none;
      }
      
      /* Ajustements pour la vue semaine sur mobile */
      .week-day-header {
        padding: 0.5rem 0.25rem;
        font-size: 0.9rem;
      }
      
      .week-day-name {
        font-size: 0.8rem;
      }
      
      .week-day-date {
        font-size: 0.8rem;
      }
      
      /* Ajustements pour la modal sur mobile */
      .modal-dialog {
        margin: 0.5rem;
      }
      
      .modal-body {
        padding: 1rem 0.5rem;
      }
      
      /* Ajustements pour les événements dans la sidebar */
      .events-sidebar {
        padding: 0.75rem;
      }
      
      .event-item {
        padding: 0.5rem;
      }
      
      .event-item-title {
        font-size: 0.85rem;
      }
      
      .event-item-date {
        font-size: 0.7rem;
      }
      
      /* Amélioration du swipe */
      .calendar-swipe-area {
        padding: 0 0.5rem;
      }
    }
    
    /* Très petits écrans */
    @media (max-width: 400px) {
      .calendar-day-header {
        font-size: 0.6rem;
        padding: 0.25rem 0;
      }
      
      .calendar-day-number {
        font-size: 0.7rem;
      }
      
      .mobile-nav-item {
        font-size: 0.6rem;
        padding: 0.3rem;
      }
      
      .mobile-nav-item i {
        font-size: 1rem;
      }
    }
    
    /* Animation pour les événements */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .event-item {
      animation: fadeIn 0.3s ease-out;
    }
    
    /* Style pour les jours avec événements */
    .calendar-day.has-events {
      position: relative;
    }
    
    .calendar-day.has-events::after {
      content: '';
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background-color: var(--primary);
    }
    
    /* Style pour les événements urgents */
    .calendar-day.has-urgent-events::after {
      background-color: var(--danger);
    }
    
    /* Style pour la vue jour */
    .time-slot {
      display: flex;
      margin-bottom: 1rem;
    }
    
    .time-slot-hour {
      width: 60px;
      font-weight: 600;
      color: var(--primary);
    }
    
    .time-slot-events {
      flex: 1;
    }
    
    /* Style pour les événements dans la vue jour */
    .day-event {
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-radius: var(--border-radius-sm);
      background-color: white;
      box-shadow: var(--box-shadow-sm);
      border-left: 4px solid var(--primary);
    }
    
    .day-event.urgent {
      border-left-color: var(--danger);
    }
    
    .day-event.important {
      border-left-color: var(--warning);
    }
    
    .day-event.meeting {
      border-left-color: var(--success);
    }
    
    .day-event.training {
      border-left-color: var(--info);
    }
    
    .day-event.amicale {
      border-left-color: var(--amicale);
    }
    
    .day-event.defile {
      border-left-color: var(--defile);
    }
    
    .day-event.sport {
      border-left-color: var(--sport);
    }
    
    /* Style pour le compteur de participants */
    .participant-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background-color: var(--danger);
      color: white;
      font-size: 0.6rem;
      font-weight: bold;
      margin-left: 0.3rem;
    }
  </style>
</head>
<body>
  <!-- Indicateur de connexion -->
  <div class="offline-indicator" id="offlineIndicator">
    <i class="bi bi-wifi-off"></i> Vous êtes hors ligne - Mode hors ligne activé
  </div>

  <div class="container-app">
    <header class="app-header">
      <h1 class="app-title">
        <i class="bi bi-calendar-event"></i> 
        Calendrier CIS
      </h1>
      <div class="app-version">v2.2</div>
    </header>
    
    <div class="calendar-container">
      <!-- Sidebar des événements -->
      <div class="events-sidebar">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="mb-0">Événements à venir</h3>
          <button class="btn btn-primary btn-sm" id="addEventBtn">
            <i class="bi bi-plus-lg"></i> <span class="d-none d-md-inline">Ajouter</span>
          </button>
        </div>
        
        <div class="search-box">
          <i class="bi bi-search"></i>
          <input type="text" id="eventsSearch" class="form-control" placeholder="Rechercher un événement...">
        </div>
        
        <!-- Filtres version desktop -->
        <div class="filter-buttons" id="eventsFilters">
          <button class="btn btn-sm btn-outline-primary active" data-filter="all">Tous</button>
          <button class="btn btn-sm btn-outline-danger" data-filter="urgent">Urgent</button>
          <button class="btn btn-sm btn-outline-warning" data-filter="important">Important</button>
          <button class="btn btn-sm btn-outline-success" data-filter="meeting">Réunion</button>
          <button class="btn btn-sm btn-outline-info" data-filter="training">Formation</button>
          <button class="btn btn-sm btn-outline-amicale" data-filter="amicale">Amicale</button>
          <button class="btn btn-sm btn-outline-defile" data-filter="defile">Défilé</button>
          <button class="btn btn-sm btn-outline-sport" data-filter="sport">Sport</button>
        </div>
        
        <!-- Filtres version mobile -->
        <div class="filter-dropdown">
          <select class="form-select" id="mobileFilter">
            <option value="all">Tous les événements</option>
            <option value="urgent">Urgent</option>
            <option value="important">Important</option>
            <option value="meeting">Réunion</option>
            <option value="training">Formation</option>
            <option value="amicale">Amicale</option>
            <option value="defile">Défilé</option>
            <option value="sport">Sport</option>
          </select>
        </div>
        
        <!-- Bouton pour afficher/masquer les événements -->
        <button class="toggle-events-btn" id="toggleEventsBtn">
          <i class="bi bi-chevron-down"></i> Afficher les événements
        </button>
        
        <div id="eventsList" style="display: none;">
          <!-- Événements seront chargés ici -->
        </div>
        
        <!-- Formulaire rapide pour s'ajouter à un événement -->
        <div class="quick-join-form" id="quickJoinForm">
          <h5 class="mb-2">S'inscrire à un événement</h5>
          <input type="text" id="quickJoinEventId" class="form-control mb-2" placeholder="ID de l'événement">
          <input type="text" id="quickJoinName" class="form-control mb-2" placeholder="Votre nom et prénom">
          <button class="btn btn-primary quick-join-btn" id="quickJoinBtn">
            <i class="bi bi-person-plus"></i> S'inscrire
          </button>
        </div>
      </div>
      
      <!-- Calendrier -->
      <div class="calendar">
        <!-- Navigation mobile -->
        <div class="mobile-nav-buttons">
          <button class="mobile-nav-btn" id="mobilePrevBtn">
            <i class="bi bi-chevron-left"></i> Précédent
          </button>
          <button class="mobile-nav-btn" id="mobileTodayBtn">
            <i class="bi bi-calendar-event"></i> Aujourd'hui
          </button>
          <button class="mobile-nav-btn" id="mobileNextBtn">
            Suivant <i class="bi bi-chevron-right"></i>
          </button>
        </div>
        
        <div class="view-switcher">
          <button class="active" id="monthViewBtn"><i class="bi bi-calendar-month"></i> Mois</button>
          <button id="weekViewBtn"><i class="bi bi-calendar-week"></i> Semaine</button>
          <button id="listViewBtn"><i class="bi bi-list-ul"></i> Liste</button>
          <button id="dayViewBtn"><i class="bi bi-calendar-day"></i> Jour</button>
        </div>
        
        <div id="monthView" class="calendar-swipe-area">
          <div class="calendar-header">
            <h2 class="calendar-title" id="calendarMonthYear">Mois Année</h2>
            <div class="calendar-nav">
              <button id="prevYear" title="Année précédente"><i class="bi bi-chevron-double-left"></i></button>
              <button id="prevMonth" title="Mois précédent"><i class="bi bi-chevron-left"></i></button>
              <button id="today" class="today-btn">Aujourd'hui</button>
              <button id="nextMonth" title="Mois suivant"><i class="bi bi-chevron-right"></i></button>
              <button id="nextYear" title="Année suivante"><i class="bi bi-chevron-double-right"></i></button>
            </div>
          </div>
          
          <div class="calendar-grid" id="calendarDaysHeader">
            <div class="calendar-day-header">Lun</div>
            <div class="calendar-day-header">Mar</div>
            <div class="calendar-day-header">Mer</div>
            <div class="calendar-day-header">Jeu</div>
            <div class="calendar-day-header">Ven</div>
            <div class="calendar-day-header">Sam</div>
            <div class="calendar-day-header">Dim</div>
          </div>
          
          <div class="calendar-grid" id="calendarDays">
            <!-- Jours seront générés ici -->
          </div>
        </div>
        
        <!-- Vue semaine -->
        <div class="week-view" id="weekView">
          <div class="calendar-header">
            <h2 class="calendar-title" id="weekTitle">Semaine du ...</h2>
            <div class="calendar-nav">
              <button id="prevWeek" title="Semaine précédente"><i class="bi bi-chevron-left"></i></button>
              <button id="todayWeek" class="today-btn">Cette semaine</button>
              <button id="nextWeek" title="Semaine suivante"><i class="bi bi-chevron-right"></i></button>
            </div>
          </div>
          
          <div id="weekDays">
            <!-- Jours de la semaine seront générés ici -->
          </div>
        </div>
        
        <!-- Vue liste -->
        <div class="list-view" id="listView">
          <div class="calendar-header">
            <h2 class="calendar-title">Tous les événements</h2>
            <div class="calendar-nav">
              <button id="listToday" class="today-btn">Aujourd'hui</button>
            </div>
          </div>
          
          <div id="eventsListView">
            <!-- Événements en liste seront générés ici -->
          </div>
        </div>
        
        <!-- Vue jour -->
        <div class="list-view" id="dayView">
          <div class="calendar-header">
            <h2 class="calendar-title" id="dayTitle">Jour ...</h2>
            <div class="calendar-nav">
              <button id="prevDay" title="Jour précédent"><i class="bi bi-chevron-left"></i></button>
              <button id="todayDay" class="today-btn">Aujourd'hui</button>
              <button id="nextDay" title="Jour suivant"><i class="bi bi-chevron-right"></i></button>
            </div>
          </div>
          
          <div id="dayEvents">
            <!-- Événements du jour seront générés ici -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barre de navigation mobile -->
  <div class="mobile-bottom-nav">
    <a href="#" class="mobile-nav-item active" id="mobileNavMonth">
      <i class="bi bi-calendar-month"></i>
      <span>Mois</span>
    </a>
    <a href="#" class="mobile-nav-item" id="mobileNavWeek">
      <i class="bi bi-calendar-week"></i>
      <span>Semaine</span>
    </a>
    <a href="#" class="mobile-nav-item" id="mobileNavDay">
      <i class="bi bi-calendar-day"></i>
      <span>Jour</span>
    </a>
    <a href="#" class="mobile-nav-item" id="mobileNavList">
      <i class="bi bi-list-ul"></i>
      <span>Liste</span>
    </a>
    <a href="#" class="mobile-nav-item" id="mobileNavAdd">
      <i class="bi bi-plus-circle"></i>
      <span>Ajouter</span>
    </a>
  </div>

  <!-- Modal pour ajouter/modifier un événement -->
  <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-calendar-plus"></i> 
            <span id="modalTitle">Nouvel Événement</span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="eventForm">
            <div class="row">
              <div class="col-md-8">
                <div class="mb-3">
                  <label for="eventTitle" class="form-label">
                    <i class="bi bi-card-heading"></i> Titre de l'événement
                  </label>
                  <input type="text" class="form-control" id="eventTitle" required>
                </div>
                
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="eventDate" class="form-label">
                      <i class="bi bi-calendar-date"></i> Date
                    </label>
                    <input type="date" class="form-control" id="eventDate" required>
                  </div>
                  <div class="col-md-6">
                    <label for="eventTime" class="form-label">
                      <i class="bi bi-clock"></i> Heure
                    </label>
                    <input type="time" class="form-control" id="eventTime" required>
                  </div>
                </div>
                
                <div class="mb-3">
                  <label for="eventDescription" class="form-label">
                    <i class="bi bi-text-paragraph"></i> Description
                  </label>
                  <textarea class="form-control" id="eventDescription" rows="3" placeholder="Détails de l'événement..."></textarea>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="eventType" class="form-label">
                    <i class="bi bi-tag"></i> Type d'événement
                  </label>
                  <select class="form-select" id="eventType">
                    <option value="normal" selected>Normal</option>
                    <option value="urgent">Urgent</option>
                    <option value="important">Important</option>
                    <option value="meeting">Réunion</option>
                    <option value="training">Formation</option>
                    <option value="amicale">Amicale</option>
                    <option value="defile">Défilé</option>
                    <option value="sport">Sport</option>
                  </select>
                </div>
                
                <div class="mb-3">
                  <label for="eventLocation" class="form-label">
                    <i class="bi bi-geo-alt"></i> Lieu
                  </label>
                  <input type="text" class="form-control" id="eventLocation" placeholder="Salle de réunion, adresse...">
                </div>
                
                <div class="mb-3">
                  <label class="form-label">
                    <i class="bi bi-alarm"></i> Durée
                  </label>
                  <select class="form-select" id="eventDuration">
                    <option value="30">30 minutes</option>
                    <option value="60" selected>1 heure</option>
                    <option value="90">1 heure 30</option>
                    <option value="120">2 heures</option>
                    <option value="180">3 heures</option>
                    <option value="240">4 heures</option>
                    <option value="0">Toute la journée</option>
                  </select>
                </div>
                
                <div class="mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="eventRecurring">
                    <label class="form-check-label" for="eventRecurring">
                      <i class="bi bi-arrow-repeat"></i> Événement récurrent
                    </label>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="mb-3" id="recurringOptions" style="display: none;">
              <label class="form-label">
                <i class="bi bi-calendar-week"></i> Options de récurrence
              </label>
              <div class="row">
                <div class="col-md-4">
                  <select class="form-select" id="recurrenceFrequency">
                    <option value="weekly">Hebdomadaire</option>
                    <option value="monthly">Mensuelle</option>
                    <option value="yearly">Annuelle</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <select class="form-select" id="recurrenceInterval">
                    <option value="1">Toutes les semaines</option>
                    <option value="2">Toutes les 2 semaines</option>
                    <option value="3">Toutes les 3 semaines</option>
                    <option value="4">Toutes les 4 semaines</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <input type="number" class="form-control" id="recurrenceCount" placeholder="Nombre d'occurrences" min="1">
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-people"></i> Participants
              </label>
              <div class="input-group mb-2">
                <input type="text" class="form-control" id="participantName" placeholder="Nom et prénom">
                <button class="btn btn-outline-primary" type="button" id="addParticipant">
                  <i class="bi bi-plus-lg"></i> <span class="d-none d-sm-inline">Ajouter</span>
                </button>
              </div>
              <div id="participantsList" class="d-flex flex-wrap gap-2"></div>
            </div>
            
            <input type="hidden" id="eventId">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Annuler
          </button>
          <button type="button" class="btn btn-primary" id="saveEventBtn">
            <i class="bi bi-save"></i> Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour voir les détails d'un événement -->
  <div class="modal fade" id="viewEventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-calendar-event"></i> 
            <span id="viewEventTitle">Détails de l'événement</span>
            <span id="viewEventTypeBadge" class="event-type-badge"></span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="viewEventBody">
          <!-- Contenu dynamique -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Fermer
          </button>
          <button type="button" class="btn btn-outline-primary" id="editEventBtn">
            <i class="bi bi-pencil"></i> Modifier
          </button>
          <button type="button" class="btn btn-outline-danger" id="deleteEventBtn">
            <i class="bi bi-trash"></i> Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container" id="toastContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  
  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDVD-VSJnQBBxV-xGaG2hSroKATe0PCoFI",
      authDomain: "calendrier-cis.firebaseapp.com",
      databaseURL: "https://calendrier-cis-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "calendrier-cis",
      storageBucket: "calendrier-cis.firebasestorage.app",
      messagingSenderId: "765976767744",
      appId: "1:765976767744:web:3a865f5b727bbdd49e57e5",
      measurementId: "G-XW60PQP1E5"
    };

    // Initialisation Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    
    // Variables globales
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let currentWeek = getWeekNumber(new Date());
    let currentDay = new Date();
    let events = {};
    let participants = [];
    let currentEditingEventId = null;
    let currentFilter = 'all';
    let currentView = 'month'; // 'month', 'week', 'day' ou 'list'
    let isOnline = navigator.onLine;
    let touchStartX = 0;
    let touchEndX = 0;
    let showEvents = false; // Pour afficher/masquer les événements
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      initCalendar();
      loadEvents();
      setupEventListeners();
      checkOnlineStatus();
      
      // Écouter les changements de connexion
      window.addEventListener('online', handleOnlineStatusChange);
      window.addEventListener('offline', handleOnlineStatusChange);
      
      // Initialiser l'authentification anonyme
      initAuth();
    });
    
    function initAuth() {
      auth.signInAnonymously()
        .then(() => {
          console.log("Authentifié anonymement");
        })
        .catch(error => {
          console.error("Erreur d'authentification:", error);
        });
    }
    
    function checkOnlineStatus() {
      isOnline = navigator.onLine;
      updateOnlineIndicator();
    }
    
    function handleOnlineStatusChange() {
      checkOnlineStatus();
      if (isOnline) {
        // Synchroniser les données lorsqu'on revient en ligne
        loadEvents();
        showToast("Vous êtes de nouveau en ligne", 'success');
      } else {
        showToast("Mode hors ligne activé", 'warning');
      }
    }
    
    function updateOnlineIndicator() {
      const indicator = document.getElementById('offlineIndicator');
      if (isOnline) {
        indicator.classList.remove('show');
      } else {
        indicator.classList.add('show');
      }
    }
    
    function initCalendar() {
      updateCalendar();
      
      // Configurer le swipe pour mobile
      const swipeArea = document.querySelector('.calendar-swipe-area');
      if (swipeArea) {
        swipeArea.addEventListener('touchstart', handleTouchStart, false);
        swipeArea.addEventListener('touchend', handleTouchEnd, false);
      }
    }
    
    function handleTouchStart(event) {
      touchStartX = event.changedTouches[0].screenX;
    }
    
    function handleTouchEnd(event) {
      touchEndX = event.changedTouches[0].screenX;
      handleSwipe();
    }
    
    function handleSwipe() {
      const threshold = 50; // Seuil minimal pour considérer un swipe
      
      if (touchEndX < touchStartX - threshold) {
        // Swipe vers la gauche - mois suivant
        document.getElementById('nextMonth').click();
      } else if (touchEndX > touchStartX + threshold) {
        // Swipe vers la droite - mois précédent
        document.getElementById('prevMonth').click();
      }
    }
    
    function updateCalendar() {
      if (currentView === 'month') {
        updateMonthView();
      } else if (currentView === 'week') {
        updateWeekView();
      } else if (currentView === 'day') {
        updateDayView();
      } else if (currentView === 'list') {
        updateListView();
      }
      
      updateEventsList();
      updateMobileNav();
    }
    
    function updateMobileNav() {
      // Mettre à jour l'état actif dans la barre de navigation mobile
      document.querySelectorAll('.mobile-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      if (currentView === 'month') {
        document.getElementById('mobileNavMonth').classList.add('active');
      } else if (currentView === 'week') {
        document.getElementById('mobileNavWeek').classList.add('active');
      } else if (currentView === 'day') {
        document.getElementById('mobileNavDay').classList.add('active');
      } else if (currentView === 'list') {
        document.getElementById('mobileNavList').classList.add('active');
      }
    }
    
    function updateMonthView() {
      const calendarDays = document.getElementById('calendarDays');
      calendarDays.innerHTML = '';
      
      // Mettre à jour le titre du mois/année
      const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
      document.getElementById('calendarMonthYear').textContent = `${monthNames[currentMonth]} ${currentYear}`;
      
      // Premier jour du mois
      const firstDay = new Date(currentYear, currentMonth, 1);
      // Dernier jour du mois
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      // Jour de la semaine du premier jour (0=Dimanche, 1=Lundi, etc.)
      const firstDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Ajustement pour commencer par Lundi
      
      // Jours du mois précédent
      const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
      
      // Jours du mois suivant
      const daysInMonth = lastDay.getDate();
      
      // Total des cases à afficher (6 lignes de 7 jours)
      const totalDays = 42;
      
      // Aujourd'hui
      const today = new Date();
      const isCurrentMonth = today.getFullYear() === currentYear && today.getMonth() === currentMonth;
      
      // Générer les jours du calendrier
      for (let i = 0; i < totalDays; i++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        let dayNumber;
        let isOtherMonth = false;
        let dayDate;
        
        if (i < firstDayOfWeek) {
          // Jours du mois précédent
          dayNumber = prevMonthLastDay - (firstDayOfWeek - 1 - i);
          isOtherMonth = true;
          dayDate = new Date(currentYear, currentMonth - 1, dayNumber);
        } else if (i >= firstDayOfWeek + daysInMonth) {
          // Jours du mois suivant
          dayNumber = i - (firstDayOfWeek + daysInMonth) + 1;
          isOtherMonth = true;
          dayDate = new Date(currentYear, currentMonth + 1, dayNumber);
        } else {
          // Jours du mois courant
          dayNumber = i - firstDayOfWeek + 1;
          dayDate = new Date(currentYear, currentMonth, dayNumber);
        }
        
        if (isOtherMonth) {
          dayElement.classList.add('other-month');
        }
        
        // Vérifier si c'est aujourd'hui
        if (isCurrentMonth && dayNumber === today.getDate()) {
          dayElement.classList.add('today');
        }
        
        // Vérifier si c'est un week-end
        if (dayDate.getDay() === 0 || dayDate.getDay() === 6) {
          dayElement.classList.add('weekend');
        }
        
        dayElement.innerHTML = `<div class="calendar-day-number">${dayNumber}</div>`;
        
        // Ajouter les événements pour ce jour
        const dateKey = formatDateKey(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate());
        if (events[dateKey]) {
          // Filtrer selon le filtre actif
          const filteredEvents = filterEvents(events[dateKey]);
          
          // Marquer le jour comme ayant des événements
          dayElement.classList.add('has-events');
          
          // Vérifier s'il y a des événements urgents
          const hasUrgentEvents = filteredEvents.some(e => e.type === 'urgent');
          if (hasUrgentEvents) {
            dayElement.classList.add('has-urgent-events');
          }
          
          // Limiter à 3 événements visibles par jour
          const eventsToShow = filteredEvents.slice(0, 3);
          const extraEventsCount = filteredEvents.length - 3;
          
          eventsToShow.forEach(event => {
            const eventElement = document.createElement('div');
            eventElement.className = `calendar-event ${event.type}`;
            eventElement.textContent = event.title;
            eventElement.setAttribute('data-id', event.id);
            
            // Ajouter le nombre de participants si nécessaire
            if (event.participants?.length > 0) {
              const participantBadge = document.createElement('span');
              participantBadge.className = 'participant-count';
              participantBadge.textContent = event.participants.length;
              eventElement.appendChild(participantBadge);
            }
            
            dayElement.appendChild(eventElement);
          });
          
          // Afficher un indicateur s'il y a plus d'événements
          if (extraEventsCount > 0) {
            const extraElement = document.createElement('div');
            extraElement.className = 'calendar-event';
            extraElement.textContent = `+${extraEventsCount} autres`;
            extraElement.style.backgroundColor = 'rgba(0,0,0,0.1)';
            extraElement.style.color = 'var(--gray)';
            extraElement.style.cursor = 'default';
            dayElement.appendChild(extraElement);
          }
        }
        
        // Ajouter un événement de clic pour ajouter un événement
        dayElement.addEventListener('click', function(e) {
          if (e.target === dayElement || e.target.classList.contains('calendar-day-number')) {
            openAddEventModal(dayDate);
          }
        });
        
        // Ajouter un événement de clic pour voir les détails d'un événement
        dayElement.addEventListener('click', function(e) {
          if (e.target.classList.contains('calendar-event') && !e.target.style.backgroundColor) {
            const eventId = e.target.getAttribute('data-id');
            viewEvent(eventId);
          }
        });
        
        calendarDays.appendChild(dayElement);
      }
    }
    
    function updateWeekView() {
      const weekDaysContainer = document.getElementById('weekDays');
      weekDaysContainer.innerHTML = '';
      
      // Obtenir le premier jour de la semaine courante (lundi)
      const firstDayOfWeek = getMondayOfWeek(currentYear, currentWeek);
      
      // Mettre à jour le titre de la semaine
      const lastDayOfWeek = new Date(firstDayOfWeek);
      lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);
      
      const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
      const weekTitle = `Semaine du ${firstDayOfWeek.getDate()} ${monthNames[firstDayOfWeek.getMonth()]} au ${lastDayOfWeek.getDate()} ${monthNames[lastDayOfWeek.getMonth()]} ${lastDayOfWeek.getFullYear()}`;
      document.getElementById('weekTitle').textContent = weekTitle;
      
      // Aujourd'hui
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Générer les jours de la semaine
      for (let i = 0; i < 7; i++) {
        const dayDate = new Date(firstDayOfWeek);
        dayDate.setDate(firstDayOfWeek.getDate() + i);
        
        const dayElement = document.createElement('div');
        dayElement.className = 'week-day';
        
        // Vérifier si c'est aujourd'hui
        if (dayDate.toDateString() === today.toDateString()) {
          dayElement.classList.add('week-day-today');
        }
        
        // En-tête du jour
        const dayHeader = document.createElement('div');
        dayHeader.className = 'week-day-header';
        
        const dayName = document.createElement('span');
        dayName.className = 'week-day-name';
        dayName.textContent = dayDate.toLocaleDateString('fr-FR', { weekday: 'long' });
        
        const dayDateText = document.createElement('span');
        dayDateText.className = 'week-day-date';
        dayDateText.textContent = dayDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        
        dayHeader.appendChild(dayName);
        dayHeader.appendChild(dayDateText);
        dayElement.appendChild(dayHeader);
        
        // Événements du jour
        const dateKey = formatDateKey(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate());
        if (events[dateKey]) {
          // Filtrer selon le filtre actif
          const filteredEvents = filterEvents(events[dateKey]);
          
          filteredEvents.forEach(event => {
            const eventElement = document.createElement('div');
            eventElement.className = `event-item ${event.type}`;
            
            const eventTime = event.time ? new Date(`${event.date}T${event.time}`) : null;
            const endTime = eventTime ? new Date(eventTime.getTime() + (event.duration || 60) * 60 * 1000) : null;
            
            const timeText = eventTime ? 
              `${eventTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })} - ${endTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}` : 
              'Toute la journée';
            
            eventElement.innerHTML = `
              <div class="event-item-header">
                <h4 class="event-item-title">${event.title}</h4>
                <div class="event-item-date">${timeText}</div>
              </div>
              ${event.description ? `<div class="event-item-description">${event.description}</div>` : ''}
              <div class="event-item-footer">
                ${event.location ? `<div class="event-item-location"><i class="bi bi-geo-alt"></i> ${event.location}</div>` : ''}
                ${event.participants?.length > 0 ? `<div class="event-item-participants"><i class="bi bi-people"></i> ${event.participants.length} participant${event.participants.length !== 1 ? 's' : ''}</div>` : ''}
              </div>
            `;
            
            eventElement.addEventListener('click', function() {
              viewEvent(event.id);
            });
            
            dayElement.appendChild(eventElement);
          });
        } else {
          const noEvents = document.createElement('div');
          noEvents.className = 'no-events';
          noEvents.innerHTML = '<i class="bi bi-calendar-x"></i><p>Aucun événement</p>';
          dayElement.appendChild(noEvents);
        }
        
        weekDaysContainer.appendChild(dayElement);
      }
    }
    
    function updateDayView() {
      const dayEventsContainer = document.getElementById('dayEvents');
      dayEventsContainer.innerHTML = '';
      
      const dayDate = new Date(currentDay);
      dayDate.setHours(0, 0, 0, 0);
      
      // Mettre à jour le titre du jour
      const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
      const dayTitle = `${dayDate.toLocaleDateString('fr-FR', { weekday: 'long' })} ${dayDate.getDate()} ${monthNames[dayDate.getMonth()]} ${dayDate.getFullYear()}`;
      document.getElementById('dayTitle').textContent = dayTitle;
      
      // Vérifier si c'est aujourd'hui
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const isToday = dayDate.getTime() === today.getTime();
      
      // Événements du jour
      const dateKey = formatDateKey(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate());
      
      if (events[dateKey]) {
        // Filtrer selon le filtre actif
        const filteredEvents = filterEvents(events[dateKey]);
        
        // Trier par heure
        filteredEvents.sort((a, b) => {
          const timeA = a.time || '00:00';
          const timeB = b.time || '00:00';
          return timeA.localeCompare(timeB);
        });
        
        // Créer des créneaux horaires
        const timeSlots = {};
        
        filteredEvents.forEach(event => {
          const time = event.time || '00:00';
          const hour = time.split(':')[0];
          
          if (!timeSlots[hour]) {
            timeSlots[hour] = [];
          }
          
          timeSlots[hour].push(event);
        });
        
        // Afficher les événements par créneau horaire
        Object.entries(timeSlots).forEach(([hour, hourEvents]) => {
          const timeSlotElement = document.createElement('div');
          timeSlotElement.className = 'time-slot';
          
          const timeHeader = document.createElement('div');
          timeHeader.className = 'time-slot-hour';
          timeHeader.textContent = `${hour}h`;
          timeSlotElement.appendChild(timeHeader);
          
          const eventsContainer = document.createElement('div');
          eventsContainer.className = 'time-slot-events';
          
          hourEvents.forEach(event => {
            const eventTime = event.time ? new Date(`${event.date}T${event.time}`) : null;
            const endTime = eventTime ? new Date(eventTime.getTime() + (event.duration || 60) * 60 * 1000) : null;
            
            const timeText = eventTime ? 
              `${eventTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })} - ${endTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}` : 
              'Toute la journée';
            
            const eventElement = document.createElement('div');
            eventElement.className = `day-event ${event.type}`;
            
            eventElement.innerHTML = `
              <div class="event-item-header">
                <h4 class="event-item-title">${event.title}</h4>
                <div class="event-item-date">${timeText}</div>
              </div>
              ${event.description ? `<div class="event-item-description">${event.description}</div>` : ''}
              <div class="event-item-footer">
                ${event.location ? `<div class="event-item-location"><i class="bi bi-geo-alt"></i> ${event.location}</div>` : ''}
                ${event.participants?.length > 0 ? `<div class="event-item-participants"><i class="bi bi-people"></i> ${event.participants.length} participant${event.participants.length !== 1 ? 's' : ''}</div>` : ''}
              </div>
            `;
            
            eventElement.addEventListener('click', function() {
              viewEvent(event.id);
            });
            
            eventsContainer.appendChild(eventElement);
          });
          
          timeSlotElement.appendChild(eventsContainer);
          dayEventsContainer.appendChild(timeSlotElement);
        });
      } else {
        const noEvents = document.createElement('div');
        noEvents.className = 'no-events';
        noEvents.innerHTML = '<i class="bi bi-calendar-x"></i><p>Aucun événement ce jour</p>';
        dayEventsContainer.appendChild(noEvents);
      }
      
      // Bouton pour ajouter un événement
      const addEventBtn = document.createElement('button');
      addEventBtn.className = 'btn btn-primary w-100 mt-3';
      addEventBtn.innerHTML = '<i class="bi bi-plus-lg"></i> Ajouter un événement';
      addEventBtn.addEventListener('click', function() {
        openAddEventModal(dayDate);
      });
      
      dayEventsContainer.appendChild(addEventBtn);
    }
    
    function updateListView() {
      const eventsListContainer = document.getElementById('eventsListView');
      eventsListContainer.innerHTML = '';
      
      // Convertir tous les événements en un tableau
      let allEvents = [];
      Object.entries(events).forEach(([date, dateEvents]) => {
        dateEvents.forEach(event => {
          allEvents.push({ ...event, date });
        });
      });
      
      // Trier par date
      allEvents.sort((a, b) => {
        const dateA = new Date(`${a.date}T${a.time || '00:00'}`);
        const dateB = new Date(`${b.date}T${b.time || '00:00'}`);
        return dateA - dateB;
      });
      
      // Filtrer selon le filtre actif
      let filteredEvents = filterEvents(allEvents);
      
      if (filteredEvents.length === 0) {
        eventsListContainer.innerHTML = `
          <div class="no-events">
            <i class="bi bi-calendar-x"></i>
            <p>Aucun événement trouvé</p>
          </div>
        `;
        return;
      }
      
      // Grouper par mois
      const eventsByMonth = {};
      filteredEvents.forEach(event => {
        const eventDate = new Date(`${event.date}T${event.time || '00:00'}`);
        const monthKey = `${eventDate.getFullYear()}-${eventDate.getMonth()}`;
        
        if (!eventsByMonth[monthKey]) {
          eventsByMonth[monthKey] = [];
        }
        
        eventsByMonth[monthKey].push(event);
      });
      
      // Afficher par mois
      Object.entries(eventsByMonth).forEach(([monthKey, monthEvents]) => {
        const [year, month] = monthKey.split('-');
        const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
        
        const monthHeader = document.createElement('h4');
        monthHeader.className = 'mt-4 mb-3';
        monthHeader.textContent = `${monthNames[parseInt(month)]} ${year}`;
        eventsListContainer.appendChild(monthHeader);
        
        monthEvents.forEach(event => {
          const eventDate = new Date(`${event.date}T${event.time || '00:00'}`);
          const formattedDate = eventDate.toLocaleDateString('fr-FR', {
            weekday: 'short',
            day: 'numeric',
            month: 'short',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          const eventElement = document.createElement('div');
          eventElement.className = `event-item ${event.type}`;
          eventElement.innerHTML = `
            <div class="event-item-header">
              <h4 class="event-item-title">${event.title}</h4>
              <div class="event-item-date">${formattedDate}</div>
            </div>
            ${event.description ? `<div class="event-item-description">${event.description}</div>` : ''}
            <div class="event-item-footer">
              ${event.location ? `<div class="event-item-location"><i class="bi bi-geo-alt"></i> ${event.location}</div>` : ''}
              ${event.participants?.length > 0 ? `<div class="event-item-participants"><i class="bi bi-people"></i> ${event.participants.length} participant${event.participants.length !== 1 ? 's' : ''}</div>` : ''}
            </div>
          `;
          
          eventElement.addEventListener('click', function() {
            viewEvent(event.id);
          });
          
          eventsListContainer.appendChild(eventElement);
        });
      });
    }
    
    function filterEvents(eventsList) {
      if (currentFilter === 'all') return eventsList;
      
      return eventsList.filter(event => {
        if (currentFilter === 'urgent' && event.type === 'urgent') return true;
        if (currentFilter === 'important' && event.type === 'important') return true;
        if (currentFilter === 'meeting' && event.type === 'meeting') return true;
        if (currentFilter === 'training' && event.type === 'training') return true;
        if (currentFilter === 'amicale' && event.type === 'amicale') return true;
        if (currentFilter === 'defile' && event.type === 'defile') return true;
        if (currentFilter === 'sport' && event.type === 'sport') return true;
        return false;
      });
    }
    
    function openAddEventModal(dayDate) {
      currentEditingEventId = null;
      document.getElementById('modalTitle').textContent = 'Nouvel Événement';
      document.getElementById('eventForm').reset();
      document.getElementById('participantsList').innerHTML = '';
      document.getElementById('recurringOptions').style.display = 'none';
      participants = [];
      
      // Définir la date par défaut
      const dateStr = formatDateKey(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate());
      document.getElementById('eventDate').value = dateStr;
      
      // Définir l'heure par défaut (prochaine heure pleine)
      const now = new Date();
      const nextHour = new Date(now.getTime() + 60 * 60 * 1000);
      document.getElementById('eventTime').value = `${String(nextHour.getHours()).padStart(2, '0')}:00`;
      
      const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
      eventModal.show();
    }
    
    function setupEventListeners() {
      // Navigation du calendrier (vue mois)
      document.getElementById('prevYear').addEventListener('click', function() {
        currentYear--;
        updateCalendar();
      });
      
      document.getElementById('prevMonth').addEventListener('click', function() {
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
        updateCalendar();
      });
      
      document.getElementById('nextMonth').addEventListener('click', function() {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        updateCalendar();
      });
      
      document.getElementById('nextYear').addEventListener('click', function() {
        currentYear++;
        updateCalendar();
      });
      
      document.getElementById('today').addEventListener('click', function() {
        const today = new Date();
        currentMonth = today.getMonth();
        currentYear = today.getFullYear();
        updateCalendar();
      });
      
      // Navigation du calendrier (vue semaine)
      document.getElementById('prevWeek').addEventListener('click', function() {
        currentWeek--;
        if (currentWeek < 1) {
          currentWeek = 52;
          currentYear--;
        }
        updateCalendar();
      });
      
      document.getElementById('nextWeek').addEventListener('click', function() {
        currentWeek++;
        if (currentWeek > 52) {
          currentWeek = 1;
          currentYear++;
        }
        updateCalendar();
      });
      
      document.getElementById('todayWeek').addEventListener('click', function() {
        const today = new Date();
        currentYear = today.getFullYear();
        currentWeek = getWeekNumber(today);
        updateCalendar();
      });
      
      // Navigation du calendrier (vue jour)
      document.getElementById('prevDay').addEventListener('click', function() {
        currentDay = new Date(currentDay);
        currentDay.setDate(currentDay.getDate() - 1);
        updateCalendar();
      });
      
      document.getElementById('nextDay').addEventListener('click', function() {
        currentDay = new Date(currentDay);
        currentDay.setDate(currentDay.getDate() + 1);
        updateCalendar();
      });
      
      document.getElementById('todayDay').addEventListener('click', function() {
        currentDay = new Date();
        updateCalendar();
      });
      
      // Navigation du calendrier (vue liste)
      document.getElementById('listToday').addEventListener('click', function() {
        updateListView();
      });
      
      // Bouton Ajouter un événement
      document.getElementById('addEventBtn').addEventListener('click', function() {
        openAddEventModal(new Date());
      });
      
      // Navigation mobile
      document.getElementById('mobilePrevBtn').addEventListener('click', function() {
        if (currentView === 'month') document.getElementById('prevMonth').click();
        else if (currentView === 'week') document.getElementById('prevWeek').click();
        else if (currentView === 'day') document.getElementById('prevDay').click();
      });
      
      document.getElementById('mobileNextBtn').addEventListener('click', function() {
        if (currentView === 'month') document.getElementById('nextMonth').click();
        else if (currentView === 'week') document.getElementById('nextWeek').click();
        else if (currentView === 'day') document.getElementById('nextDay').click();
      });
      
      document.getElementById('mobileTodayBtn').addEventListener('click', function() {
        if (currentView === 'month') document.getElementById('today').click();
        else if (currentView === 'week') document.getElementById('todayWeek').click();
        else if (currentView === 'day') document.getElementById('todayDay').click();
      });
      
      // Navigation mobile via la barre du bas
      document.getElementById('mobileNavMonth').addEventListener('click', function(e) {
        e.preventDefault();
        switchView('month');
      });
      
      document.getElementById('mobileNavWeek').addEventListener('click', function(e) {
        e.preventDefault();
        switchView('week');
      });
      
      document.getElementById('mobileNavDay').addEventListener('click', function(e) {
        e.preventDefault();
        switchView('day');
      });
      
      document.getElementById('mobileNavList').addEventListener('click', function(e) {
        e.preventDefault();
        switchView('list');
      });
      
      document.getElementById('mobileNavAdd').addEventListener('click', function(e) {
        e.preventDefault();
        openAddEventModal(new Date());
      });
      
      // Ajouter un participant
      document.getElementById('addParticipant').addEventListener('click', function() {
        const name = document.getElementById('participantName').value.trim();
        if (name) {
          participants.push(name);
          updateParticipantsDisplay();
          document.getElementById('participantName').value = '';
          document.getElementById('participantName').focus();
        }
      });
      
      // Entrée pour ajouter un participant
      document.getElementById('participantName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('addParticipant').click();
        }
      });
      
      // Événement récurrent
      document.getElementById('eventRecurring').addEventListener('change', function() {
        document.getElementById('recurringOptions').style.display = this.checked ? 'block' : 'none';
      });
      
      // Sauvegarder un événement
      document.getElementById('saveEventBtn').addEventListener('click', async function() {
        const title = document.getElementById('eventTitle').value.trim();
        const date = document.getElementById('eventDate').value;
        const time = document.getElementById('eventTime').value;
        const description = document.getElementById('eventDescription').value.trim();
        const location = document.getElementById('eventLocation').value.trim();
        const type = document.getElementById('eventType').value;
        const duration = parseInt(document.getElementById('eventDuration').value);
        const isRecurring = document.getElementById('eventRecurring').checked;
        
        if (!title || !date || !time) {
          showToast('Veuillez remplir les champs obligatoires', 'danger');
          return;
        }
        
        const eventData = {
          title,
          date,
          time,
          description,
          location,
          type,
          duration,
          participants: [...participants],
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        if (isRecurring) {
          eventData.recurrence = {
            frequency: document.getElementById('recurrenceFrequency').value,
            interval: parseInt(document.getElementById('recurrenceInterval').value),
            count: parseInt(document.getElementById('recurrenceCount').value) || null
          };
        }
        
        try {
          if (currentEditingEventId) {
            await database.ref('events/' + currentEditingEventId).update(eventData);
            showToast('Événement mis à jour avec succès', 'success');
          } else {
            await database.ref('events').push().set(eventData);
            showToast('Événement créé avec succès', 'success');
          }
          
          const eventModal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
          eventModal.hide();
        } catch (error) {
          showToast("Erreur: " + error.message, 'danger');
          console.error("Erreur Firebase:", error);
        }
      });
      
      // Bouton Modifier dans le modal de visualisation
      document.getElementById('editEventBtn').addEventListener('click', function() {
        const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewEventModal'));
        viewModal.hide();
        
        editEvent(currentEditingEventId);
      });
      
      // Bouton Supprimer dans le modal de visualisation
      document.getElementById('deleteEventBtn').addEventListener('click', async function() {
        if (confirm("Voulez-vous vraiment supprimer cet événement ? Cette action est irréversible.")) {
          try {
            await database.ref('events/' + currentEditingEventId).remove();
            showToast('Événement supprimé', 'success');
            
            const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewEventModal'));
            viewModal.hide();
          } catch (error) {
            showToast("Erreur: " + error.message, 'danger');
          }
        }
      });
      
      // Filtres d'événements (version desktop)
      document.querySelectorAll('#eventsFilters button').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('#eventsFilters button').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentFilter = this.getAttribute('data-filter');
          updateCalendar();
          updateEventsList();
        });
      });
      
      // Filtre d'événements (version mobile)
      document.getElementById('mobileFilter').addEventListener('change', function() {
        currentFilter = this.value;
        updateCalendar();
        updateEventsList();
      });
      
      // Recherche d'événements
      document.getElementById('eventsSearch').addEventListener('input', function() {
        updateEventsList();
      });
      
      // Changer de vue
      document.getElementById('monthViewBtn').addEventListener('click', function() {
        switchView('month');
      });
      
      document.getElementById('weekViewBtn').addEventListener('click', function() {
        switchView('week');
      });
      
      document.getElementById('dayViewBtn').addEventListener('click', function() {
        switchView('day');
      });
      
      document.getElementById('listViewBtn').addEventListener('click', function() {
        switchView('list');
      });
      
      // Toggle events visibility
      document.getElementById('toggleEventsBtn').addEventListener('click', function() {
        showEvents = !showEvents;
        document.getElementById('eventsList').style.display = showEvents ? 'block' : 'none';
        this.innerHTML = showEvents ? 
          '<i class="bi bi-chevron-up"></i> Masquer les événements' : 
          '<i class="bi bi-chevron-down"></i> Afficher les événements';
      });
      
      // Quick join form toggle
      document.getElementById('quickJoinBtn').addEventListener('click', async function() {
        const eventId = document.getElementById('quickJoinEventId').value.trim();
        const name = document.getElementById('quickJoinName').value.trim();
        
        if (!eventId || !name) {
          showToast('Veuillez remplir tous les champs', 'danger');
          return;
        }
        
        try {
          const snapshot = await database.ref('events/' + eventId).once('value');
          const event = snapshot.val();
          
          if (!event) {
            showToast('Événement non trouvé', 'danger');
            return;
          }
          
          // Vérifier si le participant existe déjà
          const participants = event.participants || [];
          if (participants.includes(name)) {
            showToast('Vous êtes déjà inscrit à cet événement', 'warning');
            return;
          }
          
          // Ajouter le participant
          await database.ref('events/' + eventId + '/participants').push(name);
          
          showToast('Inscription réussie', 'success');
          document.getElementById('quickJoinEventId').value = '';
          document.getElementById('quickJoinName').value = '';
          
          // Actualiser l'affichage
          loadEvents();
        } catch (error) {
          showToast("Erreur: " + error.message, 'danger');
        }
      });
    }
    
    function switchView(view) {
      if (currentView !== view) {
        currentView = view;
        updateViewButtons();
        updateMobileNav();
        updateCalendar();
      }
    }
    
    function updateViewButtons() {
      // Masquer toutes les vues
      document.getElementById('monthView').style.display = 'none';
      document.getElementById('weekView').style.display = 'none';
      document.getElementById('dayView').style.display = 'none';
      document.getElementById('listView').style.display = 'none';
      
      // Afficher la vue active
      document.getElementById(`${currentView}View`).style.display = 'block';
      
      // Mettre à jour les boutons
      document.getElementById('monthViewBtn').classList.remove('active');
      document.getElementById('weekViewBtn').classList.remove('active');
      document.getElementById('dayViewBtn').classList.remove('active');
      document.getElementById('listViewBtn').classList.remove('active');
      
      document.getElementById(`${currentView}ViewBtn`).classList.add('active');
    }
    
    function updateParticipantsDisplay() {
      const container = document.getElementById('participantsList');
      container.innerHTML = participants.map(p => `
        <span class="participant-badge">
          ${p}
          <button type="button" class="btn-close" data-participant="${p}" aria-label="Supprimer"></button>
        </span>
      `).join('');
      
      document.querySelectorAll('[data-participant]').forEach(btn => {
        btn.addEventListener('click', function() {
          const participant = this.getAttribute('data-participant');
          participants = participants.filter(p => p !== participant);
          updateParticipantsDisplay();
        });
      });
    }
    
    async function loadEvents() {
      try {
        const snapshot = await database.ref('events').once('value');
        const eventsData = snapshot.val() || {};
        
        // Convertir en tableau et organiser par date
        events = {};
        Object.entries(eventsData).forEach(([id, event]) => {
          const dateKey = event.date; // Format YYYY-MM-DD
          
          if (!events[dateKey]) {
            events[dateKey] = [];
          }
          
          events[dateKey].push({ id, ...event });
        });
        
        updateCalendar();
        updateEventsList();
      } catch (error) {
        showToast("Erreur de chargement: " + error.message, 'danger');
        console.error("Erreur Firebase:", error);
      }
    }
    
    function updateEventsList() {
      const container = document.getElementById('eventsList');
      container.innerHTML = '';
      
      // Convertir tous les événements en un tableau
      let allEvents = [];
      Object.entries(events).forEach(([date, dateEvents]) => {
        dateEvents.forEach(event => {
          allEvents.push({ ...event, date });
        });
      });
      
      // Trier par date
      allEvents.sort((a, b) => {
        const dateA = new Date(`${a.date}T${a.time || '00:00'}`);
        const dateB = new Date(`${b.date}T${b.time || '00:00'}`);
        return dateA - dateB;
      });
      
      // Filtrer selon le filtre actif
      let filteredEvents = filterEvents(allEvents);
      
      // Filtrer selon la recherche
      const searchTerm = document.getElementById('eventsSearch').value.toLowerCase();
      if (searchTerm) {
        filteredEvents = filteredEvents.filter(event => 
          event.title.toLowerCase().includes(searchTerm) || 
          (event.description && event.description.toLowerCase().includes(searchTerm)) ||
          (event.location && event.location.toLowerCase().includes(searchTerm)) ||
          (event.participants && event.participants.some(p => p.toLowerCase().includes(searchTerm)))
        );
      }
      
      // Afficher les 10 prochains événements
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const upcomingEvents = filteredEvents.filter(event => {
        const eventDate = new Date(`${event.date}T${event.time || '00:00'}`);
        return eventDate >= today;
      }).slice(0, 10);
      
      if (upcomingEvents.length === 0) {
        container.innerHTML = `
          <div class="no-events">
            <i class="bi bi-calendar-x"></i>
            <p>Aucun événement trouvé</p>
          </div>
        `;
        return;
      }
      
      upcomingEvents.forEach(event => {
        const eventDate = new Date(`${event.date}T${event.time || '00:00'}`);
        const formattedDate = eventDate.toLocaleDateString('fr-FR', {
          weekday: 'short',
          day: 'numeric',
          month: 'short',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const eventElement = document.createElement('div');
        eventElement.className = `event-item ${event.type}`;
        eventElement.innerHTML = `
          <div class="event-item-header">
            <h4 class="event-item-title">${event.title}</h4>
            <div class="event-item-date">${formattedDate}</div>
          </div>
          ${event.description ? `<div class="event-item-description">${event.description}</div>` : ''}
          <div class="event-item-footer">
            ${event.location ? `<div class="event-item-location"><i class="bi bi-geo-alt"></i> ${event.location}</div>` : ''}
            ${event.participants?.length > 0 ? `<div class="event-item-participants"><i class="bi bi-people"></i> ${event.participants.length} participant${event.participants.length !== 1 ? 's' : ''}</div>` : ''}
          </div>
        `;
        
        eventElement.addEventListener('click', function() {
          viewEvent(event.id);
        });
        
        container.appendChild(eventElement);
      });
    }
    
    async function viewEvent(eventId) {
      try {
        const snapshot = await database.ref('events/' + eventId).once('value');
        const event = snapshot.val();
        
        if (!event) {
          showToast("Événement non trouvé", 'danger');
          return;
        }
        
        currentEditingEventId = eventId;
        
        const eventDate = new Date(`${event.date}T${event.time || '00:00'}`);
        const endDate = new Date(eventDate.getTime() + (event.duration || 60) * 60 * 1000);
        
        const formattedDate = eventDate.toLocaleDateString('fr-FR', {
          weekday: 'long',
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
        
        const formattedTime = eventDate.toLocaleTimeString('fr-FR', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const formattedEndTime = endDate.toLocaleTimeString('fr-FR', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        // Définir le badge de type
        const typeBadge = document.getElementById('viewEventTypeBadge');
        typeBadge.textContent = '';
        typeBadge.className = 'event-type-badge';
        
        if (event.type === 'urgent') {
          typeBadge.textContent = 'URGENT';
          typeBadge.style.backgroundColor = 'var(--danger)';
          typeBadge.style.color = 'white';
        } else if (event.type === 'important') {
          typeBadge.textContent = 'IMPORTANT';
          typeBadge.style.backgroundColor = 'var(--warning)';
          typeBadge.style.color = 'var(--dark)';
        } else if (event.type === 'meeting') {
          typeBadge.textContent = 'RÉUNION';
          typeBadge.style.backgroundColor = 'var(--success)';
          typeBadge.style.color = 'white';
        } else if (event.type === 'training') {
          typeBadge.textContent = 'FORMATION';
          typeBadge.style.backgroundColor = 'var(--info)';
          typeBadge.style.color = 'white';
        } else if (event.type === 'amicale') {
          typeBadge.textContent = 'AMICALE';
          typeBadge.style.backgroundColor = 'var(--amicale)';
          typeBadge.style.color = 'white';
        } else if (event.type === 'defile') {
          typeBadge.textContent = 'DÉFILÉ';
          typeBadge.style.backgroundColor = 'var(--defile)';
          typeBadge.style.color = 'white';
        } else if (event.type === 'sport') {
          typeBadge.textContent = 'SPORT';
          typeBadge.style.backgroundColor = 'var(--sport)';
          typeBadge.style.color = 'white';
        }
        
        // Participants
        let participantsHtml = '';
        if (event.participants?.length) {
          participantsHtml = `
            <div class="event-detail-item">
              <div class="event-detail-label">
                <i class="bi bi-people"></i> Participants (${event.participants.length})
              </div>
              <div class="participants-grid">
                ${event.participants.map(p => `
                  <div class="participant-card">
                    <div class="participant-avatar">${getInitials(p)}</div>
                    <div class="participant-name">${p}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
        
        document.getElementById('viewEventTitle').textContent = event.title;
        document.getElementById('viewEventBody').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <div class="event-detail-item">
                <div class="event-detail-label">
                  <i class="bi bi-calendar-date"></i> Date
                </div>
                <div class="event-detail-value">${formattedDate}</div>
              </div>
              
              <div class="event-detail-item">
                <div class="event-detail-label">
                  <i class="bi bi-clock"></i> Heure
                </div>
                <div class="event-detail-value">${formattedTime} - ${formattedEndTime}</div>
              </div>
              
              ${event.location ? `
              <div class="event-detail-item">
                <div class="event-detail-label">
                  <i class="bi bi-geo-alt"></i> Lieu
                </div>
                <div class="event-detail-value">${event.location}</div>
              </div>` : ''}
            </div>
            
            <div class="col-md-6">
              ${event.recurrence ? `
              <div class="event-detail-item">
                <div class="event-detail-label">
                  <i class="bi bi-arrow-repeat"></i> Récurrence
                </div>
                <div class="event-detail-value">
                  ${formatRecurrence(event.recurrence)}
                </div>
              </div>` : ''}
              
              <div class="event-detail-item">
                <div class="event-detail-label">
                  <i class="bi bi-calendar-event"></i> Créé le
                </div>
                <div class="event-detail-value">
                  ${new Date(event.createdAt).toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}
                </div>
              </div>
              
              <div class="event-detail-item">
                <div class="event-detail-label">
                  <i class="bi bi-pencil"></i> Modifié le
                </div>
                <div class="event-detail-value">
                  ${new Date(event.updatedAt).toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}
                </div>
              </div>
            </div>
          </div>
          
          ${event.description ? `
          <div class="event-detail-item">
            <div class="event-detail-label">
              <i class="bi bi-text-paragraph"></i> Description
            </div>
            <div class="event-detail-value">${event.description}</div>
          </div>` : ''}
          
          ${participantsHtml}
          
          <div class="event-detail-item">
            <div class="event-detail-label">
              <i class="bi bi-link-45deg"></i> ID de l'événement
            </div>
            <div class="event-detail-value">
              <code>${eventId}</code> - Copiez cet ID pour vous inscrire rapidement
            </div>
          </div>
        `;
        
        const viewModal = new bootstrap.Modal(document.getElementById('viewEventModal'));
        viewModal.show();
      } catch (error) {
        showToast("Erreur: " + error.message, 'danger');
      }
    }
    
    function getInitials(name) {
      return name.split(' ').map(part => part[0]).join('').toUpperCase();
    }
    
    function formatRecurrence(recurrence) {
      let text = '';
      
      if (recurrence.frequency === 'weekly') {
        text = `Toutes les ${recurrence.interval} semaine${recurrence.interval > 1 ? 's' : ''}`;
      } else if (recurrence.frequency === 'monthly') {
        text = `Tous les ${recurrence.interval} mois`;
      } else if (recurrence.frequency === 'yearly') {
        text = `Tous les ${recurrence.interval} an${recurrence.interval > 1 ? 's' : ''}`;
      }
      
      if (recurrence.count) {
        text += ` pour ${recurrence.count} occurrence${recurrence.count > 1 ? 's' : ''}`;
      } else {
        text += ' (indéfiniment)';
      }
      
      return text;
    }
    
    async function editEvent(eventId) {
      try {
        const snapshot = await database.ref('events/' + eventId).once('value');
        const event = snapshot.val();
        
        if (!event) {
          showToast("Événement non trouvé", 'danger');
          return;
        }
        
        currentEditingEventId = eventId;
        document.getElementById('modalTitle').textContent = 'Modifier Événement';
        
        // Remplir le formulaire
        document.getElementById('eventTitle').value = event.title;
        document.getElementById('eventDate').value = event.date;
        document.getElementById('eventTime').value = event.time || '';
        document.getElementById('eventDescription').value = event.description || '';
        document.getElementById('eventLocation').value = event.location || '';
        document.getElementById('eventType').value = event.type || 'normal';
        document.getElementById('eventDuration').value = event.duration || '60';
        
        // Participants
        participants = event.participants ? [...event.participants] : [];
        updateParticipantsDisplay();
        
        // Récurrence
        if (event.recurrence) {
          document.getElementById('eventRecurring').checked = true;
          document.getElementById('recurringOptions').style.display = 'block';
          document.getElementById('recurrenceFrequency').value = event.recurrence.frequency;
          document.getElementById('recurrenceInterval').value = event.recurrence.interval;
          document.getElementById('recurrenceCount').value = event.recurrence.count || '';
        } else {
          document.getElementById('eventRecurring').checked = false;
          document.getElementById('recurringOptions').style.display = 'none';
        }
        
        const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
        eventModal.show();
      } catch (error) {
        showToast("Erreur: " + error.message, 'danger');
      }
    }
    
    function formatDateKey(year, month, day) {
      return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    }
    
    function showToast(message, type) {
      const toastContainer = document.getElementById('toastContainer');
      const toastId = 'toast-' + Date.now();
      
      const toast = document.createElement('div');
      toast.id = toastId;
      toast.className = `toast show align-items-center text-white bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      // Supprimer après 5 secondes
      setTimeout(() => {
        const toastElement = document.getElementById(toastId);
        if (toastElement) {
          toastElement.classList.remove('show');
          setTimeout(() => toastElement.remove(), 300);
        }
      }, 5000);
    }
    
    // Fonction pour obtenir le numéro de semaine
    function getWeekNumber(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
      const week1 = new Date(d.getFullYear(), 0, 4);
      return 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
    }
    
    // Fonction pour obtenir le lundi d'une semaine donnée
    function getMondayOfWeek(year, week) {
      const date = new Date(year, 0, 1 + (week - 1) * 7);
      const dayOfWeek = date.getDay();
      const monday = new Date(date);
      monday.setDate(date.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
      return monday;
    }
    
    // Écoute des changements en temps réel
    database.ref('events').on('value', (snapshot) => {
      const eventsData = snapshot.val() || {};
      
      // Convertir en tableau et organiser par date
      events = {};
      Object.entries(eventsData).forEach(([id, event]) => {
        const dateKey = event.date; // Format YYYY-MM-DD
        
        if (!events[dateKey]) {
          events[dateKey] = [];
        }
        
        events[dateKey].push({ id, ...event });
      });
      
      updateCalendar();
      updateEventsList();
    });
  </script>
</body>
</html>