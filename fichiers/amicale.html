<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amicale des Pompiers</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* Couleurs */
      --primary: #d32f2f;
      --primary-light: #ff6659;
      --primary-dark: #9a0007;
      --secondary: #0288d1;
      --success: #388e3c;
      --info: #1976d2;
      --warning: #ffa000;
      --danger: #d32f2f;
      --light: #f5f5f5;
      --dark: #212121;
      --gray: #757575;
      --white: #ffffff;
      
      /* Variables de design */
      --border-radius: 8px;
      --box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      --transition: all 0.2s ease;
    }
    
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #f5f5f5;
      color: var(--dark);
      line-height: 1.6;
    }
    
    .header-image {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: var(--border-radius);
      margin-bottom: 1.5rem;
      box-shadow: var(--box-shadow);
    }
    
    .card-idea {
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 1.5rem;
      transition: var(--transition);
      border-left: 4px solid var(--primary);
    }
    
    .card-idea:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .vote-count {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    .vote-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 1.2rem;
    }
    
    .comment-section {
      background-color: rgba(0,0,0,0.03);
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-top: 1rem;
    }
    
    .comment {
      background-color: white;
      border-radius: var(--border-radius);
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      box-shadow: var(--box-shadow);
    }
    
    .comment-author {
      font-weight: 600;
      color: var(--primary);
    }
    
    .comment-date {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .idea-form {
      background-color: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow);
      margin-bottom: 2rem;
    }
    
    .nav-tabs .nav-link.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
      font-weight: 600;
    }
    
    .nav-tabs .nav-link {
      color: var(--gray);
      font-weight: 500;
    }
    
    .badge-primary {
      background-color: var(--primary);
    }
    
    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
      border-color: var(--primary-dark);
    }
    
    .btn-outline-primary {
      color: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-outline-primary:hover {
      background-color: var(--primary);
      color: white;
    }
    
    .toast-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1100;
    }
    
    .toast {
      border-radius: var(--border-radius);
      border: none;
      box-shadow: var(--box-shadow);
    }
    
    .image-upload-container {
      position: relative;
      margin-bottom: 1.5rem;
    }
    
    .image-upload-btn {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      background-color: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .image-upload-btn:hover {
      background-color: var(--primary);
    }
    
    .image-upload-input {
      display: none;
    }
    
    .idea-image {
      max-width: 100%;
      max-height: 200px;
      border-radius: var(--border-radius);
      margin-top: 1rem;
      cursor: pointer;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 0.5rem;
      border: 2px solid var(--primary);
    }
    
    .user-badge {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .user-name {
      font-weight: 600;
    }
    
    .user-role {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .admin-badge {
      background-color: var(--warning);
      color: var(--dark);
      font-size: 0.7rem;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      margin-left: 0.5rem;
    }
    
    .status-badge {
      font-size: 0.8rem;
      padding: 0.3rem 0.6rem;
      border-radius: 50px;
    }
    
    .status-planned {
      background-color: var(--info);
      color: white;
    }
    
    .status-inprogress {
      background-color: var(--warning);
      color: var(--dark);
    }
    
    .status-completed {
      background-color: var(--success);
      color: white;
    }
    
    .status-rejected {
      background-color: var(--danger);
      color: white;
    }
    
    .event-card {
      border-left: 4px solid var(--secondary);
    }
    
    @media (max-width: 768px) {
      .header-image {
        height: 200px;
      }
      
      .vote-section {
        flex-direction: row !important;
        align-items: center;
        margin-top: 1rem;
      }
      
      .vote-count {
        margin: 0 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- En-tête avec image -->
    <div class="image-upload-container">
      <img id="headerImage" src="https://via.placeholder.com/1200x300?text=Amicale+des+Pompiers" class="header-image" alt="Image d'entête de l'amicale">
      <label for="imageUpload" class="image-upload-btn" title="Changer l'image d'entête">
        <i class="bi bi-camera-fill"></i>
      </label>
      <input type="file" id="imageUpload" class="image-upload-input" accept="image/*">
    </div>
    
    <!-- Navigation -->
    <ul class="nav nav-tabs mb-4" id="amicaleTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="ideas-tab" data-bs-toggle="tab" data-bs-target="#ideas" type="button" role="tab">
          <i class="bi bi-lightbulb"></i> Boîte à idées
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="top-tab" data-bs-toggle="tab" data-bs-target="#top" type="button" role="tab">
          <i class="bi bi-trophy"></i> Idées populaires
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button" role="tab">
          <i class="bi bi-calendar-event"></i> Événements
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">
          <i class="bi bi-plus-circle"></i> Proposer
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
          <i class="bi bi-person"></i> Profil
        </button>
      </li>
    </ul>
    
    <!-- Contenu des onglets -->
    <div class="tab-content" id="amicaleTabsContent">
      <!-- Onglet Boîte à idées -->
      <div class="tab-pane fade show active" id="ideas" role="tabpanel">
        <div class="row">
          <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4><i class="bi bi-lightbulb"></i> Toutes les idées</h4>
              <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-funnel"></i> Filtrer
                </button>
                <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                  <li><a class="dropdown-item filter-option active" href="#" data-filter="all">Toutes les idées</a></li>
                  <li><a class="dropdown-item filter-option" href="#" data-filter="planned">Planifiées</a></li>
                  <li><a class="dropdown-item filter-option" href="#" data-filter="inprogress">En cours</a></li>
                  <li><a class="dropdown-item filter-option" href="#" data-filter="completed">Réalisées</a></li>
                  <li><a class="dropdown-item filter-option" href="#" data-filter="rejected">Rejetées</a></li>
                </ul>
              </div>
            </div>
            <div id="ideasList">
              <!-- Les idées seront chargées ici -->
              <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Chargement...</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card mb-4">
              <div class="card-body">
                <h5 class="card-title"><i class="bi bi-info-circle"></i> Comment ça marche ?</h5>
                <p class="card-text">
                  <small>
                    Proposez vos idées pour améliorer la vie de l'amicale. Les autres membres peuvent voter pour les idées qu'ils préfèrent.
                    Les idées avec le plus de votes seront étudiées par le bureau de l'amicale.
                  </small>
                </p>
              </div>
            </div>
            
            <div class="card">
              <div class="card-body">
                <h5 class="card-title"><i class="bi bi-bar-chart"></i> Statistiques</h5>
                <div class="d-flex justify-content-between mb-2">
                  <span>Idées proposées</span>
                  <strong id="totalIdeas">0</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span>Votes totaux</span>
                  <strong id="totalVotes">0</strong>
                </div>
                <div class="d-flex justify-content-between">
                  <span>Commentaires</span>
                  <strong id="totalComments">0</strong>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Onglet Idées populaires -->
      <div class="tab-pane fade" id="top" role="tabpanel">
        <h4 class="mb-4"><i class="bi bi-trophy"></i> Idées les plus populaires</h4>
        <div id="topIdeasList">
          <!-- Les idées populaires seront chargées ici -->
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Onglet Événements -->
      <div class="tab-pane fade" id="events" role="tabpanel">
        <div class="row">
          <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4><i class="bi bi-calendar-event"></i> Prochains événements</h4>
              <button class="btn btn-primary" id="addEventBtn" style="display: none;">
                <i class="bi bi-plus"></i> Ajouter
              </button>
            </div>
            <div id="eventsList">
              <!-- Les événements seront chargés ici -->
              <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Chargement...</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title"><i class="bi bi-info-circle"></i> Événements à venir</h5>
                <div id="upcomingEvents">
                  <p class="text-muted">Chargement des événements...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Onglet Ajouter une idée/événement -->
      <div class="tab-pane fade" id="add" role="tabpanel">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <ul class="nav nav-pills mb-4" id="addTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="addIdea-tab" data-bs-toggle="pill" data-bs-target="#addIdea" type="button" role="tab">
                  <i class="bi bi-lightbulb"></i> Nouvelle idée
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="addEvent-tab" data-bs-toggle="pill" data-bs-target="#addEvent" type="button" role="tab" style="display: none;">
                  <i class="bi bi-calendar-plus"></i> Nouvel événement
                </button>
              </li>
            </ul>
            
            <div class="tab-content" id="addTabsContent">
              <div class="tab-pane fade show active" id="addIdea" role="tabpanel">
                <div class="idea-form">
                  <h4 class="mb-4"><i class="bi bi-lightbulb"></i> Proposer une nouvelle idée</h4>
                  <form id="ideaForm">
                    <div class="mb-3">
                      <label for="ideaTitle" class="form-label">Titre de l'idée</label>
                      <input type="text" class="form-control" id="ideaTitle" required>
                    </div>
                    <div class="mb-3">
                      <label for="ideaDescription" class="form-label">Description détaillée</label>
                      <textarea class="form-control" id="ideaDescription" rows="5" required></textarea>
                    </div>
                    <div class="mb-3">
                      <label for="ideaImage" class="form-label">Image (optionnelle)</label>
                      <input type="file" class="form-control" id="ideaImage" accept="image/*">
                      <small class="text-muted">Taille maximale : 1MB</small>
                    </div>
                    <div class="d-grid">
                      <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i> Soumettre l'idée
                      </button>
                    </div>
                  </form>
                </div>
              </div>
              
              <div class="tab-pane fade" id="addEvent" role="tabpanel">
                <div class="idea-form">
                  <h4 class="mb-4"><i class="bi bi-calendar-plus"></i> Créer un nouvel événement</h4>
                  <form id="eventForm">
                    <div class="mb-3">
                      <label for="eventTitle" class="form-label">Titre de l'événement</label>
                      <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    <div class="mb-3">
                      <label for="eventDescription" class="form-label">Description</label>
                      <textarea class="form-control" id="eventDescription" rows="3" required></textarea>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="eventDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="eventDate" required>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="eventTime" class="form-label">Heure</label>
                        <input type="time" class="form-control" id="eventTime" required>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="eventLocation" class="form-label">Lieu</label>
                      <input type="text" class="form-control" id="eventLocation" required>
                    </div>
                    <div class="mb-3">
                      <label for="eventImage" class="form-label">Image (optionnelle)</label>
                      <input type="file" class="form-control" id="eventImage" accept="image/*">
                      <small class="text-muted">Taille maximale : 1MB</small>
                    </div>
                    <div class="d-grid">
                      <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i> Créer l'événement
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Onglet Profil -->
      <div class="tab-pane fade" id="profile" role="tabpanel">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="idea-form">
              <h4 class="mb-4"><i class="bi bi-person"></i> Mon profil</h4>
              <form id="profileForm">
                <div class="mb-3 text-center">
                  <img id="userAvatar" src="https://via.placeholder.com/150" class="user-avatar mb-2" style="width: 100px; height: 100px;">
                  <input type="file" id="avatarUpload" class="d-none" accept="image/*">
                  <button type="button" class="btn btn-sm btn-outline-primary" id="changeAvatarBtn">
                    <i class="bi bi-camera"></i> Changer
                  </button>
                </div>
                <div class="mb-3">
                  <label for="userName" class="form-label">Nom complet</label>
                  <input type="text" class="form-control" id="userName" required>
                </div>
                <div class="mb-3">
                  <label for="userRole" class="form-label">Rôle dans l'amicale</label>
                  <input type="text" class="form-control" id="userRole">
                </div>
                <div class="mb-3">
                  <label for="userEmail" class="form-label">Email</label>
                  <input type="email" class="form-control" id="userEmail">
                </div>
                <div class="mb-3">
                  <label for="userPhone" class="form-label">Téléphone</label>
                  <input type="tel" class="form-control" id="userPhone">
                </div>
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Enregistrer
                  </button>
                </div>
              </form>
              
              <div class="mt-4">
                <h5><i class="bi bi-lightbulb"></i> Mes idées</h5>
                <div id="myIdeasList">
                  <p class="text-muted">Chargement de vos idées...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal pour ajouter un commentaire -->
  <div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ajouter un commentaire</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="commentForm">
            <input type="hidden" id="commentIdeaId">
            <div class="mb-3">
              <label for="commentText" class="form-label">Votre commentaire</label>
              <textarea class="form-control" id="commentText" rows="3" required></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="saveComment">Publier</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal pour gérer les idées (admin) -->
  <div class="modal fade" id="manageIdeaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Gérer l'idée</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="manageIdeaForm">
            <input type="hidden" id="manageIdeaId">
            <div class="mb-3">
              <label for="ideaStatus" class="form-label">Statut</label>
              <select class="form-select" id="ideaStatus">
                <option value="proposed">Proposée</option>
                <option value="planned">Planifiée</option>
                <option value="inprogress">En cours</option>
                <option value="completed">Réalisée</option>
                <option value="rejected">Rejetée</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="adminComment" class="form-label">Commentaire du bureau</label>
              <textarea class="form-control" id="adminComment" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="saveIdeaStatus">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal pour voir l'image en grand -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-body text-center">
          <img id="modalImage" src="" class="img-fluid">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Notifications Toast -->
  <div class="toast-container" id="toastContainer"></div>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCMM2VHg4mb3SGS79CylTB-EvjMK81J9eg",
      authDomain: "amicale-550c8.firebaseapp.com",
      projectId: "amicale-550c8",
      storageBucket: "amicale-550c8.firebasestorage.app",
      messagingSenderId: "707637752453",
      appId: "1:707637752453:web:3246f59d3438172ece6fec",
      measurementId: "G-K4JZKED5SR"
    };

    // Initialisation Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // Variables globales
    let currentUser = null;
    let currentUserData = null;
    let isAdmin = false;
    let headerImageUrl = null;
    const MAX_IMAGE_SIZE = 1 * 1024 * 1024; // 1MB
    
    // Initialisation de l'application
    document.addEventListener('DOMContentLoaded', function() {
      initHeaderImage();
      loadIdeas();
      loadEvents();
      setupIdeaForm();
      setupEventForm();
      setupCommentForm();
      setupProfileForm();
      setupImageUpload();
      setupFilters();
      
      // Détection de l'utilisateur
      detectUser();
    });
    
    // Initialisation de l'image d'entête
    function initHeaderImage() {
      database.ref('settings/headerImage').on('value', (snapshot) => {
        if (snapshot.exists()) {
          headerImageUrl = snapshot.val();
          document.getElementById('headerImage').src = headerImageUrl;
        }
      });
    }
    
    // Configuration de l'upload d'image (base64)
    function setupImageUpload() {
      // Image d'entête
      document.getElementById('imageUpload').addEventListener('change', function(e) {
        if (!isAdmin) {
          showToast('Seuls les administrateurs peuvent modifier cette image', 'warning');
          return;
        }
        
        const file = e.target.files[0];
        if (!file) return;
        
        // Vérification de la taille
        if (file.size > MAX_IMAGE_SIZE) {
          showToast('L\'image est trop lourde (max 1MB)', 'danger');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(event) {
          const base64Image = event.target.result;
          
          // Sauvegarde dans Firebase
          database.ref('settings/headerImage').set(base64Image)
            .then(() => {
              showToast('Image d\'entête mise à jour', 'success');
            })
            .catch((error) => {
              console.error('Error saving image:', error);
              showToast('Erreur lors de la mise à jour', 'danger');
            });
        };
        reader.readAsDataURL(file);
      });
      
      // Avatar utilisateur
      document.getElementById('changeAvatarBtn').addEventListener('click', function() {
        document.getElementById('avatarUpload').click();
      });
      
      document.getElementById('avatarUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.size > MAX_IMAGE_SIZE) {
          showToast('L\'image est trop lourde (max 1MB)', 'danger');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(event) {
          const base64Image = event.target.result;
          document.getElementById('userAvatar').src = base64Image;
          
          // Sauvegarde dans le profil utilisateur
          if (currentUser) {
            database.ref(`users/${currentUser}/avatar`).set(base64Image)
              .then(() => {
                showToast('Avatar mis à jour', 'success');
              })
              .catch((error) => {
                console.error('Error saving avatar:', error);
                showToast('Erreur lors de la mise à jour', 'danger');
              });
          }
        };
        reader.readAsDataURL(file);
      });
    }
    
    // Chargement des idées
    function loadIdeas() {
      database.ref('ideas').on('value', (snapshot) => {
        const ideasData = snapshot.val() || {};
        const ideasList = document.getElementById('ideasList');
        const topIdeasList = document.getElementById('topIdeasList');
        const myIdeasList = document.getElementById('myIdeasList');
        
        // Convertir en tableau et trier
        let ideasArray = Object.entries(ideasData).map(([id, idea]) => ({ id, ...idea }));
        
        // Trier par date (du plus récent au plus ancien)
        ideasArray.sort((a, b) => b.timestamp - a.timestamp);
        
        // Trier par votes pour les idées populaires
        let topIdeasArray = [...ideasArray].sort((a, b) => {
          const votesA = a.votes ? Object.keys(a.votes).length : 0;
          const votesB = b.votes ? Object.keys(b.votes).length : 0;
          return votesB - votesA;
        });
        
        // Filtrer les idées de l'utilisateur courant
        let myIdeasArray = [];
        if (currentUser) {
          myIdeasArray = ideasArray.filter(idea => idea.authorId === currentUser);
        }
        
        // Afficher toutes les idées
        ideasList.innerHTML = '';
        if (ideasArray.length === 0) {
          ideasList.innerHTML = `
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> Aucune idée n'a encore été proposée. Soyez le premier !
            </div>
          `;
        } else {
          ideasArray.forEach(idea => {
            ideasList.innerHTML += createIdeaCard(idea);
          });
        }
        
        // Afficher les idées populaires
        topIdeasList.innerHTML = '';
        if (topIdeasArray.length === 0) {
          topIdeasList.innerHTML = `
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> Aucune idée n'a encore été proposée.
            </div>
          `;
        } else {
          topIdeasArray.slice(0, 5).forEach(idea => {
            topIdeasList.innerHTML += createIdeaCard(idea, true);
          });
        }
        
        // Afficher les idées de l'utilisateur
        myIdeasList.innerHTML = '';
        if (myIdeasArray.length === 0) {
          myIdeasList.innerHTML = `
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> Vous n'avez pas encore proposé d'idée.
            </div>
          `;
        } else {
          myIdeasArray.forEach(idea => {
            myIdeasList.innerHTML += createIdeaCard(idea);
          });
        }
        
        // Mettre à jour les statistiques
        updateStats(ideasArray);
        
        // Ajouter les événements
        addIdeaEvents();
      });
    }
    
    // Chargement des événements
    function loadEvents() {
      database.ref('events').on('value', (snapshot) => {
        const eventsData = snapshot.val() || {};
        const eventsList = document.getElementById('eventsList');
        const upcomingEvents = document.getElementById('upcomingEvents');
        
        // Convertir en tableau et trier par date
        let eventsArray = Object.entries(eventsData).map(([id, event]) => ({ id, ...event }));
        eventsArray.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // Filtrer les événements à venir
        const now = new Date();
        const upcoming = eventsArray.filter(event => new Date(event.date) >= now);
        const past = eventsArray.filter(event => new Date(event.date) < now);
        
        // Afficher tous les événements
        eventsList.innerHTML = '';
        if (eventsArray.length === 0) {
          eventsList.innerHTML = `
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> Aucun événement n'a encore été programmé.
            </div>
          `;
        } else {
          upcoming.forEach(event => {
            eventsList.innerHTML += createEventCard(event);
          });
          
          if (past.length > 0) {
            eventsList.innerHTML += `
              <div class="mt-5">
                <h5 class="mb-3"><i class="bi bi-clock-history"></i> Événements passés</h5>
                ${past.map(event => createEventCard(event)).join('')}
              </div>
            `;
          }
        }
        
        // Afficher les prochains événements dans le panneau latéral
        upcomingEvents.innerHTML = '';
        if (upcoming.length === 0) {
          upcomingEvents.innerHTML = '<p class="text-muted">Aucun événement à venir</p>';
        } else {
          upcoming.slice(0, 3).forEach(event => {
            const eventDate = new Date(event.date);
            const formattedDate = eventDate.toLocaleDateString('fr-FR', {
              day: 'numeric',
              month: 'short',
              year: 'numeric'
            });
            
            upcomingEvents.innerHTML += `
              <div class="mb-3 pb-2 border-bottom">
                <h6 class="mb-1">${event.title}</h6>
                <small class="text-muted">
                  <i class="bi bi-calendar"></i> ${formattedDate}<br>
                  <i class="bi bi-geo-alt"></i> ${event.location}
                </small>
              </div>
            `;
          });
        }
        
        // Ajouter les événements
        addEventEvents();
      });
    }
    
    // Création d'une carte d'idée
    function createIdeaCard(idea, isTop = false) {
      const voteCount = idea.votes ? Object.keys(idea.votes).length : 0;
      const commentCount = idea.comments ? Object.keys(idea.comments).length : 0;
      
      // Formatage de la date
      const date = new Date(idea.timestamp);
      const formattedDate = date.toLocaleDateString('fr-FR', {
        day: 'numeric', 
        month: 'long', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      // Vérifier si l'utilisateur a déjà voté
      let hasVoted = false;
      if (currentUser && idea.votes) {
        hasVoted = Object.values(idea.votes).some(vote => vote.voter === currentUser);
      }
      
      // Statut de l'idée
      let statusBadge = '';
      if (idea.status === 'planned') {
        statusBadge = '<span class="status-badge status-planned">Planifiée</span>';
      } else if (idea.status === 'inprogress') {
        statusBadge = '<span class="status-badge status-inprogress">En cours</span>';
      } else if (idea.status === 'completed') {
        statusBadge = '<span class="status-badge status-completed">Réalisée</span>';
      } else if (idea.status === 'rejected') {
        statusBadge = '<span class="status-badge status-rejected">Rejetée</span>';
      }
      
      // Auteur avec avatar
      let authorSection = `
        <small class="text-muted">
          <i class="bi bi-person"></i> Proposé par ${idea.author}
        </small>
      `;
      
      if (idea.authorAvatar) {
        authorSection = `
          <div class="user-badge">
            <img src="${idea.authorAvatar}" class="user-avatar" style="width: 30px; height: 30px;">
            <div>
              <div class="user-name">${idea.author}</div>
              ${idea.authorRole ? `<div class="user-role">${idea.authorRole}</div>` : ''}
            </div>
          </div>
        `;
      }
      
      // Image de l'idée
      let ideaImage = '';
      if (idea.image) {
        ideaImage = `
          <div class="text-center mt-2">
            <img src="${idea.image}" class="idea-image" data-image="${idea.image}">
          </div>
        `;
      }
      
      // Bouton admin
      let adminButton = '';
      if (isAdmin) {
        adminButton = `
          <button class="btn btn-sm btn-outline-warning manage-idea" data-id="${idea.id}">
            <i class="bi bi-gear"></i> Gérer
          </button>
        `;
      }
      
      return `
        <div class="card card-idea mb-4" data-id="${idea.id}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="card-title">${idea.title} ${statusBadge}</h5>
                <p class="card-text">${idea.description}</p>
                ${ideaImage}
              </div>
              ${isTop ? '<span class="badge bg-warning text-dark"><i class="bi bi-star-fill"></i> Populaire</span>' : ''}
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                ${authorSection}
              </div>
              <div>
                <small class="text-muted">
                  <i class="bi bi-clock"></i> ${formattedDate}
                </small>
              </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
              <div class="vote-section d-flex align-items-center">
                <button class="vote-btn btn ${hasVoted ? 'btn-primary' : 'btn-outline-primary'} vote-up" data-id="${idea.id}" ${!currentUser ? 'disabled' : ''}>
                  <i class="bi bi-hand-thumbs-up"></i>
                </button>
                <div class="vote-count mx-3">${voteCount}</div>
                <button class="vote-btn btn ${hasVoted ? 'btn-danger' : 'btn-outline-danger'} vote-down" data-id="${idea.id}" ${!currentUser ? 'disabled' : ''}>
                  <i class="bi bi-hand-thumbs-down"></i>
                </button>
              </div>
              <div>
                ${adminButton}
                <button class="btn btn-sm btn-outline-secondary view-comments" data-id="${idea.id}">
                  <i class="bi bi-chat-left"></i> ${commentCount}
                </button>
                <button class="btn btn-sm btn-outline-primary add-comment" data-id="${idea.id}" ${!currentUser ? 'disabled' : ''}>
                  <i class="bi bi-plus-circle"></i> Commenter
                </button>
              </div>
            </div>
            
            <div class="comment-section" id="comments-${idea.id}" style="display: none;">
              <h6 class="mb-3"><i class="bi bi-chat-left-text"></i> Commentaires</h6>
              <div id="commentsList-${idea.id}">
                ${idea.comments ? '' : '<p class="text-muted">Aucun commentaire pour le moment.</p>'}
              </div>
            </div>
            
            ${idea.adminComment ? `
              <div class="alert alert-warning mt-3">
                <h6><i class="bi bi-info-circle"></i> Commentaire du bureau</h6>
                <p>${idea.adminComment}</p>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    // Création d'une carte d'événement
    function createEventCard(event) {
      const eventDate = new Date(event.date);
      const formattedDate = eventDate.toLocaleDateString('fr-FR', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      // Image de l'événement
      let eventImage = '';
      if (event.image) {
        eventImage = `
          <div class="text-center mt-2">
            <img src="${event.image}" class="idea-image" data-image="${event.image}">
          </div>
        `;
      }
      
      // Bouton admin
      let adminButton = '';
      if (isAdmin) {
        adminButton = `
          <button class="btn btn-sm btn-outline-danger delete-event" data-id="${event.id}">
            <i class="bi bi-trash"></i> Supprimer
          </button>
        `;
      }
      
      return `
        <div class="card card-idea event-card mb-4" data-id="${event.id}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="card-title">${event.title}</h5>
                <p class="card-text">${event.description}</p>
                ${eventImage}
              </div>
              ${adminButton}
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                <small class="text-muted">
                  <i class="bi bi-calendar"></i> ${formattedDate}
                </small>
              </div>
              <div>
                <small class="text-muted">
                  <i class="bi bi-geo-alt"></i> ${event.location}
                </small>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // Mise à jour des statistiques
    function updateStats(ideasArray) {
      // Nombre total d'idées
      document.getElementById('totalIdeas').textContent = ideasArray.length;
      
      // Nombre total de votes
      const totalVotes = ideasArray.reduce((sum, idea) => {
        return sum + (idea.votes ? Object.keys(idea.votes).length : 0);
      }, 0);
      document.getElementById('totalVotes').textContent = totalVotes;
      
      // Nombre total de commentaires
      const totalComments = ideasArray.reduce((sum, idea) => {
        return sum + (idea.comments ? Object.keys(idea.comments).length : 0);
      }, 0);
      document.getElementById('totalComments').textContent = totalComments;
    }
    
    // Configuration du formulaire d'idée
    function setupIdeaForm() {
      document.getElementById('ideaForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!currentUser) {
          showToast('Vous devez être connecté pour proposer une idée', 'warning');
          return;
        }
        
        const title = document.getElementById('ideaTitle').value.trim();
        const description = document.getElementById('ideaDescription').value.trim();
        const imageFile = document.getElementById('ideaImage').files[0];
        
        if (!title || !description) {
          showToast('Veuillez remplir tous les champs obligatoires', 'warning');
          return;
        }
        
        // Préparer l'objet idée
        const newIdea = {
          title,
          description,
          author: currentUserData?.name || 'Anonyme',
          authorId: currentUser,
          authorAvatar: currentUserData?.avatar || null,
          authorRole: currentUserData?.role || null,
          timestamp: Date.now(),
          votes: {},
          comments: {},
          status: 'proposed'
        };
        
        // Traitement de l'image si fournie
        if (imageFile) {
          if (imageFile.size > MAX_IMAGE_SIZE) {
            showToast('L\'image est trop lourde (max 1MB)', 'danger');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = function(event) {
            newIdea.image = event.target.result;
            saveIdea(newIdea);
          };
          reader.readAsDataURL(imageFile);
        } else {
          saveIdea(newIdea);
        }
      });
    }
    
    // Sauvegarde d'une idée dans Firebase
    function saveIdea(idea) {
      database.ref('ideas').push(idea)
        .then(() => {
          showToast('Idée soumise avec succès!', 'success');
          document.getElementById('ideaForm').reset();
          
          // Basculer vers l'onglet des idées
          const ideasTab = new bootstrap.Tab(document.getElementById('ideas-tab'));
          ideasTab.show();
        })
        .catch((error) => {
          console.error('Error saving idea:', error);
          showToast('Erreur lors de la soumission', 'danger');
        });
    }
    
    // Configuration du formulaire d'événement
    function setupEventForm() {
      document.getElementById('eventForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!isAdmin) {
          showToast('Seuls les administrateurs peuvent créer des événements', 'warning');
          return;
        }
        
        const title = document.getElementById('eventTitle').value.trim();
        const description = document.getElementById('eventDescription').value.trim();
        const date = document.getElementById('eventDate').value;
        const time = document.getElementById('eventTime').value;
        const location = document.getElementById('eventLocation').value.trim();
        const imageFile = document.getElementById('eventImage').files[0];
        
        if (!title || !description || !date || !time || !location) {
          showToast('Veuillez remplir tous les champs obligatoires', 'warning');
          return;
        }
        
        // Combiner date et heure
        const eventDateTime = `${date}T${time}`;
        
        // Préparer l'objet événement
        const newEvent = {
          title,
          description,
          date: eventDateTime,
          location,
          createdBy: currentUser,
          createdAt: Date.now()
        };
        
        // Traitement de l'image si fournie
        if (imageFile) {
          if (imageFile.size > MAX_IMAGE_SIZE) {
            showToast('L\'image est trop lourde (max 1MB)', 'danger');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = function(event) {
            newEvent.image = event.target.result;
            saveEvent(newEvent);
          };
          reader.readAsDataURL(imageFile);
        } else {
          saveEvent(newEvent);
        }
      });
    }
    
    // Sauvegarde d'un événement dans Firebase
    function saveEvent(event) {
      database.ref('events').push(event)
        .then(() => {
          showToast('Événement créé avec succès!', 'success');
          document.getElementById('eventForm').reset();
          
          // Basculer vers l'onglet des événements
          const eventsTab = new bootstrap.Tab(document.getElementById('events-tab'));
          eventsTab.show();
        })
        .catch((error) => {
          console.error('Error saving event:', error);
          showToast('Erreur lors de la création', 'danger');
        });
    }
    
    // Configuration du formulaire de commentaire
    function setupCommentForm() {
      document.getElementById('saveComment').addEventListener('click', function() {
        const ideaId = document.getElementById('commentIdeaId').value;
        const text = document.getElementById('commentText').value.trim();
        
        if (!currentUser) {
          showToast('Vous devez être connecté pour commenter', 'warning');
          return;
        }
        
        if (!text) {
          showToast('Veuillez saisir un commentaire', 'warning');
          return;
        }
        
        const newComment = {
          text,
          author: currentUserData?.name || 'Anonyme',
          authorId: currentUser,
          authorAvatar: currentUserData?.avatar || null,
          timestamp: Date.now()
        };
        
        // Enregistrement dans Firebase
        database.ref(`ideas/${ideaId}/comments`).push(newComment)
          .then(() => {
            showToast('Commentaire ajouté!', 'success');
            document.getElementById('commentForm').reset();
            bootstrap.Modal.getInstance(document.getElementById('commentModal')).hide();
            
            // Recharger les commentaires
            loadComments(ideaId);
          })
          .catch((error) => {
            console.error('Error saving comment:', error);
            showToast('Erreur lors de l\'ajout du commentaire', 'danger');
          });
      });
    }
    
    // Configuration du formulaire de profil
    function setupProfileForm() {
      document.getElementById('profileForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!currentUser) {
          showToast('Vous devez être connecté pour mettre à jour votre profil', 'warning');
          return;
        }
        
        const name = document.getElementById('userName').value.trim();
        const role = document.getElementById('userRole').value.trim();
        const email = document.getElementById('userEmail').value.trim();
        const phone = document.getElementById('userPhone').value.trim();
        
        if (!name) {
          showToast('Le nom est obligatoire', 'warning');
          return;
        }
        
        const userData = {
          name,
          role: role || null,
          email: email || null,
          phone: phone || null,
          updatedAt: Date.now()
        };
        
        // Si l'avatar a été changé mais pas encore sauvegardé
        const avatarInput = document.getElementById('avatarUpload');
        if (avatarInput.files.length > 0) {
          const file = avatarInput.files[0];
          if (file.size > MAX_IMAGE_SIZE) {
            showToast('L\'image est trop lourde (max 1MB)', 'danger');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = function(event) {
            userData.avatar = event.target.result;
            saveProfile(userData);
          };
          reader.readAsDataURL(file);
        } else {
          saveProfile(userData);
        }
      });
    }
    
    // Sauvegarde du profil dans Firebase
    function saveProfile(userData) {
      database.ref(`users/${currentUser}`).update(userData)
        .then(() => {
          showToast('Profil mis à jour!', 'success');
          currentUserData = { ...currentUserData, ...userData };
          updateUIForUser();
        })
        .catch((error) => {
          console.error('Error saving profile:', error);
          showToast('Erreur lors de la mise à jour', 'danger');
        });
    }
    
    // Configuration des filtres
    function setupFilters() {
      document.querySelectorAll('.filter-option').forEach(option => {
        option.addEventListener('click', function(e) {
          e.preventDefault();
          const filter = this.getAttribute('data-filter');
          
          // Mettre à jour l'état actif
          document.querySelectorAll('.filter-option').forEach(opt => {
            opt.classList.remove('active');
          });
          this.classList.add('active');
          
          // Filtrer les idées
          filterIdeas(filter);
        });
      });
    }
    
    // Filtrage des idées
    function filterIdeas(filter) {
      const ideas = document.querySelectorAll('#ideasList .card-idea');
      
      ideas.forEach(idea => {
        const status = idea.querySelector('.status-badge')?.textContent.toLowerCase() || 'proposed';
        
        if (filter === 'all') {
          idea.style.display = '';
        } else if (filter === 'planned' && status.includes('planifiée')) {
          idea.style.display = '';
        } else if (filter === 'inprogress' && status.includes('en cours')) {
          idea.style.display = '';
        } else if (filter === 'completed' && status.includes('réalisée')) {
          idea.style.display = '';
        } else if (filter === 'rejected' && status.includes('rejetée')) {
          idea.style.display = '';
        } else if (filter !== 'all') {
          idea.style.display = 'none';
        }
      });
    }
    
    // Ajout des événements aux idées
    function addIdeaEvents() {
      // Boutons de vote
      document.querySelectorAll('.vote-up, .vote-down').forEach(btn => {
        btn.addEventListener('click', function() {
          const ideaId = this.getAttribute('data-id');
          const isUpvote = this.classList.contains('vote-up');
          
          if (!currentUser) {
            showToast('Vous devez être connecté pour voter', 'warning');
            return;
          }
          
          // Vérifier si l'utilisateur a déjà voté pour cette idée
          database.ref(`ideas/${ideaId}/votes`).once('value')
            .then((snapshot) => {
              const votes = snapshot.val() || {};
              const userVoteKey = Object.keys(votes).find(key => votes[key].voter === currentUser);
              
              if (userVoteKey) {
                // L'utilisateur a déjà voté - suppression du vote
                database.ref(`ideas/${ideaId}/votes/${userVoteKey}`).remove()
                  .then(() => {
                    showToast('Vote retiré', 'info');
                  })
                  .catch((error) => {
                    console.error('Error removing vote:', error);
                    showToast('Erreur lors du retrait du vote', 'danger');
                  });
              } else {
                // Nouveau vote
                const newVote = {
                  voter: currentUser,
                  type: isUpvote ? 'up' : 'down',
                  timestamp: Date.now()
                };
                
                database.ref(`ideas/${ideaId}/votes`).push(newVote)
                  .then(() => {
                    showToast(`Vote ${isUpvote ? 'positif' : 'négatif'} enregistré`, 'success');
                  })
                  .catch((error) => {
                    console.error('Error saving vote:', error);
                    showToast('Erreur lors de l\'enregistrement du vote', 'danger');
                  });
              }
            });
        });
      });
      
      // Boutons pour voir les commentaires
      document.querySelectorAll('.view-comments').forEach(btn => {
        btn.addEventListener('click', function() {
          const ideaId = this.getAttribute('data-id');
          const commentsSection = document.getElementById(`comments-${ideaId}`);
          
          // Basculer l'affichage
          if (commentsSection.style.display === 'none') {
            commentsSection.style.display = 'block';
            
            // Charger les commentaires si ce n'est pas déjà fait
            loadComments(ideaId);
          } else {
            commentsSection.style.display = 'none';
          }
        });
      });
      
      // Boutons pour ajouter un commentaire
      document.querySelectorAll('.add-comment').forEach(btn => {
        btn.addEventListener('click', function() {
          const ideaId = this.getAttribute('data-id');
          
          if (!currentUser) {
            showToast('Vous devez être connecté pour commenter', 'warning');
            return;
          }
          
          document.getElementById('commentIdeaId').value = ideaId;
          const commentModal = new bootstrap.Modal(document.getElementById('commentModal'));
          commentModal.show();
        });
      });
      
      // Boutons pour gérer les idées (admin)
      document.querySelectorAll('.manage-idea').forEach(btn => {
        btn.addEventListener('click', function() {
          const ideaId = this.getAttribute('data-id');
          
          database.ref(`ideas/${ideaId}`).once('value')
            .then((snapshot) => {
              const idea = snapshot.val();
              
              document.getElementById('manageIdeaId').value = ideaId;
              document.getElementById('ideaStatus').value = idea.status || 'proposed';
              document.getElementById('adminComment').value = idea.adminComment || '';
              
              const manageModal = new bootstrap.Modal(document.getElementById('manageIdeaModal'));
              manageModal.show();
            });
        });
      });
      
      // Sauvegarde du statut de l'idée
      document.getElementById('saveIdeaStatus').addEventListener('click', function() {
        const ideaId = document.getElementById('manageIdeaId').value;
        const status = document.getElementById('ideaStatus').value;
        const adminComment = document.getElementById('adminComment').value.trim();
        
        const updates = {
          status,
          adminComment: adminComment || null,
          updatedAt: Date.now()
        };
        
        database.ref(`ideas/${ideaId}`).update(updates)
          .then(() => {
            showToast('Statut de l\'idée mis à jour', 'success');
            bootstrap.Modal.getInstance(document.getElementById('manageIdeaModal')).hide();
          })
          .catch((error) => {
            console.error('Error updating idea:', error);
            showToast('Erreur lors de la mise à jour', 'danger');
          });
      });
      
      // Clic sur les images pour les agrandir
      document.querySelectorAll('.idea-image').forEach(img => {
        img.addEventListener('click', function() {
          const imageUrl = this.getAttribute('data-image');
          document.getElementById('modalImage').src = imageUrl;
          const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
          imageModal.show();
        });
      });
    }
    
    // Ajout des événements aux événements
    function addEventEvents() {
      // Boutons pour supprimer les événements (admin)
      document.querySelectorAll('.delete-event').forEach(btn => {
        btn.addEventListener('click', function() {
          const eventId = this.getAttribute('data-id');
          
          if (confirm('Voulez-vous vraiment supprimer cet événement ?')) {
            database.ref(`events/${eventId}`).remove()
              .then(() => {
                showToast('Événement supprimé', 'success');
              })
              .catch((error) => {
                console.error('Error deleting event:', error);
                showToast('Erreur lors de la suppression', 'danger');
              });
          }
        });
      });
      
      // Clic sur les images pour les agrandir
      document.querySelectorAll('.idea-image').forEach(img => {
        img.addEventListener('click', function() {
          const imageUrl = this.getAttribute('data-image');
          document.getElementById('modalImage').src = imageUrl;
          const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
          imageModal.show();
        });
      });
    }
    
    // Chargement des commentaires
    function loadComments(ideaId) {
      const commentsList = document.getElementById(`commentsList-${ideaId}`);
      
      database.ref(`ideas/${ideaId}/comments`).once('value')
        .then((snapshot) => {
          const comments = snapshot.val() || {};
          commentsList.innerHTML = '';
          
          if (Object.keys(comments).length === 0) {
            commentsList.innerHTML = '<p class="text-muted">Aucun commentaire pour le moment.</p>';
            return;
          }
          
          // Convertir en tableau et trier par date
          const commentsArray = Object.entries(comments).map(([id, comment]) => ({ id, ...comment }));
          commentsArray.sort((a, b) => b.timestamp - a.timestamp);
          
          // Afficher les commentaires
          commentsArray.forEach(comment => {
            const date = new Date(comment.timestamp);
            const formattedDate = date.toLocaleDateString('fr-FR', {
              day: 'numeric', 
              month: 'long', 
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            
            let authorAvatar = '<i class="bi bi-person-circle" style="font-size: 1.5rem;"></i>';
            if (comment.authorAvatar) {
              authorAvatar = `<img src="${comment.authorAvatar}" class="user-avatar">`;
            }
            
            commentsList.innerHTML += `
              <div class="comment">
                <div class="d-flex">
                  <div class="me-2">
                    ${authorAvatar}
                  </div>
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between mb-2">
                      <span class="comment-author">${comment.author}</span>
                      <small class="comment-date">${formattedDate}</small>
                    </div>
                    <p>${comment.text}</p>
                  </div>
                </div>
              </div>
            `;
          });
        })
        .catch((error) => {
          console.error('Error loading comments:', error);
          commentsList.innerHTML = '<p class="text-danger">Erreur lors du chargement des commentaires</p>';
        });
    }
    
    // Détection de l'utilisateur
    function detectUser() {
      // Dans une vraie application, vous utiliseriez Firebase Auth
      // Pour cet exemple, nous allons simplement demander le nom
      
      const storedUser = localStorage.getItem('amicale_user');
      if (storedUser) {
        currentUser = storedUser;
        loadUserData();
        return;
      }
      
      // Demander le nom si non enregistré
      setTimeout(() => {
        const userName = prompt('Bienvenue sur l\'amicale! Veuillez entrer votre nom:');
        if (userName) {
          currentUser = userName.trim();
          localStorage.setItem('amicale_user', currentUser);
          
          // Vérifier si c'est un admin (pour la démo)
          if (userName.toLowerCase().includes('admin')) {
            isAdmin = true;
            showToast(`Bienvenue administrateur ${currentUser}!`, 'success');
          } else {
            showToast(`Bienvenue ${currentUser}!`, 'success');
          }
          
          // Créer le profil utilisateur
          const userData = {
            name: currentUser,
            createdAt: Date.now(),
            isAdmin: isAdmin
          };
          
          database.ref(`users/${currentUser}`).update(userData)
            .then(() => {
              loadUserData();
            });
        } else {
          showToast('Vous pouvez naviguer mais certaines fonctionnalités sont limitées', 'info');
        }
      }, 1000);
    }
    
    // Chargement des données utilisateur
    function loadUserData() {
      database.ref(`users/${currentUser}`).on('value', (snapshot) => {
        currentUserData = snapshot.val() || {};
        isAdmin = currentUserData.isAdmin || false;
        
        updateUIForUser();
      });
    }
    
    // Mise à jour de l'UI en fonction de l'utilisateur
    function updateUIForUser() {
      // Afficher/masquer les fonctionnalités admin
      if (isAdmin) {
        document.getElementById('addEvent-tab').style.display = '';
        document.getElementById('addEventBtn').style.display = '';
      } else {
        document.getElementById('addEvent-tab').style.display = 'none';
        document.getElementById('addEventBtn').style.display = 'none';
      }
      
      // Mettre à jour le profil
      if (currentUserData) {
        document.getElementById('userName').value = currentUserData.name || '';
        document.getElementById('userRole').value = currentUserData.role || '';
        document.getElementById('userEmail').value = currentUserData.email || '';
        document.getElementById('userPhone').value = currentUserData.phone || '';
        
        if (currentUserData.avatar) {
          document.getElementById('userAvatar').src = currentUserData.avatar;
        }
      }
    }
    
    // Affichage d'une notification toast
    function showToast(message, type) {
      const toastContainer = document.getElementById('toastContainer');
      const toastId = 'toast-' + Date.now();
      
      const toast = document.createElement('div');
      toast.id = toastId;
      toast.className = `toast show align-items-center text-white bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      // Supprimer après 5 secondes
      setTimeout(() => {
        const toastElement = document.getElementById(toastId);
        if (toastElement) {
          toastElement.classList.remove('show');
          setTimeout(() => toastElement.remove(), 300);
        }
      }, 5000);
    }
  </script>
</body>
</html>