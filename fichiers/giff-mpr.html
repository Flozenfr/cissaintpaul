<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme Gestion Équipes Feux de Forêt</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Variables CSS modernes */
        :root {
            --primary-color: #E63946; /* Rouge vif mais professionnel */
            --secondary-color: #457B9D; /* Bleu marine */
            --accent-color: #1D3557; /* Bleu foncé */
            --success-color: #2A9D8F; /* Vert émeraude */
            --warning-color: #F4A261; /* Orange doux */
            --danger-color: #E76F51; /* Rouge orangé */
            
            --background-color: #F8F9FA; /* Gris très clair */
            --card-bg-color: #FFFFFF; /* Blanc pur */
            --text-color: #2B2D42; /* Gris très foncé */
            --text-light: #8D99AE; /* Gris moyen */
            --border-color: #E9ECEF; /* Gris très clair pour bordures */
            
            --header-bg-color: #1D3557; /* Bleu foncé */
            --header-text-color: #F1FAEE; /* Blanc cassé */
            --nav-bg-color: #457B9D; /* Bleu marine */
            --nav-link-color: #F1FAEE;
            --nav-link-hover-bg: #E63946;
            --nav-link-active-color: #FFFFFF;
            
            --input-bg-color: #FFFFFF;
            --input-border-color: #CED4DA;
            --button-hover-bg: #D62839;
            --disabled-input-bg: #E9ECEF;
            
            --available-slot-color: #D8F3DC; /* Vert pastel (personnel dispo cal) */
            --unavailable-slot-color: #FFD6D6; /* Rouge pastel (pas utilisé directement pour team status) */
            --partial-slot-color: #FFF3B0; /* Jaune pastel (une équipe complète sur deux - dispo cal) */

            /* NOUVEAUX STATUTS ÉQUIPES CCF4MHP37 */
            --team-ccf-complete: #2A9D8F; /* Vert foncé */
            --team-ccf-missing-conducteurPL: #E76F51; /* Rouge orangé (clair) */
            --team-ccf-missing-chefAgres: #8338EC;    /* Violet */
            --team-ccf-missing-equipierFDF-1: #F4A261; /* Jaune (Orange doux) */
            --team-ccf-missing-equipierFDF-2-plus: #ADB5BD; /* Gris clair/moyen (était --team-none) */
            --team-ccf-empty: #6c757d; /* Gris foncé */
            --team-ccf-text-on-partial: #333333; /* Texte pour fonds clairs (Jaune, Gris Clair) */
            --team-ccf-text-on-colored: #FFFFFF; /* Texte pour fonds foncés (Vert, Rouge, Violet, Gris foncé) */

            /* NOUVEAUX STATUTS ÉQUIPES MPR12 */
            --team-mpr-complete: #457B9D; /* Bleu marine */
            --team-mpr-missing-conducteurVL: #E76F51; /* Rouge orangé (clair) */
            --team-mpr-missing-equipierDIV: #F4A261; /* Jaune (Orange doux) */
            --team-mpr-empty: #6c757d; /* Gris foncé */
            --team-mpr-text-on-partial: #333333;
            --team-mpr-text-on-colored: #FFFFFF;

            --card-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
            --card-hover-shadow: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
            --card-radius: 10px;
            --section-radius: 12px;
            --button-radius: 8px;
            
            --font-family-sans-serif: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            --transition-base: all 0.2s ease-in-out;
        }

        /* Mode sombre */
        .dark-mode {
            --primary-color: #EF476F;
            --secondary-color: #118AB2;
            --accent-color: #073B4C;
            --success-color: #06D6A0;
            --warning-color: #FFD166;
            --danger-color: #EF476F; /* Ajusté pour dark mode, peut-être le même que primary */
            
            --background-color: #121212;
            --card-bg-color: #1E1E1E;
            --text-color: #E1E1E1;
            --text-light: #A0A0A0;
            --border-color: #2E2E2E;
            
            --header-bg-color: #073B4C;
            --header-text-color: #FFFFFF;
            --nav-bg-color: #118AB2;
            
            --input-bg-color: #2E2E2E;
            --input-border-color: #3E3E3E;
            --button-hover-bg: #FF6B6B; /* Un rouge plus clair pour hover en mode sombre */
            --disabled-input-bg: #2A2A2A;
            
            --available-slot-color: #1B4332; /* Vert pastel foncé (dispo cal) */
            --unavailable-slot-color: #5E2129; /* Rouge pastel foncé (pas utilisé directement pour team status) */
            --partial-slot-color: #665120; /* Jaune pastel foncé (dispo cal) */

            /* NOUVEAUX STATUTS ÉQUIPES CCF4MHP37 - MODE SOMBRE */
            --team-ccf-complete: #06D6A0; /* Vert émeraude (clair) */
            --team-ccf-missing-conducteurPL: #EF476F; /* Rouge/Rose (clair) */
            --team-ccf-missing-chefAgres: #9B5DE5; /* Violet (clair) */
            --team-ccf-missing-equipierFDF-1: #FFD166; /* Jaune (clair) */
            --team-ccf-missing-equipierFDF-2-plus: #777777; /* Gris clair/moyen */
            --team-ccf-empty: #4E4E4E; /* Gris foncé */
            /* Text colors for dark mode team boxes usually need to be dark for light backgrounds, and light for dark backgrounds */
            --team-ccf-text-on-partial: #1E1E1E; /* Texte foncé sur Jaune clair, Gris clair */
            --team-ccf-text-on-colored: #FFFFFF; /* Texte clair sur Vert, Rouge, Violet, Gris foncé */


            /* NOUVEAUX STATUTS ÉQUIPES MPR12 - MODE SOMBRE */
            --team-mpr-complete: #118AB2; /* Bleu (clair) */
            --team-mpr-missing-conducteurVL: #EF476F; /* Rouge/Rose (clair) */
            --team-mpr-missing-equipierDIV: #FFD166; /* Jaune (clair) */
            --team-mpr-empty: #4E4E4E; /* Gris foncé */
            --team-mpr-text-on-partial: #1E1E1E;
            --team-mpr-text-on-colored: #FFFFFF;

            --card-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.3);
        }

        /* Reset et styles de base */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family-sans-serif);
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            font-size: 15px;
            transition: var(--transition-base);
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.2;
            margin-bottom: 1rem;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        /* Layout */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--header-bg-color), var(--accent-color));
            color: var(--header-text-color);
            padding: 1.2rem 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin: 0;
        }
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }


        /* Navigation */
        nav {
            background-color: var(--nav-bg-color);
            padding: 0.8rem 0;
            position: sticky;
            top: 76px; /* Ajustez si la hauteur du header change */
            z-index: 999;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 992px) { /* Ajustement pour le header responsif */
            nav {
                top: 0; /* Changé si le header devient static/column */
                /* Ou la nouvelle hauteur du header si sticky */
            }
        }


        nav ul {
            display: flex;
            justify-content: center;
            list-style: none;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0 1rem;
        }

        nav ul li a {
            color: var(--nav-link-color);
            padding: 0.7rem 1.5rem;
            border-radius: var(--button-radius);
            font-weight: 500;
            transition: var(--transition-base);
            display: inline-block;
        }

        nav ul li a:hover {
            background-color: var(--nav-link-hover-bg);
            color: var(--nav-link-active-color);
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }

        nav ul li a.active {
            background-color: var(--primary-color);
            color: var(--nav-link-active-color);
            font-weight: 600;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .admin-nav-item { display: none; } /* Hide admin nav items by default */


        /* Sections de contenu */
        .content-section {
            display: none;
            padding: 2rem;
            background-color: var(--card-bg-color);
            border-radius: var(--section-radius);
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition-base);
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Titres */
        h2 {
            color: var(--primary-color);
            font-size: 1.8rem;
            position: relative;
            padding-bottom: 0.8rem;
            margin-bottom: 1.5rem;
        }

        h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border-radius: 3px;
        }

        h3 {
            color: var(--secondary-color);
            font-size: 1.5rem;
            margin-top: 2.5rem;
            margin-bottom: 1.2rem;
        }

        /* Formulaires */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .inline-label {
            display: inline-block;
            margin-left: 0.5rem;
            font-weight: normal;
            vertical-align: middle;
        }

        input[type="text"],
        input[type="date"],
        input[type="search"],
        input[type="number"],
        input[type="password"], /* Added for password prompt */
        select,
        textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            margin-bottom: 1.2rem;
            border: 1px solid var(--input-border-color);
            border-radius: var(--button-radius);
            background-color: var(--input-bg-color);
            color: var(--text-color);
            font-family: inherit;
            font-size: 0.95rem;
            transition: var(--transition-base);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.2);
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }
        .filter-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-container > label { /* Pour les labels des filtres (Ex: Filtrer par compétence:) */
            margin-bottom: 0; /* Ajuster si nécessaire */
            font-weight: 600;
        }
        .skill-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            background-color: color-mix(in srgb, var(--background-color) 50%, transparent);
        }
        .skill-filters label {
            font-weight: normal;
            font-size: 0.9em;
            display: flex; /* Pour aligner checkbox et texte */
            align-items: center;
        }
         .skill-filters input[type="checkbox"] {
            margin-right: 0.3rem; /* Espace réduit */
        }


        /* Boutons */
        button, .button-like { /* Added .button-like for admin login button */
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: var(--button-radius);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-base);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--card-shadow);
            text-decoration: none; /* For .button-like if it's an <a> */
        }

        button:hover, .button-like:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
            box-shadow: var(--card-hover-shadow);
        }

        button:active, .button-like:active {
            transform: translateY(0);
            box-shadow: var(--card-shadow);
        }

        .button-secondary {
            background-color: var(--secondary-color);
        }

        .button-secondary:hover {
            background-color: color-mix(in srgb, var(--secondary-color) 85%, #000000);
        }

        .button-success {
            background-color: var(--success-color);
        }
         .button-success:hover {
            background-color: color-mix(in srgb, var(--success-color) 85%, #000000);
        }


        .button-warning {
            background-color: var(--warning-color);
            color: #333;
        }

        .button-danger {
            background-color: var(--danger-color);
        }

        .button-danger:hover {
            background-color: color-mix(in srgb, var(--danger-color) 85%, #000000);
        }
        
        .button-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .button-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap; /* Pour les boutons supplémentaires */
        }

        /* Tableaux */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 1.5rem 0;
            background-color: var(--card-bg-color);
            border-radius: var(--card-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        th, td {
            padding: 1rem 1.2rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: color-mix(in srgb, var(--secondary-color) 10%, var(--card-bg-color));
            color: var(--text-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: color-mix(in srgb, var(--partial-slot-color) 30%, transparent);
        }
        .dark-mode tr:hover {
             background-color: color-mix(in srgb, var(--text-color) 10%, transparent);
        }


        /* Calendriers */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .calendar-controls > * { /* Pour s'assurer que les éléments ne rétrécissent pas trop */
             margin-bottom: 0.5rem; /* Pour l'espacement en mode wrap */
        }
        .calendar-controls label { margin-bottom: 0; } /* Align label better with input */
        .calendar-controls select,
        .calendar-controls input[type="text"], /* Appliquer aux nouveaux inputs aussi */
        .calendar-controls input[type="search"] {
            min-width: 180px; /* Assurer une largeur minimale */
            flex-grow: 0.3; /* Permettre de grandir un peu mais pas trop */
            margin-bottom: 0; /* Remove default margin from inputs in controls */
        }
         .calendar-controls input[type="search"], /* Cibler spécifiquement */
         .calendar-controls input[type="text"]#personnelInputForCalendar,
         .calendar-controls input[type="text"]#personnelInputForPublicCalendar, /* Added for public calendar */
         .calendar-controls input[type="search"]#searchPersonnelInTeams { 
             flex-grow: 1; /* Laisser le champ de recherche/sélection prendre plus de place */
        }
         .calendar-nav-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .team-status-filters { /* Container for team status dropdowns */
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-grow: 1; /* Allow filters to take space */
        }
        .team-status-filters label {
             white-space: nowrap; /* Prevent label from wrapping */
        }
        .team-status-filters select {
             min-width: 150px; /* Adjust width as needed */
        }


        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .calendar-day {
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: var(--card-radius);
            background-color: var(--card-bg-color);
            min-height: 80px;
            position: relative;
            transition: var(--transition-base);
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }
        .calendar-day.disabled {
            cursor: not-allowed;
            background-color: var(--disabled-input-bg) !important;
            opacity: 0.6;
        }
        .calendar-day:hover:not(.header):not(.other-month):not(.disabled) {
            transform: translateY(-3px);
            box-shadow: var(--card-hover-shadow);
            z-index: 1; /* Pour que l'ombre soit visible au-dessus des autres jours */
        }


        .calendar-day.header {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            text-align: center;
            min-height: auto;
            padding: 0.8rem 0.5rem;
            justify-content: center;
            cursor: default;
        }
        .calendar-day.available { /* Dispo pour la personne sélectionnée */
            background-color: var(--success-color) !important;
            color: white !important;
        }
        .calendar-day.status-day-full { /* Équipes complètes ce jour (pour calendrier dispo) */
            background-color: var(--available-slot-color) !important;
        }
        .calendar-day.status-day-partial { /* Au moins une équipe complète ce jour (pour calendrier dispo) */
             background-color: var(--partial-slot-color) !important;
        }

        .calendar-day.other-month {
            color: var(--text-light);
            background-color: color-mix(in srgb, var(--background-color) 80%, var(--border-color));
            opacity: 0.7;
            cursor: default;
        }
        .calendar-day.personnel-assigned-highlight {
            background-color: var(--warning-color) !important; /* Jaune pastel pour visibilité */
            border: 2px solid var(--primary-color) !important;
            /* color: var(--text-color) !important; */ /* Assurer que le texte reste lisible */
        }
        .dark-mode .calendar-day.personnel-assigned-highlight {
             background-color: var(--warning-color) !important;
             border: 2px solid var(--primary-color) !important;
             color: #333 !important; /* Texte foncé sur fond clair pour le mode sombre */
        }


        .day-number {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        /* Calendrier d'équipes */
        #teamsOverviewCalendarGrid .calendar-day {
            min-height: 120px; /* Augmenté pour plus d'infos */
            cursor: pointer;
            justify-content: space-between; /* Aligne le numéro en haut, contenu en bas */
        }
         #teamsOverviewCalendarGrid .calendar-day.dimmed-day { /* For team status filter */
            opacity: 0.5;
            pointer-events: none; /* Optional: disable click on dimmed days */
        }
        .team-overview-content {
            font-size: 0.8rem;
            margin-top: 0.3rem; /* Réduit pour plus de place */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.3rem; /* Réduit */
            overflow: hidden; /* Empêche le débordement */
        }
        .team-info {
            padding: 0.4rem; /* Réduit */
            border-radius: 6px;
            color: white; /* Par défaut, sera surchargé par classes spécifiques */
            flex-grow: 1; 
            display: flex;
            flex-direction: column; 
            line-height: 1.2;
        }
        .team-info.dimmed-team { /* For team status filter */
            opacity: 0.4;
        }
        .team-info strong { /* Nom de l'équipe GIFF/MPR */
            font-size: 0.85rem; /* Un peu plus petit */
            margin-bottom: 0.2rem;
            display: block;
        }
        .team-info .team-status-label { /* Pour "Manque CPL", etc. */
            font-size: 0.75rem;
            font-style: italic;
            display: block;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }
        .team-member-list { /* Utilisé dans MODAL, pas directement dans cell calendar overview */
            padding-left: 0.5rem; 
            max-height: 60px; 
            overflow-y: auto; 
            font-size: 0.75rem;
            flex-grow: 1; 
        }
        .team-member-list span {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }


        /* Classes d'état des équipes (utilisant les nouvelles variables) */
        .team-ccf-complete { background-color: var(--team-ccf-complete); color: var(--team-ccf-text-on-colored); }
        .team-ccf-missing-conducteurPL { background-color: var(--team-ccf-missing-conducteurPL); color: var(--team-ccf-text-on-colored); }
        .team-ccf-missing-chefAgres { background-color: var(--team-ccf-missing-chefAgres); color: var(--team-ccf-text-on-colored); }
        .team-ccf-missing-equipierFDF-1 { background-color: var(--team-ccf-missing-equipierFDF-1); color: var(--team-ccf-text-on-partial); }
        .team-ccf-missing-equipierFDF-2-plus { background-color: var(--team-ccf-missing-equipierFDF-2-plus); color: var(--team-ccf-text-on-partial); }
        .team-ccf-empty { background-color: var(--team-ccf-empty); color: var(--team-ccf-text-on-colored); }

        .team-mpr-complete { background-color: var(--team-mpr-complete); color: var(--team-mpr-text-on-colored); }
        .team-mpr-missing-conducteurVL { background-color: var(--team-mpr-missing-conducteurVL); color: var(--team-mpr-text-on-colored); }
        .team-mpr-missing-equipierDIV { background-color: var(--team-mpr-missing-equipierDIV); color: var(--team-mpr-text-on-partial); }
        .team-mpr-empty { background-color: var(--team-mpr-empty); color: var(--team-mpr-text-on-colored); }

        /* Styles pour le mode sombre des équipes, utilisant les variables spécifiques au mode sombre */
        .dark-mode .team-ccf-complete { background-color: var(--team-ccf-complete); color: var(--team-ccf-text-on-partial); } /* Note: dark-mode uses its own variable set */
        .dark-mode .team-ccf-missing-conducteurPL { background-color: var(--team-ccf-missing-conducteurPL); color: var(--team-ccf-text-on-colored); }
        .dark-mode .team-ccf-missing-chefAgres { background-color: var(--team-ccf-missing-chefAgres); color: var(--team-ccf-text-on-colored); }
        .dark-mode .team-ccf-missing-equipierFDF-1 { background-color: var(--team-ccf-missing-equipierFDF-1); color: var(--team-ccf-text-on-partial); }
        .dark-mode .team-ccf-missing-equipierFDF-2-plus { background-color: var(--team-ccf-missing-equipierFDF-2-plus); color: var(--team-ccf-text-on-colored); }
        .dark-mode .team-ccf-empty { background-color: var(--team-ccf-empty); color: var(--team-ccf-text-on-colored); }

        .dark-mode .team-mpr-complete { background-color: var(--team-mpr-complete); color: var(--team-mpr-text-on-colored); }
        .dark-mode .team-mpr-missing-conducteurVL { background-color: var(--team-mpr-missing-conducteurVL); color: var(--team-mpr-text-on-colored); }
        .dark-mode .team-mpr-missing-equipierDIV { background-color: var(--team-mpr-missing-equipierDIV); color: var(--team-mpr-text-on-partial); }
        .dark-mode .team-mpr-empty { background-color: var(--team-mpr-empty); color: var(--team-mpr-text-on-colored); }



        /* Modale */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1001;
            overflow-y: auto; /* Permet de scroller la modale si contenu trop long */
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--card-bg-color);
            margin: 3% auto; /* Marge en % pour s'adapter */
            padding: 2rem;
            border-radius: var(--section-radius);
            width: 90%;
            max-width: 850px; /* Limite la largeur max */
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: modalFadeIn 0.3s ease-out;
        }
        /* Password Modal Specifics */
        #passwordModal .modal-content {
            max-width: 400px; /* Smaller modal for password */
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition-base);
            line-height: 1; /* Pour un meilleur alignement vertical */
        }
        .modal-close-button:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        /* Contenu de la modale */
        #modalTeamDetailsContent {
            padding: 1rem; /* Espace intérieur */
        }
        #modalTeamDetailsContent h3 { /* Titre de la modale avec la date */
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Pour le bouton vider journée */
        }
         #modalTeamDetailsContent h3 button { /* Bouton vider journée & save */
            font-size: 0.80em !important; /* slightly smaller */
            padding: 0.5rem 0.8rem !important;
            margin-top: 0.5rem; /* Espacement si wrap */
        }
        .modal-actions-top { /* Container for buttons next to date */
             display: flex;
             gap: 0.5rem; /* Space between buttons */
             align-items: center;
        }


        .team-day-container {
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: var(--card-radius);
            background-color: color-mix(in srgb, var(--background-color) 90%, var(--card-bg-color)); /* Légèrement différent du fond */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .team-day-container h4 { /* Nom de l'équipe dans la modale */
            font-size: 1.2rem;
            color: var(--secondary-color);
            margin-bottom: 0.5rem; /* Réduit */
        }
        .team-day-container p.team-status-modal { /* Statut de l'équipe dans la modale */
            font-weight: bold;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .team-day-container ul {
            list-style: none;
            padding-left: 0;
        }
        .team-day-container li {
            padding: 0.8rem 0;
            border-bottom: 1px dashed var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .team-day-container li:last-child {
            border-bottom: none;
        }
        .team-member-actions {
            display: flex;
            gap: 0.5rem;
        }
        .team-member-actions button {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        /* Légendes */
        .legend-container { /* Nouveau conteneur pour les deux légendes */
            display: flex;
            justify-content: space-around; /* Ou space-between */
            flex-wrap: wrap;
            gap: 2rem; /* Espace entre les légendes CCF et MPR */
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: color-mix(in srgb, var(--card-bg-color) 90%, transparent);
            border-radius: var(--card-radius);
        }
        .legend-group {
            flex: 1; /* Permet aux groupes de prendre une largeur équivalente */
            min-width: 280px; /* Largeur minimale pour chaque groupe de légende */
        }
        .legend-group h4 {
            font-size: 1rem;
            color: var(--text-color);
            margin-bottom: 0.8rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid var(--border-color);
        }
        .legend {
            /* margin-top: 1.5rem; */ /* Géré par legend-container */
            display: flex;
            flex-direction: column; /* Items en colonne dans chaque groupe */
            gap: 0.5rem; 
            font-size: 0.85em;
        }
        .legend-item {
            display: flex;
            align-items: center;
            /* margin-bottom: 0.5rem; */ /* Géré par le gap du flex-column */
        }
        .legend-color {
            display: inline-block;
            width: 20px; /* Plus large pour meilleure visibilité */
            height: 20px;
            margin-right: 0.8em;
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            flex-shrink: 0; /* Empêche le carré de rétrécir */
        }
        .legend-item span:last-child { /* Texte de la légende */
            line-height: 1.3;
        }

        /* Styles pour le résumé des manquements */
        #teamsDeficiencySummary {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: var(--card-bg-color);
            border-radius: var(--section-radius);
            box-shadow: var(--card-shadow);
        }
        #teamsDeficiencySummary h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .deficiency-category {
            margin-bottom: 1rem;
        }
        .deficiency-category h4 {
            color: var(--secondary-color);
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        .deficiency-list {
            list-style-type: none;
            padding-left: 0;
        }
        .deficiency-list li {
            padding: 0.3rem 0;
            font-size: 0.9rem;
            border-bottom: 1px dashed var(--border-color);
        }
        .deficiency-list li:last-child {
            border-bottom: none;
        }
        .deficiency-list strong {
            color: var(--danger-color);
        }


        /* Statistiques */
        .stat-item { /* Ancien style, peut être réutilisé ou supprimé si stats-card est partout */
            margin-bottom: 1.2rem;
            padding: 1.2rem;
            background-color: var(--card-bg-color);
            border-left: 4px solid var(--accent-color);
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
        }
        .stat-item strong {
            color: var(--primary-color);
        }

        .personnel-contribution-list { /* Grille pour les cartes de contribution */
            list-style: none;
            padding-left: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.2rem;
            margin-top: 1rem; /* Réduit si le champ de recherche est au-dessus */
        }
        .personnel-contribution-item { /* Carte individuelle de contribution */
            background-color: color-mix(in srgb, var(--background-color) 90%, var(--card-bg-color));
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--secondary-color);
            border-radius: var(--card-radius);
            padding: 1.2rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition-base);
        }
        .personnel-contribution-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--card-hover-shadow);
        }
        .personnel-contribution-item dt { /* Nom du personnel */
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        .personnel-contribution-item dd { /* Stats individuelles */
            margin-left: 0;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        /* Nouveaux styles pour les statistiques améliorées */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .stats-card {
            background-color: var(--card-bg-color);
            border-radius: var(--card-radius);
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition-base);
            border-top: 4px solid var(--primary-color);
        }

        .stats-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--card-hover-shadow);
        }

        .stats-card h4 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stats-card h4 .icon {
            font-size: 1.2em;
        }

        .stats-summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .stats-summary-table th,
        .stats-summary-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .stats-summary-table th {
            background-color: color-mix(in srgb, var(--secondary-color) 10%, transparent);
            color: var(--text-color);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .stats-summary-table tr:last-child td {
            border-bottom: none;
        }

        .stats-summary-table td:last-child {
            font-weight: 600;
            text-align: right;
        }

        .progress-container {
            width: 100%;
            background-color: var(--border-color);
            border-radius: 10px;
            margin: 0.5rem 0;
            height: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            border-radius: 10px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.5s ease;
        }

        .stats-highlight {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0.5rem 0;
            line-height: 1;
        }

        .stats-highlight-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .stats-comparison {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }

        .stats-comparison-item {
            text-align: center;
            flex: 1;
            padding: 0.5rem;
        }

        .stats-comparison-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .stats-comparison-label {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .stats-role-distribution {
            margin-top: 1rem;
        }

        .stats-role-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .stats-role-name {
            font-size: 0.9rem;
            flex: 1;
        }

        .stats-role-count {
            font-weight: 600;
            min-width: 50px;
            text-align: right;
            margin-left: 1rem;
        }

        .stats-role-percent {
            color: var(--text-light);
            font-size: 0.8rem;
            min-width: 50px;
            text-align: right;
            margin-left: 0.5rem;
        }

        /* Mini graphiques */
        .mini-chart {
            height: 60px;
            width: 100%;
            margin: 0.5rem 0;
            display: flex;
            align-items: flex-end;
            gap: 2px;
        }

        .mini-chart-bar {
            flex: 1;
            background-color: var(--secondary-color);
            border-radius: 3px 3px 0 0;
            transition: height 0.5s ease, background-color 0.5s ease; /* Ajout transition background-color */
            position: relative;
        }

        .mini-chart-bar:hover {
            opacity: 0.8;
        }

        .mini-chart-bar::after { /* Tooltip pour le nom du mois/jour */
            content: attr(data-tooltip); 
            position: absolute;
            bottom: 105%; /* Au-dessus de la barre */
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--text-color);
            background-color: var(--card-bg-color);
            padding: 2px 5px;
            border-radius: 3px;
            box-shadow: var(--card-shadow);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 10;
        }
        .mini-chart-bar:hover::after {
            opacity: 1;
            visibility: visible;
        }
        /* Deadline display style */
        .deadline-display {
            padding: 0.8rem;
            margin-bottom: 1rem;
            background-color: var(--warning-color);
            color: var(--text-color); /* Ensure text is readable on warning background */
            border-radius: var(--button-radius);
            text-align: center;
            font-weight: 500;
        }
        .dark-mode .deadline-display {
            color: #333; /* Darker text for light warning in dark mode */
        }


        /* Responsive */
        @media (max-width: 992px) {
            .container { padding: 1rem; }
            .content-section { padding: 1.5rem; }
            header {
                padding: 1rem;
                flex-direction: column;
                text-align: center;
                gap: 1rem;
                /* position: static; If header is not sticky on mobile */
            }
             nav { /* If header is static on mobile, nav also needs to adjust */
                 top: 0; /* Reset top if header becomes static */
                 position: static; /* Example: if nav follows a static header */
            }
            nav ul { flex-direction: column; align-items: center; }
            .form-grid { grid-template-columns: 1fr; }
            .calendar-grid { gap: 0.5rem; }
            .calendar-day { min-height: 70px; padding: 0.5rem; }
            #teamsOverviewCalendarGrid .calendar-day { min-height: 100px; }
            .modal-content { width: 95%; padding: 1.5rem; }
            .personnel-contribution-list { grid-template-columns: 1fr; }
            .form-actions { flex-direction: column; }
            .form-actions button { width: 100%; }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body { font-size: 14px; }
            h2 { font-size: 1.5rem; }
            h3 { font-size: 1.3rem; }
            .calendar-controls { flex-direction: column; align-items: stretch; }
            .calendar-controls > * { width: 100%; }
              .calendar-nav-buttons button { flex-grow: 1; } /* Buttons take more space */
              .team-status-filters { flex-direction: column; align-items: stretch; } /* Stack filters on small screens */
              .team-status-filters select { width: 100%; }


            table { display: block; overflow-x: auto; } /* Pour la scrollbar horizontale */
            #modalTeamDetailsContent h3 { flex-direction: column; align-items: flex-start; }
            #modalTeamDetailsContent h3 .modal-actions-top { width: 100%; justify-content: flex-start; margin-top: 0.5rem;} /* Stack buttons */
            #modalTeamDetailsContent h3 button { margin-top: 0.8rem; margin-left: 0 !important; } /* !important pour forcer si inline style */
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse {
            animation: pulse 1.5s infinite;
        }

        /* Icônes (simulées avec Unicode) */
        .icon {
            display: inline-flex; /* Pour un meilleur contrôle */
            align-items: center;
            justify-content: center;
            width: 1.2em; /* Espace pour l'icône */
            height: 1.2em;
            margin-right: 0.3em; /* Espace entre icône et texte */
        }
        /* Print-specific styles for PDF export of team calendar */
        @media print {
            body, html {
                background-color: #fff !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact !important; /* Chrome, Safari */
                color-adjust: exact !important; /* Firefox */
            }
            header, nav, #themeSwitcher, .modal-close-button,
            #exportCSV, #printPlanning, #exportTeamsCalendarPDF,
            #teamsDateSelectDetail, #generateTeamsForDayDetailBtn,
            .team-member-actions, #clearDayBtnInModal, #saveManualAssignmentBtn,
            .calendar-controls button:not(#jumpToCurrentMonthTeamsOverview):not(#jumpToCurrentMonthAdminDispo):not(#jumpToCurrentMonthPublicDispo), /* Hide prev/next month buttons, but not jump */
            .search-personnel-teams-container, 
            #searchPersonnelInTeams,
            #personnelDataListForTeamsSearch,
            .team-status-filters, /* Hide new filters in print */
            #teamsActionsBottom, /* Hide bottom action row in print if it exists */
            #teamsDeficiencySummary, /* Masquer le résumé des manquements à l'impression PDF du calendrier */
            #adminLoginBtn /* Hide admin login button */
            {
                display: none !important;
            }
            .container {
                padding: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
            }
            .content-section {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
             /* Make sure h2 title for "Vue d'Ensemble Mensuelle des Équipes" and month/year display are visible */
            #equipes > h2, #currentMonthYearTeamsOverview {
                display: block !important;
                text-align: center;
                color: black !important;
                background: none !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
             #equipes > h2::after { display: none !important; }


            #teamsOverviewCalendarGrid {
                display: grid !important; /* Ensure grid layout for print */
                gap: 1px !important; /* Smaller gap for print */
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }
            #teamsOverviewCalendarGrid .calendar-day {
                border: 1px solid #ddd !important;
                min-height: 70px !important; /* Adjust based on A4 page fit */
                padding: 0.15rem !important; /* Smaller padding */
                font-size: 0.6em !important; /* Smaller font */
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                 background-color: white !important; /* Force white background for day cells */
                 color: black !important; /* Force black text for day numbers */
            }
            #teamsOverviewCalendarGrid .calendar-day.header {
                 background-color: #444444 !important; /* Dark grey for header background */
                 color: white !important;
                 font-weight: bold;
            }
             /* Ensure day numbers are visible */
            #teamsOverviewCalendarGrid .day-number {
                color: black !important;
            }

            .team-info {
                 -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                 border: 1px solid #eee !important; /* Light border around team info boxes */
                 line-height: 1.1 !important;
            }
            .team-info strong, .team-info .team-status-label {
                font-size: 0.9em !important; /* Smaller text for print */
                 white-space: normal !important; /* Allow text to wrap */
                 overflow: visible !important;
            }
            
            /* Apply specific background and text colors for print using CSS variables directly */
            .team-ccf-complete { background-color: var(--team-ccf-complete) !important; color: var(--team-ccf-text-on-colored) !important; }
            .team-ccf-missing-conducteurPL { background-color: var(--team-ccf-missing-conducteurPL) !important; color: var(--team-ccf-text-on-colored) !important; }
            .team-ccf-missing-chefAgres { background-color: var(--team-ccf-missing-chefAgres) !important; color: var(--team-ccf-text-on-colored) !important; }
            .team-ccf-missing-equipierFDF-1 { background-color: var(--team-ccf-missing-equipierFDF-1) !important; color: var(--team-ccf-text-on-partial) !important; }
            .team-ccf-missing-equipierFDF-2-plus { background-color: var(--team-ccf-missing-equipierFDF-2-plus) !important; color: var(--team-ccf-text-on-partial) !important; }
            .team-ccf-empty { background-color: var(--team-ccf-empty) !important; color: var(--team-ccf-text-on-colored) !important; }

            .team-mpr-complete { background-color: var(--team-mpr-complete) !important; color: var(--team-mpr-text-on-colored) !important; }
            .team-mpr-missing-conducteurVL { background-color: var(--team-mpr-missing-conducteurVL) !important; color: var(--team-mpr-text-on-colored) !important; }
            .team-mpr-missing-equipierDIV { background-color: var(--team-mpr-missing-equipierDIV) !important; color: var(--team-mpr-text-on-partial) !important; }
            .team-mpr-empty { background-color: var(--team-mpr-empty) !important; color: var(--team-mpr-text-on-colored) !important; }

            .legend-container { display: block !important; page-break-before: always; padding-top:20px !important; } /* Legend on a new page for PDF */
            .legend-group { margin-bottom: 1em; }
              .legend-group h4 { color: black !important; }
            .legend-item span { color: black !important; }
            .legend-color { width: 15px; height: 15px; margin-right: 5px; border: 1px solid black !important; }

              p { font-size: 0.9em; color: black !important; }
        }

    </style>
</head>
<body>
    <header>
        <h1>Plateforme Gestion Équipes FDF (CCF4MHP37 & MPR12)</h1>
        <div class="header-actions">
            <button id="adminLoginBtn" class="button-like"><span class="icon">🔑</span> Admin Login</button>
            <button id="themeSwitcher" class="theme-switcher" aria-label="Changer de thème">
                <span class="icon">🌓</span> Mode Sombre/Clair
            </button>
        </div>
    </header>

    <nav>
        <ul>
            <li><a href="#mes-disponibilites" class="nav-link active">Mes Disponibilités</a></li>
            <li class="admin-nav-item"><a href="#personnel" class="nav-link">Gestion Personnels</a></li>
            <li class="admin-nav-item"><a href="#calendrier-admin" class="nav-link">Calendrier Admin</a></li>
            <li class="admin-nav-item"><a href="#equipes" class="nav-link">Composition Équipes</a></li>
            <li class="admin-nav-item"><a href="#statistiques" class="nav-link">Statistiques</a></li>
        </ul>
    </nav>

    <div class="container">
        <section id="mes-disponibilites" class="content-section active">
            <h2>Mes Disponibilités</h2>
            <div id="publicDeadlineDisplay" class="deadline-display" style="display: none;"></div>
            <div class="calendar-controls">
                <div style="flex-grow: 1;">
                    <input type="text" id="personnelInputForPublicCalendar" list="personnelDataListForPublicCalendar" placeholder="Rechercher et sélectionner votre nom..." style="width: 100%;">
                    <datalist id="personnelDataListForPublicCalendar"></datalist>
                </div>
                <div class="calendar-nav-buttons">
                    <button id="prevMonthBtnPublicDispo" class="button-outline" aria-label="Mois précédent">
                        <span class="icon">◀</span>
                    </button>
                    <span id="currentMonthYearPublicDispo" style="font-weight: 600; white-space: nowrap;">Juin 2025</span>
                    <button id="nextMonthBtnPublicDispo" class="button-outline" aria-label="Mois suivant">
                        <span class="icon">▶</span>
                    </button>
                    <button id="jumpToCurrentMonthPublicDispo" class="button-outline" title="Aller au mois actuel (Juin-Sept 2025)">
                        <span class="icon">🎯</span> Actuel
                    </button>
                </div>
            </div>
            <div class="calendar-grid" id="calendarGridPublicDispo"></div>
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-color" style="background-color: var(--success-color);"></span>
                    <span>Disponible (cliquez pour changer)</span>
                </div>
                 <div class="legend-item">
                    <span class="legend-color" style="background-color: var(--disabled-input-bg);"></span>
                    <span>Date passée / après deadline / hors période</span>
                </div>
            </div>
            <p style="margin-top: 1.5rem; font-style: italic; color: var(--text-light);">
                Sélectionnez votre nom, puis cliquez sur les jours pour marquer/démarquer vos disponibilités.
                Période de planification principale : <strong>1er juin au 30 septembre 2025</strong>.
                Les disponibilités ne peuvent être modifiées après la date limite fixée par l'administrateur ou pour les dates passées.
            </p>
        </section>

        <section id="personnel" class="content-section">
            <h2>Gestion des Personnels</h2>
            <form id="personnelForm">
                <div class="form-grid">
                    <input type="hidden" id="personnelId">
                    <div>
                        <label for="nom">Nom Prénom:</label>
                        <input type="text" id="nom" required>
                    </div>
                    <div>
                        <label>Fonctions:</label>
                        <div style="display: grid; gap: 0.5rem;">
                            <div>
                                <input type="checkbox" id="fctConducteurPL" value="conducteurPL">
                                <label for="fctConducteurPL" class="inline-label">Conducteur Poids Lourd (CCF4MHP37)</label>
                            </div>
                            <div>
                                <input type="checkbox" id="fctChefAgres" value="chefAgres">
                                <label for="fctChefAgres" class="inline-label">Chef d'Agrès FDF (CCF4MHP37)</label>
                            </div>
                            <div>
                                <input type="checkbox" id="fctEquipierFDF" value="equipierFDF">
                                <label for="fctEquipierFDF" class="inline-label">Équipier FDF (CCF4MHP37)</label>
                            </div>
                            <hr style="margin: 0.5rem 0; border-color: var(--border-color);">
                            <div>
                                <input type="checkbox" id="fctConducteurVL" value="conducteurVL">
                                <label for="fctConducteurVL" class="inline-label">Conducteur Voiture (MPR12)</label>
                            </div>
                            <div>
                                <input type="checkbox" id="fctEquipierDIV" value="equipierDIV">
                                <label for="fctEquipierDIV" class="inline-label">Équipier DIV (MPR12)</label>
                            </div>
                        </div>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label for="notes">Notes/Commentaires (optionnel):</label>
                        <textarea id="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit">
                        <span class="icon">💾</span> Ajouter/Modifier Personnel
                    </button>
                    <button type="button" id="clearPersonnelForm" class="button-secondary">
                        <span class="icon">✖</span> Annuler Sélection
                    </button>
                </div>
            </form>
            
            <hr style="margin: 2rem 0;">
            <h3>Paramètres Admin</h3>
             <div class="form-grid">
                <div>
                    <label for="availabilityDeadline">Date Limite Saisie Disponibilités (Utilisateurs):</label>
                    <input type="date" id="availabilityDeadline">
                </div>
                <div>
                    <label>&nbsp;</label> <button type="button" id="setAvailabilityDeadlineBtn" class="button-success" style="width:auto;">
                        <span class="icon">📅</span> Définir Date Limite
                    </button>
                </div>
            </div>
            <p style="font-style: italic; color: var(--text-light); font-size: 0.9em;">
                Après cette date, les utilisateurs ne pourront plus modifier leurs disponibilités via la section "Mes Disponibilités". Les administrateurs peuvent toujours modifier via "Calendrier Admin".
            </p>


            <hr style="margin: 2rem 0;">
            <h3>Liste des Personnels</h3>
             <div class="filter-container">
                <input type="search" id="searchPersonnel" placeholder="Rechercher (nom)..." style="flex-grow:1;">
            </div>
            <div class="filter-container">
                <label>Filtrer par compétence(s):</label>
                <div id="skillFilterContainer" class="skill-filters">
                    </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Nom Prénom</th>
                        <th>Fonctions</th>
                        <th>Notes</th>
                        <th>Dispo. Totales</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="personnelTableBody"></tbody>
            </table>
             <div class="form-actions" style="justify-content: flex-start;">
                 <button type="button" id="resetAllAvailabilitiesBtn" class="button-danger" title="Supprime TOUTES les disponibilités de TOUS les personnels après confirmation. Les personnels ne sont PAS supprimés." >
                    <span class="icon">⚠️</span> Réinitialiser Disponibilités Globales
                </button>
             </div>
        </section>

        <section id="calendrier-admin" class="content-section">
            <h2>Calendrier des Disponibilités (Admin)</h2>
            <div class="calendar-controls">
                <div style="flex-grow: 1;">
                    <input type="text" id="personnelInputForCalendar" list="personnelDataListForCalendar" placeholder="Rechercher et sélectionner un personnel..." style="width: 100%;">
                    <datalist id="personnelDataListForCalendar"></datalist>
                </div>
                <div class="calendar-nav-buttons">
                    <button id="prevMonthBtnAdminDispo" class="button-outline" aria-label="Mois précédent">
                        <span class="icon">◀</span>
                    </button>
                    <span id="currentMonthYearAdminDispo" style="font-weight: 600; white-space: nowrap;">Juin 2025</span>
                    <button id="nextMonthBtnAdminDispo" class="button-outline" aria-label="Mois suivant">
                        <span class="icon">▶</span>
                    </button>
                    <button id="jumpToCurrentMonthAdminDispo" class="button-outline" title="Aller au mois actuel (Juin-Sept 2025)">
                        <span class="icon">🎯</span> Actuel
                    </button>
                </div>
            </div>
            <div class="calendar-grid" id="calendarGridAdminDispo"></div>
            
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-color" style="background-color: var(--success-color);"></span>
                    <span>Personnel sélectionné disponible</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: var(--available-slot-color);"></span>
                    <span>Équipes CCF4MHP37 & MPR12 complètes ce jour</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: var(--partial-slot-color);"></span>
                    <span>Au moins une des deux équipes (CCF/MPR) est complète ce jour</span>
                </div>
                 <div class="legend-item">
                    <span class="legend-color" style="background-color: var(--warning-color); border: 1px solid var(--text-color);"></span>
                    <span>Jour d'affectation (si personnel recherché dans calendrier équipes)</span>
                </div>
            </div>
            
            <p style="margin-top: 1.5rem; font-style: italic; color: var(--text-light);">
                Période de planification principale : <strong>1er juin au 30 septembre 2025</strong>.
                Cliquez sur un jour pour marquer/démarquer la disponibilité du personnel sélectionné.
            </p>
        </section>

        <section id="equipes" class="content-section">
            <h2>Vue d'Ensemble Mensuelle des Équipes</h2>
            <div class="calendar-controls">
                 <div style="flex-grow: 1;" class="search-personnel-teams-container">
                    <input type="search" id="searchPersonnelInTeams" list="personnelDataListForTeamsSearch" placeholder="Rechercher personnel affecté...">
                    <datalist id="personnelDataListForTeamsSearch"></datalist>
                </div>
                <div class="calendar-nav-buttons">
                    <button id="prevMonthBtnTeamsOverview" class="button-outline" aria-label="Mois précédent">
                        <span class="icon">◀</span>
                    </button>
                    <span id="currentMonthYearTeamsOverview" style="font-weight: 600; white-space: nowrap;">Juin 2025</span>
                    <button id="nextMonthBtnTeamsOverview" class="button-outline" aria-label="Mois suivant">
                        <span class="icon">▶</span>
                    </button>
                    <button id="jumpToCurrentMonthTeamsOverview" class="button-outline" title="Aller au mois actuel (Juin-Sept 2025)">
                        <span class="icon">🎯</span> Actuel
                    </button>
                </div>
            </div>
             <div class="calendar-controls team-status-filters">
                <label for="filterCcfStatus">Filtre CCF4MHP37:</label>
                <select id="filterCcfStatus">
                    <option value="all">Tous statuts</option>
                    <option value="complete">Complet</option>
                    <option value="partial">Partiel (Manquements)</option>
                    <option value="missing-conducteurPL">Manque Cond. PL</option>
                    <option value="missing-chefAgres">Manque Chef Agrès</option>
                    <option value="missing-equipierFDF-1">Manque 1 Équipier</option>
                    <option value="missing-equipierFDF-2-plus">Manque 2+ Équipiers</option>
                    <option value="empty">Vide</option>
                </select>
                <label for="filterMprStatus">Filtre MPR12:</label>
                <select id="filterMprStatus">
                    <option value="all">Tous statuts</option>
                    <option value="complete">Complet</option>
                    <option value="partial">Partiel (Manquements)</option>
                    <option value="missing-conducteurVL">Manque Cond. VL</option>
                    <option value="missing-equipierDIV">Manque Équipier DIV</option>
                    <option value="empty">Vide</option>
                </select>
            </div>
            <div class="calendar-grid" id="teamsOverviewCalendarGrid"></div>
            
            <div class="legend-container">
                <div class="legend-group">
                    <h4>Légende CCF4MHP37</h4>
                    <div class="legend">
                        <div class="legend-item"><span class="legend-color" style="background-color: var(--team-ccf-complete);"></span><span>Complet</span></div>
                        <div class="legend-item"><span class="legend-color" style="background-color: var(--team-ccf-missing-conducteurPL);"></span><span>Manque Conducteur PL</span></div>
                        <div class="legend-item"><span class="legend-color" style="background-color: var(--team-ccf-missing-chefAgres);"></span><span>Manque Chef d'Agrès</span></div>
                        <div class="legend-item"><span class="legend-color" style="background-color: var(--team-ccf-missing-equipierFDF-1);"></span><span>Manque 1 Équipier FDF</span></div>
                        <div class="legend-item"><span class="legend-color" style="background-color: var(--team-ccf-missing-equipierFDF-2-plus);"></span><span>Manque 2+ Équipiers FDF</span></div>
                        <div class="legend-item"><span class="legend-color" style="background-color: var(--team-ccf-empty);"></span><span>Vide / Non formé</span></div>
                    </div>
                </div>
                <div class="legend-group">
                    <h4>Légende MPR12</h4>
                    <div class="legend">
                        <div class="legend-item"><span class="legend-color" style="background-color: var(--team-mpr-complete);"></span><span>Complet</span></div>
                        <div class="legend-item"><span class="legend-color" style="background-color: var(--team-mpr-missing-conducteurVL);"></span><span>Manque Conducteur VL</span></div>
                        <div class="legend-item"><span class="legend-color" style="background-color: var(--team-mpr-missing-equipierDIV);"></span><span>Manque Équipier DIV</span></div>
                        <div class="legend-item"><span class="legend-color" style="background-color: var(--team-mpr-empty);"></span><span>Vide / Non formé</span></div>
                    </div>
                </div>
                 <div class="legend-group" style="flex-basis: 100%; margin-top:1rem;"> <h4>Légende Commune</h4>
                     <div class="legend">
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: var(--warning-color); border: 1px solid var(--text-color);"></span>
                            <span>Jour d'affectation (si personnel recherché)</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <p style="margin-top: 1rem; font-style: italic; color: var(--text-light);">
                Cliquez sur un jour dans le calendrier pour ouvrir une fenêtre avec la composition détaillée et la modifier.
                Les étiquettes dans les cases (ex: "Manque CPL") indiquent la principale fonction manquante.
            </p>

            <hr style="margin: 2rem 0;">

            <h3>Détail Composition pour le Jour Sélectionné</h3>
            <div class="calendar-controls">
                <label for="teamsDateSelectDetail">Voir équipes pour le:</label>
                <input type="date" id="teamsDateSelectDetail">
                <button id="generateTeamsForDayDetailBtn" class="button-secondary">
                    <span class="icon">🔍</span> Afficher Détail
                </button>
            </div>
            
            <div id="teamsActionsBottom" style="margin-top: 1.5rem; display: flex; flex-wrap:wrap; gap: 1rem;">
                <button id="exportCSV" class="button-secondary">
                    <span class="icon">📁</span> Exporter Planning Mois (CSV)
                </button>
                <button id="printPlanning" class="button-secondary">
                    <span class="icon">🖨️</span> Imprimer Détail Jour (via Modale)
                </button>
                 <button id="exportTeamsCalendarPDF" class="button-secondary">
                    <span class="icon">📄</span> Exporter Calendrier Mois (PDF)
                </button>
            </div>

            <div id="teamsDeficiencySummary">
                <h3>Résumé des Manquements (Mois en cours)</h3>
                <div id="ccfDeficiencySummary" class="deficiency-category">
                    <h4>CCF4MHP37</h4>
                    <ul class="deficiency-list"></ul>
                </div>
                <div id="mprDeficiencySummary" class="deficiency-category">
                    <h4>MPR12</h4>
                    <ul class="deficiency-list"></ul>
                </div>
                <p style="font-size:0.85em; color: var(--text-light); margin-top:1em;">Ce résumé est basé sur la génération automatique ou les affectations manuelles enregistrées des équipes. Les modifications manuelles temporaires dans la modale (non enregistrées via "Sauvegarder Manuellement") ne sont pas reflétées ici.</p>
            </div>
        </section>

        <section id="statistiques" class="content-section">
            <h2>Statistiques Générales</h2>
            <div id="statsContainer">
                <div class="stats-grid">
                    <div class="stats-card">
                        <h4><span class="icon">👥</span> Personnel</h4>
                        <div class="stats-highlight" id="statsTotalPersonnel">0</div>
                        <div class="stats-highlight-label">Personnels enregistrés</div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="stats-card">
                        <h4><span class="icon">📅</span> Disponibilités</h4>
                        <div class="stats-highlight" id="statsTotalDispo">0</div>
                        <div class="stats-highlight-label">Jours de disponibilité cumulés (tous mois)</div>
                        <div class="mini-chart" id="dispoMiniChart"></div>
                    </div>
                    
                    <div class="stats-card">
                        <h4><span class="icon">🔄</span> Polyvalence</h4>
                        <div class="stats-highlight" id="statsMultiRole">0%</div>
                        <div class="stats-highlight-label">Personnels multi-rôles</div>
                        <div class="stats-role-distribution" id="roleDistribution"></div>
                    </div>
                </div>
                
                <div class="stats-card" style="margin-top: 1.5rem; grid-column: 1 / -1;">
                    <h4><span class="icon">📊</span> Synthèse des Qualifications (Total Personnel)</h4>
                    <table class="stats-summary-table">
                        <thead>
                            <tr>
                                <th>Rôle</th>
                                <th>Nombre</th>
                                <th>% du total</th>
                            </tr>
                        </thead>
                        <tbody id="statsRoleDetails">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <h3>Statistiques Détaillées Mensuelles / Globales</h3>
             <div class="calendar-controls">
                <label for="statsMonthSelect">Mois :</label>
                <select id="statsMonthSelect"></select>
                <button id="calculateMonthlyStatsBtn" class="button-secondary">
                    <span class="icon">📊</span> Calculer Stats du Mois
                </button>
                 <button id="calculateGlobalJuneSeptStatsBtn" class="button-secondary">
                    <span class="icon">🌍</span> Stats Globales (Juin-Sept)
                </button>
            </div>
            
            <div id="monthlyStatsContainer"> <div class="stats-grid"> <div class="stats-card">
                        <h4><span class="icon">🔥</span> CCF4MHP37 (Période sélectionnée)</h4>
                        <div class="stats-comparison">
                            <div class="stats-comparison-item">
                                <div class="stats-comparison-value" id="giffFullDays">0</div>
                                <div class="stats-comparison-label">Jours complets</div>
                            </div>
                            <div class="stats-comparison-item">
                                <div class="stats-comparison-value" id="giffPartialDays">0</div>
                                <div class="stats-comparison-label">Jours partiels</div>
                            </div>
                        </div>
                        <div class="mini-chart" id="giffMiniChart"></div>
                    </div>
                    
                    <div class="stats-card">
                        <h4><span class="icon">🚛</span> MPR12 (Période sélectionnée)</h4>
                        <div class="stats-comparison">
                            <div class="stats-comparison-item">
                                <div class="stats-comparison-value" id="mprFullDays">0</div>
                                <div class="stats-comparison-label">Jours complets</div>
                            </div>
                            <div class="stats-comparison-item">
                                <div class="stats-comparison-value" id="mprPartialDays">0</div>
                                <div class="stats-comparison-label">Jours partiels</div>
                            </div>
                        </div>
                        <div class="mini-chart" id="mprMiniChart"></div>
                    </div>
                    
                    <div class="stats-card">
                        <h4><span class="icon">✅</span> Couverture (CCF4MHP37 & MPR12)</h4>
                        <div class="stats-highlight" id="bothFullDays">0%</div>
                        <div class="stats-highlight-label">Jours avec les deux équipes complètes</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="bothFullProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card" style="margin-top: 1.5rem; grid-column: 1 / -1;"> 
                    <h4><span class="icon">👤</span> Contributions Individuelles (sur la période sélectionnée)</h4>
                    <div style="margin-bottom: 1rem; margin-top: 1rem;">
                        <label for="searchContributions" style="font-weight:500; margin-bottom:0.5rem; display:block;">Rechercher Contribution (Nom):</label>
                        <input type="search" id="searchContributions" placeholder="Entrez un nom pour filtrer les contributions..." style="width: 100%;">
                    </div>
                    <div id="personnelContributionListContainer"> <ul id="personnelContributionList" class="personnel-contribution-list">
                            <p>Sélectionnez un mois et cliquez sur "Calculer" pour voir les statistiques mensuelles, ou utilisez le bouton pour les statistiques globales.</p>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="notifications" class="notifications"></div>

    <div id="teamDetailModal" class="modal">
        <div class="modal-content">
            <span id="modalCloseBtn" class="modal-close-button">&times;</span>
            <div id="modalTeamDetailsContent"></div>
        </div>
    </div>

    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>Accès Administrateur</h3>
            <p>Veuillez entrer le mot de passe pour accéder aux fonctionnalités d'administration.</p>
            <form id="passwordForm">
                <div>
                    <label for="adminPassword">Mot de passe:</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <div class="form-actions" style="justify-content: center; margin-top: 1rem;">
                    <button type="submit" class="button-success">
                        <span class="icon">🔑</span> Valider
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Import des fonctions nécessaires
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, update, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Replace with your actual API key if you deploy this
            authDomain: "giff-mpr.firebaseapp.com",
            databaseURL: "https://giff-mpr-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "giff-mpr",
            storageBucket: "giff-mpr.appspot.com",
            messagingSenderId: "983742900416",
            appId: "1:983742900416:web:4d46fc557d56609ceaa525",
            measurementId: "G-W8YDSFGM51"
        };

        // Initialisation Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Variables globales
        let personnels = {};
        let disponibilités = {};
        let manualTeamAssignments = {}; 
        let dailyTeamAssignments = {}; 
        let availabilityDeadline = null; 
        let adminLoggedIn = false;
        const ADMIN_PASSWORD = "Aspf66220*";

        let currentCalendarDateAdminDispo = new Date(2025, 5, 1); 
        let currentCalendarDatePublicDispo = new Date(2025, 5, 1);
        let currentCalendarDateTeamsOverview = new Date(2025, 5, 1); 
        let selectedPersonnelIdForAdminCalendar = null; 
        let selectedPersonnelIdForPublicCalendar = null;
        let searchedPersonnelIdForTeamsCalendar = null; 

        const planningStartDate = new Date(2025, 5, 1); // 1er Juin 2025
        const planningEndDate = new Date(2025, 8, 30); // 30 Septembre 2025

        const DISPLAY_NAME_GIFF = "CCF4MHP37";
        const DISPLAY_NAME_MPR = "MPR12";

        const roleDefinitions = {
            conducteurPL: { name: `Conducteur Poids Lourd (${DISPLAY_NAME_GIFF})`, abbr: "CPL" },
            chefAgres:    { name: `Chef d'Agrès FDF (${DISPLAY_NAME_GIFF})`, abbr: "CA" },
            equipierFDF:  { name: `Équipier FDF (${DISPLAY_NAME_GIFF})`, abbr: "EQFDF" },
            conducteurVL: { name: `Conducteur Voiture (${DISPLAY_NAME_MPR})`, abbr: "CVL" },
            equipierDIV:  { name: `Équipier DIV (${DISPLAY_NAME_MPR})`, abbr: "EQDIV" }
        };
        function getRoleName(key, type = 'name') { 
            return roleDefinitions[key] ? roleDefinitions[key][type] : key;
        }


        const teamTypeConfigs = {
            giff: {
                name: DISPLAY_NAME_GIFF,
                roles: [ 
                    { key: 'conducteurPL', required: 1, label: getRoleName('conducteurPL', 'name'), short: getRoleName('conducteurPL', 'abbr'), priority: 1, colorVarName: 'team-ccf-missing-conducteurPL' },
                    { key: 'chefAgres',    required: 1, label: getRoleName('chefAgres', 'name'),    short: getRoleName('chefAgres', 'abbr'),    priority: 2, colorVarName: 'team-ccf-missing-chefAgres' },
                    { key: 'equipierFDF',  required: 2, label: getRoleName('equipierFDF', 'name'),  short: getRoleName('equipierFDF', 'abbr'),  priority: 3 } 
                ],
                colorCompleteVarName: 'team-ccf-complete',
                colorEmptyVarName: 'team-ccf-empty',
                textOnPartialVarName: 'team-ccf-text-on-partial',
                textOnColoredVarName: 'team-ccf-text-on-colored',
                cssClassPrefix: 'team-ccf'
            },
            mpr: {
                name: DISPLAY_NAME_MPR,
                roles: [ 
                    { key: 'conducteurVL', required: 1, label: getRoleName('conducteurVL', 'name'), short: getRoleName('conducteurVL', 'abbr'), priority: 1, colorVarName: 'team-mpr-missing-conducteurVL' },
                    { key: 'equipierDIV',  required: 1, label: getRoleName('equipierDIV', 'name'),  short: getRoleName('equipierDIV', 'abbr'),  priority: 2, colorVarName: 'team-mpr-missing-equipierDIV' }
                ],
                colorCompleteVarName: 'team-mpr-complete',
                colorEmptyVarName: 'team-mpr-empty',
                textOnPartialVarName: 'team-mpr-text-on-partial',
                textOnColoredVarName: 'team-mpr-text-on-colored',
                cssClassPrefix: 'team-mpr'
            }
        };


        let currentModalGiffTeam = [];
        let currentModalMprTeam = [];
        let currentModalDateStr = null;

        // --- DOM Elements ---
        const navLinks = document.querySelectorAll('nav ul li a');
        const contentSections = document.querySelectorAll('.content-section');
        const adminNavItems = document.querySelectorAll('.admin-nav-item');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const passwordModal = document.getElementById('passwordModal');
        const passwordForm = document.getElementById('passwordForm');
        const adminPasswordInput = document.getElementById('adminPassword');
        
        // Public Availability Calendar Elements
        const personnelInputForPublicCalendar = document.getElementById('personnelInputForPublicCalendar');
        const personnelDataListForPublicCalendar = document.getElementById('personnelDataListForPublicCalendar');
        const calendarGridPublicDispo = document.getElementById('calendarGridPublicDispo');
        const currentMonthYearPublicDispoDisplay = document.getElementById('currentMonthYearPublicDispo');
        const prevMonthBtnPublicDispo = document.getElementById('prevMonthBtnPublicDispo');
        const nextMonthBtnPublicDispo = document.getElementById('nextMonthBtnPublicDispo');
        const jumpToCurrentMonthPublicDispoBtn = document.getElementById('jumpToCurrentMonthPublicDispo');
        const publicDeadlineDisplay = document.getElementById('publicDeadlineDisplay');

        // Admin Availability Calendar Elements (renamed from original 'calendrier' to 'calendrier-admin')
        const personnelInputForAdminCalendar = document.getElementById('personnelInputForCalendar'); // This ID was kept from original
        const personnelDataListForAdminCalendar = document.getElementById('personnelDataListForCalendar'); // This ID was kept
        const calendarGridAdminDispo = document.getElementById('calendarGridAdminDispo');
        const currentMonthYearAdminDispoDisplay = document.getElementById('currentMonthYearAdminDispo');
        const prevMonthBtnAdminDispo = document.getElementById('prevMonthBtnAdminDispo');
        const nextMonthBtnAdminDispo = document.getElementById('nextMonthBtnAdminDispo');
        const jumpToCurrentMonthAdminDispoBtn = document.getElementById('jumpToCurrentMonthAdminDispo');

        // Admin Deadline Elements
        const availabilityDeadlineInput = document.getElementById('availabilityDeadline');
        const setAvailabilityDeadlineBtn = document.getElementById('setAvailabilityDeadlineBtn');


        // --- Admin Login Logic ---
        adminLoginBtn.addEventListener('click', () => {
            if (adminLoggedIn) { // Logout
                adminLoggedIn = false;
                adminLoginBtn.innerHTML = '<span class="icon">🔑</span> Admin Login';
                adminNavItems.forEach(item => item.style.display = 'none');
                // Switch to public tab if an admin tab was active
                const activeAdminSection = document.querySelector('.content-section.active.admin-section');
                if (activeAdminSection) {
                    document.querySelector('a[href="#mes-disponibilites"]').click();
                }
                showNotification("Déconnexion administrateur réussie.");
            } else { // Show login modal
                passwordModal.style.display = 'block';
                adminPasswordInput.focus();
            }
        });

        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                adminLoggedIn = true;
                passwordModal.style.display = 'none';
                adminPasswordInput.value = '';
                adminLoginBtn.innerHTML = '<span class="icon">🚪</span> Admin Logout';
                adminNavItems.forEach(item => item.style.display = 'list-item'); // Show admin nav items
                // Optionally, switch to the first admin tab (e.g., Gestion Personnels)
                const personnelAdminLink = document.querySelector('a[href="#personnel"]');
                if(personnelAdminLink) personnelAdminLink.click();
                showNotification("Connexion administrateur réussie.");
            } else {
                showNotification("Mot de passe incorrect.", 3000);
                adminPasswordInput.value = '';
            }
        });
         // Close password modal if clicked outside content
        passwordModal.addEventListener('click', (event) => {
            if (event.target === passwordModal) {
                passwordModal.style.display = "none";
            }
        });


        // --- Navigation SPA ---
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetHref = link.getAttribute('href');
                const targetSection = document.querySelector(targetHref);

                // Check if trying to access admin section without login
                if (targetSection.classList.contains('admin-section') && !adminLoggedIn) {
                    showNotification("Veuillez vous connecter en tant qu'administrateur.", 3000);
                    passwordModal.style.display = 'block'; // Show login prompt
                    return;
                }

                navLinks.forEach(l => l.classList.remove('active'));
                contentSections.forEach(s => s.classList.remove('active'));
                
                link.classList.add('active');
                targetSection.classList.add('active');
                window.scrollTo({top: 0, behavior: 'smooth'});
                
                // Load content for the activated tab
                if (targetHref === '#mes-disponibilites') {
                    renderPublicAvailabilityCalendar();
                    populatePersonnelDatalistForPublicCalendar();
                    displayAvailabilityDeadline();
                } else if (adminLoggedIn) { // Only load admin content if logged in
                    if (targetHref === '#personnel'){
                        renderPersonnels(); 
                        populateSkillFilters();
                        loadAndDisplayAvailabilityDeadlineForAdmin();
                    } else if (targetHref === '#calendrier-admin') {
                        renderAdminCalendarDispo();
                        populatePersonnelDatalistForAdminCalendar();
                    } else if (targetHref === '#equipes') {
                        renderTeamsOverviewCalendar(); 
                        populatePersonnelDatalistForTeamsSearch();
                    } else if (targetHref === '#statistiques') {
                        updateStats(); 
                        const personnelContributionListDiv = document.getElementById('personnelContributionList');
                        if (personnelContributionListDiv) {
                             personnelContributionListDiv.innerHTML = "<p>Sélectionnez un mois et cliquez sur \"Calculer\" pour voir les statistiques mensuelles, ou utilisez le bouton pour les statistiques globales.</p>";
                        }
                    }
                }
            });
        });

        // --- Gestion du Thème ---
        const themeSwitcher = document.getElementById('themeSwitcher');
        themeSwitcher.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            localStorage.setItem('theme', currentTheme);
            showNotification(`Thème ${currentTheme === 'dark' ? 'Sombre' : 'Clair'} activé.`);
            
            if (document.querySelector('#mes-disponibilites.active')) renderPublicAvailabilityCalendar();
            if (adminLoggedIn) {
                if (document.querySelector('#calendrier-admin.active')) renderAdminCalendarDispo();
                if (document.querySelector('#equipes.active')) renderTeamsOverviewCalendar();
            }
        });

        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        }
        applyInitialTheme();

        // --- Notifications ---
        const notificationsDiv = document.getElementById('notifications');
        function showNotification(message, duration = 3000) {
            const notif = document.createElement('div');
            notif.className = 'notification-item'; 
            notif.textContent = message;
            
            notificationsDiv.innerHTML = ''; 
            notificationsDiv.appendChild(notif);

            notificationsDiv.style.position = 'fixed';
            notificationsDiv.style.bottom = '20px';
            notificationsDiv.style.right = '20px';
            notificationsDiv.style.backgroundColor = 'var(--primary-color)';
            notificationsDiv.style.color = 'white';
            notificationsDiv.style.padding = '1rem';
            notificationsDiv.style.borderRadius = 'var(--button-radius)';
            notificationsDiv.style.boxShadow = 'var(--card-shadow)';
            notificationsDiv.style.zIndex = '2000';
            notificationsDiv.style.opacity = '1';
            notificationsDiv.style.transition = 'opacity 0.5s ease-in-out';

            setTimeout(() => {
                notificationsDiv.style.opacity = '0';
                 setTimeout(() => { notificationsDiv.innerHTML = ''; }, 500); 
            }, duration);
        }


        // --- Gestion des Personnels (Admin) ---
        const personnelForm = document.getElementById('personnelForm');
        const personnelTableBody = document.getElementById('personnelTableBody');
        // Admin calendar personnel input already defined as personnelInputForAdminCalendar
        // Admin calendar datalist already defined as personnelDataListForAdminCalendar
        const searchPersonnelInput = document.getElementById('searchPersonnel'); 
        const clearPersonnelFormBtn = document.getElementById('clearPersonnelForm');
        const resetAllAvailabilitiesBtn = document.getElementById('resetAllAvailabilitiesBtn');
        const searchPersonnelInTeamsInput = document.getElementById('searchPersonnelInTeams');
        const personnelDataListForTeamsSearch = document.getElementById('personnelDataListForTeamsSearch');
        const skillFilterContainer = document.getElementById('skillFilterContainer');


        let allPersonnelForAdminCalendarOptions = []; // For admin calendar
        let allPersonnelForPublicCalendarOptions = []; // For public calendar

        personnelForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!adminLoggedIn) {
                showNotification("Accès refusé. Veuillez vous connecter.", 3000);
                return;
            }
            const id = document.getElementById('personnelId').value;
            const nom = document.getElementById('nom').value.trim();
            
            if (!nom) {
                showNotification("Le nom du personnel est requis.", 3000);
                return;
            }
            
            const fonctions = {
                conducteurPL: document.getElementById('fctConducteurPL').checked,
                chefAgres: document.getElementById('fctChefAgres').checked,
                equipierFDF: document.getElementById('fctEquipierFDF').checked,
                conducteurVL: document.getElementById('fctConducteurVL').checked,
                equipierDIV: document.getElementById('fctEquipierDIV').checked,
            };
            
            const notes = document.getElementById('notes').value;
            const assignments = (id && personnels[id] && personnels[id].assignments) 
                                ? personnels[id].assignments 
                                : { giff: 0, mpr: 0, total: 0 }; 

            const personnelData = { nom, fonctions, notes, assignments };

            try {
                if (id) { 
                    await update(ref(database, `personnels/${id}`), personnelData);
                    showNotification('Personnel modifié avec succès.');
                } else { 
                    const newPersonnelRef = push(ref(database, 'personnels'));
                    await set(newPersonnelRef, personnelData);
                    showNotification('Personnel ajouté avec succès.');
                }
                personnelForm.reset();
                document.getElementById('personnelId').value = '';
            } catch (error) {
                console.error("Erreur sauvegarde personnel:", error);
                showNotification("Erreur lors de la sauvegarde du personnel.", 5000);
            }
        });

        clearPersonnelFormBtn.addEventListener('click', () => {
            personnelForm.reset();
            document.getElementById('personnelId').value = '';
        });
        
        resetAllAvailabilitiesBtn.addEventListener('click', async () => {
            if (!adminLoggedIn) return;
            if (confirm("Êtes-vous sûr de vouloir supprimer TOUTES les disponibilités pour TOUS les personnels ?\nCette action est IRRÉVERSIBLE.")) {
                if (confirm("SECONDE CONFIRMATION : Toutes les données de disponibilité seront effacées. Continuer ?")) {
                    try {
                        await remove(ref(database, 'disponibilites'));
                        disponibilités = {}; // Clear local cache
                        dailyTeamAssignments = {}; // Clear team cache
                        manualTeamAssignments = {}; // Clear manual assignments from Firebase (important)
                        await remove(ref(database, 'manualTeamAssignments')); 

                        showNotification("Toutes les disponibilités et affectations manuelles ont été réinitialisées.", 5000);
                        // Re-render relevant views
                        if (document.querySelector('#calendrier-admin.active')) renderAdminCalendarDispo();
                        if (document.querySelector('#mes-disponibilites.active')) renderPublicAvailabilityCalendar();
                        if (document.querySelector('#equipes.active')) renderTeamsOverviewCalendar();
                        if (document.querySelector('#personnel.active')) renderPersonnels(); // To update dispo counts in table
                        updateStats();
                    } catch (error) {
                        console.error("Erreur lors de la réinitialisation des disponibilités:", error);
                        showNotification("Erreur lors de la réinitialisation des disponibilités.", 5000);
                    }
                } else {
                    showNotification("Réinitialisation annulée.");
                }
            } else {
                showNotification("Réinitialisation annulée.");
            }
        });

        function populateSkillFilters() {
            skillFilterContainer.innerHTML = '';
            Object.keys(roleDefinitions).forEach(key => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `filterSkill_${key}`;
                checkbox.value = key;
                checkbox.addEventListener('change', () => renderPersonnels());

                const label = document.createElement('label');
                label.htmlFor = `filterSkill_${key}`;
                label.textContent = getRoleName(key, 'abbr'); // Utiliser abbréviation pour concision
                label.prepend(checkbox); // Add checkbox inside label for better click handling
                skillFilterContainer.appendChild(label);
            });
        }

        // Populate datalist for Admin Calendar
        function populatePersonnelDatalistForAdminCalendar() {
            personnelDataListForAdminCalendar.innerHTML = ''; 
            allPersonnelForAdminCalendarOptions = [];
            const sortedPersonnel = Object.entries(personnels)
                .sort(([,a], [,b]) => a.nom.localeCompare(b.nom));

            for (const [id, p] of sortedPersonnel) {
                allPersonnelForAdminCalendarOptions.push({ value: id, text: p.nom, originalObject: p });
                const option = document.createElement('option');
                option.value = p.nom; 
                personnelDataListForAdminCalendar.appendChild(option);
            }
        }
        // Populate datalist for Public Calendar
        function populatePersonnelDatalistForPublicCalendar() {
            personnelDataListForPublicCalendar.innerHTML = '';
            allPersonnelForPublicCalendarOptions = [];
             const sortedPersonnel = Object.entries(personnels)
                .sort(([,a], [,b]) => a.nom.localeCompare(b.nom));

            for (const [id, p] of sortedPersonnel) {
                allPersonnelForPublicCalendarOptions.push({ value: id, text: p.nom, originalObject: p });
                const option = document.createElement('option');
                option.value = p.nom;
                personnelDataListForPublicCalendar.appendChild(option);
            }
        }


        function renderPersonnels() { // Primarily for admin "Gestion Personnels" tab
            if (!adminLoggedIn || !personnelTableBody.offsetParent) return;

            personnelTableBody.innerHTML = '';
            populatePersonnelDatalistForAdminCalendar(); // Update admin calendar dropdown
            populatePersonnelDatalistForPublicCalendar(); // Update public calendar dropdown
            populatePersonnelDatalistForTeamsSearch(); // Update teams search dropdown


            const searchTerm = searchPersonnelInput.value.toLowerCase().trim();
            const selectedSkills = Array.from(skillFilterContainer.querySelectorAll('input[type="checkbox"]:checked'))
                                        .map(cb => cb.value);

            let filteredPersonnelsToDisplayInTable = Object.entries(personnels).filter(([id, p]) => {
                const nameMatch = p.nom.toLowerCase().includes(searchTerm);
                const skillsMatch = selectedSkills.length === 0 || selectedSkills.every(skill => p.fonctions && p.fonctions[skill]);
                return nameMatch && skillsMatch;
            }).reduce((acc, [id, p]) => {
                acc[id] = p;
                return acc;
            }, {});


            if (Object.keys(filteredPersonnelsToDisplayInTable).length === 0 ) {
                 if (Object.keys(personnels).length === 0) {
                    personnelTableBody.innerHTML = '<tr><td colspan="5">Aucun personnel enregistré.</td></tr>';
                 } else {
                    personnelTableBody.innerHTML = '<tr><td colspan="5">Aucun personnel ne correspond à votre recherche/filtre.</td></tr>';
                 }
            } else {
                 const sortedPersonnelForTable = Object.entries(filteredPersonnelsToDisplayInTable)
                    .sort(([,a], [,b]) => a.nom.localeCompare(b.nom));

                for (const [id, p] of sortedPersonnelForTable) {
                    const tr = document.createElement('tr');
                    tr.dataset.id = id;

                    const fonctionsArray = Object.entries(p.fonctions || {})
                        .filter(([, value]) => value)
                        .map(([key]) => getRoleName(key, 'abbr'))
                        .join(', ');

                    let totalDispoCount = 0;
                    if (disponibilités[id]) {
                        totalDispoCount = Object.values(disponibilités[id]).filter(d => d === true).length;
                    }
                    const shortNotes = p.notes && p.notes.length > 30 ? p.notes.substring(0, 27) + "..." : (p.notes || '');

                    tr.innerHTML = `
                        <td>${p.nom}</td>
                        <td>${fonctionsArray || 'N/A'}</td>
                        <td title="${p.notes || ''}">${shortNotes}</td>
                        <td>${totalDispoCount}</td>
                        <td>
                            <button class="editPersonnelBtn button-secondary" aria-label="Modifier ${p.nom}" style="margin-right: 0.5rem;">
                                <span class="icon">✏️</span> Modif.
                            </button>
                            <button class="deletePersonnelBtn button-danger" aria-label="Supprimer ${p.nom}">
                                <span class="icon">🗑️</span> Suppr.
                            </button>
                        </td>
                    `;
                    personnelTableBody.appendChild(tr);
                }
            }


            document.querySelectorAll('.editPersonnelBtn').forEach(btn => {
                btn.addEventListener('click', (e) => loadPersonnelToForm(e.target.closest('tr').dataset.id));
            });
            document.querySelectorAll('.deletePersonnelBtn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if(!adminLoggedIn) return;
                    const id = e.target.closest('tr').dataset.id;
                    if (confirm(`Voulez-vous vraiment supprimer ${personnels[id]?.nom || 'ce personnel'} ? Cela supprimera aussi ses disponibilités et affectations manuelles.`)) {
                        try {
                            await remove(ref(database, `personnels/${id}`));
                            await remove(ref(database, `disponibilites/${id}`)); 
                             // Remove from manual assignments as well
                            for (const dateKey in manualTeamAssignments) {
                                if (manualTeamAssignments[dateKey]) {
                                    let changed = false;
                                    if(manualTeamAssignments[dateKey].giffTeam) {
                                        manualTeamAssignments[dateKey].giffTeam = manualTeamAssignments[dateKey].giffTeam.filter(p => p.id !== id);
                                        changed = true;
                                    }
                                    if(manualTeamAssignments[dateKey].mprTeam) {
                                        manualTeamAssignments[dateKey].mprTeam = manualTeamAssignments[dateKey].mprTeam.filter(p => p.id !== id);
                                        changed = true;
                                    }
                                    if(changed) {
                                         await set(ref(database, `manualTeamAssignments/${dateKey}`), manualTeamAssignments[dateKey]);
                                    }
                                }
                            }
                            showNotification('Personnel, ses disponibilités et affectations manuelles supprimés.');
                        } catch (error) {
                            console.error("Erreur suppression personnel:", error);
                            showNotification("Erreur lors de la suppression.", 5000);
                        }
                    }
                });
            });
            updateStats(); // update general stats after rendering personnel
        }


        function loadPersonnelToForm(id) { // For Admin
            if (!adminLoggedIn) return;
            const p = personnels[id];
            if (!p) return;
            
            document.getElementById('personnelId').value = id;
            document.getElementById('nom').value = p.nom;
            document.getElementById('notes').value = p.notes || '';

            document.getElementById('fctConducteurPL').checked = p.fonctions?.conducteurPL || false;
            document.getElementById('fctChefAgres').checked = p.fonctions?.chefAgres || false;
            document.getElementById('fctEquipierFDF').checked = p.fonctions?.equipierFDF || false;
            document.getElementById('fctConducteurVL').checked = p.fonctions?.conducteurVL || false;
            document.getElementById('fctEquipierDIV').checked = p.fonctions?.equipierDIV || false;

            // Switch to the personnel tab and focus
            const personnelTabLink = document.querySelector('a[href="#personnel"]');
            if (!personnelTabLink.classList.contains('active')) {
                 personnelTabLink.click();
            }
            setTimeout(() => document.getElementById('nom').focus(), 50); // Slight delay for tab switch
        }

        searchPersonnelInput.addEventListener('input', () => renderPersonnels()); 

        personnelInputForAdminCalendar.addEventListener('input', () => {
            if (!adminLoggedIn) return;
            const enteredName = personnelInputForAdminCalendar.value.trim();
            selectedPersonnelIdForAdminCalendar = null; 

            if (enteredName) {
                const foundPersonnel = allPersonnelForAdminCalendarOptions.find(
                    opt => opt.text.toLowerCase() === enteredName.toLowerCase()
                );
                if (foundPersonnel) {
                    selectedPersonnelIdForAdminCalendar = foundPersonnel.value; 
                }
            }
            renderAdminCalendarDispo(); 
        });
        
        // Listener for Public Calendar Personnel Input
        personnelInputForPublicCalendar.addEventListener('input', () => {
            const enteredName = personnelInputForPublicCalendar.value.trim();
            selectedPersonnelIdForPublicCalendar = null;

            if (enteredName) {
                const foundPersonnel = allPersonnelForPublicCalendarOptions.find(
                    opt => opt.text.toLowerCase() === enteredName.toLowerCase()
                );
                if (foundPersonnel) {
                    selectedPersonnelIdForPublicCalendar = foundPersonnel.value;
                }
            }
            renderPublicAvailabilityCalendar();
        });

        // --- Deadline Management (Admin) ---
        setAvailabilityDeadlineBtn.addEventListener('click', async () => {
            if (!adminLoggedIn) {
                showNotification("Accès refusé.", 3000);
                return;
            }
            const deadlineDate = availabilityDeadlineInput.value;
            if (!deadlineDate) {
                showNotification("Veuillez sélectionner une date limite.", 3000);
                return;
            }
            try {
                await set(ref(database, 'config/availabilityDeadline'), deadlineDate);
                availabilityDeadline = deadlineDate; // Update local cache
                showNotification(`Date limite de saisie des disponibilités mise à jour: ${new Date(deadlineDate + 'T00:00:00').toLocaleDateString('fr-FR')}.`);
                displayAvailabilityDeadline(); // Update display on public tab if it's visible
            } catch (error) {
                console.error("Erreur définition date limite:", error);
                showNotification("Erreur lors de la définition de la date limite.", 5000);
            }
        });

        async function loadAndDisplayAvailabilityDeadlineForAdmin() {
            if (!adminLoggedIn) return;
            try {
                const snapshot = await get(ref(database, 'config/availabilityDeadline'));
                if (snapshot.exists()) {
                    availabilityDeadline = snapshot.val();
                    availabilityDeadlineInput.value = availabilityDeadline;
                } else {
                    availabilityDeadlineInput.value = ''; // No deadline set
                }
            } catch (error) {
                console.error("Erreur chargement date limite:", error);
            }
        }
        async function loadAvailabilityDeadlineForPublic() { // Separate loader for public section if needed without admin rights
            try {
                const snapshot = await get(ref(database, 'config/availabilityDeadline'));
                if (snapshot.exists()) {
                    availabilityDeadline = snapshot.val();
                } else {
                    availabilityDeadline = null;
                }
                displayAvailabilityDeadline();
            } catch (error) {
                console.error("Erreur chargement date limite (public):", error);
                availabilityDeadline = null; // Assume no deadline on error
                displayAvailabilityDeadline();
            }
        }


        function displayAvailabilityDeadline() { // For Public Tab
            if (publicDeadlineDisplay.offsetParent) { // Only update if the public tab is active/visible
                if (availabilityDeadline) {
                    const deadlineDateObj = new Date(availabilityDeadline + "T23:59:59"); // Consider end of day
                    publicDeadlineDisplay.textContent = `Date limite pour entrer vos disponibilités : ${deadlineDateObj.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
                    publicDeadlineDisplay.style.display = 'block';
                } else {
                    publicDeadlineDisplay.style.display = 'none';
                }
            }
        }


        // --- Gestion du Calendrier et Disponibilités (ADMIN) ---
        async function renderAdminCalendarDispo() { // Renamed from renderCalendarDispo
            if (!adminLoggedIn || !calendarGridAdminDispo || !calendarGridAdminDispo.offsetParent) return; 
            calendarGridAdminDispo.innerHTML = '';
            
            const year = currentCalendarDateAdminDispo.getFullYear();
            const month = currentCalendarDateAdminDispo.getMonth();
            currentMonthYearAdminDispoDisplay.textContent = `${new Intl.DateTimeFormat('fr-FR', { month: 'long', year: 'numeric' }).format(currentCalendarDateAdminDispo)}`;

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            let startingDay = firstDayOfMonth.getDay(); 
            startingDay = (startingDay === 0) ? 6 : startingDay - 1; 

            const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            dayNames.forEach(name => {
                const dayHeader = document.createElement('div');
                dayHeader.classList.add('calendar-day', 'header');
                dayHeader.textContent = name;
                calendarGridAdminDispo.appendChild(dayHeader);
            });

            for (let i = 0; i < startingDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('calendar-day', 'other-month');
                calendarGridAdminDispo.appendChild(emptyCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day');
                const dayNumberSpan = document.createElement('span');
                dayNumberSpan.classList.add('day-number');
                dayNumberSpan.textContent = day;
                dayCell.appendChild(dayNumberSpan);

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayCell.dataset.date = dateStr;

                const currentPersonnelId = selectedPersonnelIdForAdminCalendar; 
                if (currentPersonnelId && disponibilités[currentPersonnelId]?.[dateStr]) {
                    dayCell.classList.add('available');
                }
                if (searchedPersonnelIdForTeamsCalendar && dailyTeamAssignments[dateStr]) {
                    const { giffTeam, mprTeam } = dailyTeamAssignments[dateStr];
                    if ((giffTeam && giffTeam.some(p => p.id === searchedPersonnelIdForTeamsCalendar)) || (mprTeam && mprTeam.some(p => p.id === searchedPersonnelIdForTeamsCalendar))) {
                        dayCell.classList.add('personnel-assigned-highlight');
                    }
                }


                dayCell.addEventListener('click', () => toggleAdminDisponibilite(dateStr));
                calendarGridAdminDispo.appendChild(dayCell);
            }
            
            await colorizeAdminCalendarDispoDatesBasedOnTeamFormationStatus();
        }

        async function toggleAdminDisponibilite(dateStr) { // Renamed from toggleDisponibilite
            if (!adminLoggedIn) return;
            const personnelId = selectedPersonnelIdForAdminCalendar;
            if (!personnelId) {
                const typedName = personnelInputForAdminCalendar.value.trim();
                if(typedName) {
                    showNotification(`Personnel "${typedName}" non trouvé. Veuillez sélectionner un nom valide dans la liste.`, 3500);
                } else {
                    showNotification("Veuillez rechercher et sélectionner un personnel.", 3000);
                }
                return;
            }

             const selectedDate = new Date(dateStr + "T00:00:00"); 
             if (selectedDate < planningStartDate || selectedDate > planningEndDate) {
                 const options = { year: 'numeric', month: 'long', day: 'numeric' };
                 showNotification(`Disponibilités hors période (${planningStartDate.toLocaleDateString('fr-FR', options)} - ${planningEndDate.toLocaleDateString('fr-FR', options)}).`, 4000);
                 return;
             }


            const currentStatus = disponibilités[personnelId]?.[dateStr] || false;
            const newStatus = !currentStatus;

            try {
                await set(ref(database, `disponibilites/${personnelId}/${dateStr}`), newStatus);
                showNotification(`Disponibilité ${newStatus ? 'ajoutée' : 'supprimée'} pour ${personnels[personnelId].nom} le ${dateStr}.`);
                // No need to call renderAdminCalendarDispo, onValue for `disponibilites` will handle it.
            } catch (error) {
                console.error("Erreur màj disponibilité (admin):", error);
                showNotification("Erreur lors de la mise à jour de la disponibilité.", 5000);
            }
        }

        async function colorizeAdminCalendarDispoDatesBasedOnTeamFormationStatus() { // Renamed
             if (!adminLoggedIn || !calendarGridAdminDispo || !calendarGridAdminDispo.offsetParent) return;
            const year = currentCalendarDateAdminDispo.getFullYear();
            const month = currentCalendarDateAdminDispo.getMonth();

            for (let day = 1; day <= 31; day++) { 
                const date = new Date(year, month, day);
                if (date.getMonth() !== month) continue; 

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayCell = calendarGridAdminDispo.querySelector(`.calendar-day[data-date="${dateStr}"]`);
                if (!dayCell) continue;

                dayCell.classList.remove('status-day-full', 'status-day-partial');

                if (!dayCell.classList.contains('available') && !dayCell.classList.contains('personnel-assigned-highlight')) { // Only color if not already green (available) or yellow (assigned)
                    const teamData = await generateAndCacheTeamsForDate(dateStr, false); // Use the caching version
                    const giffStatus = teamData.giffStatusDetails.status;
                    const mprStatus = teamData.mprStatusDetails.status;

                    if (giffStatus === 'complete' && mprStatus === 'complete') {
                        dayCell.classList.add('status-day-full');
                    } else if (giffStatus === 'complete' || mprStatus === 'complete') {
                        dayCell.classList.add('status-day-partial');
                    }
                }
            }
        }


        prevMonthBtnAdminDispo.addEventListener('click', () => {
            if (!adminLoggedIn) return;
            currentCalendarDateAdminDispo.setMonth(currentCalendarDateAdminDispo.getMonth() - 1);
            renderAdminCalendarDispo();
        });
        
        nextMonthBtnAdminDispo.addEventListener('click', () => {
            if (!adminLoggedIn) return;
            currentCalendarDateAdminDispo.setMonth(currentCalendarDateAdminDispo.getMonth() + 1);
            renderAdminCalendarDispo();
        });
        jumpToCurrentMonthAdminDispoBtn.addEventListener('click', () => {
            if (!adminLoggedIn) return;
            const today = new Date();
            currentCalendarDateAdminDispo = new Date(Math.max(planningStartDate, Math.min(today, planningEndDate)));
            currentCalendarDateAdminDispo.setDate(1); // Start of the month
            renderAdminCalendarDispo();
        });


        // --- Gestion du Calendrier et Disponibilités (PUBLIC) ---
        async function renderPublicAvailabilityCalendar() {
            if (!calendarGridPublicDispo || !calendarGridPublicDispo.offsetParent) return;
            calendarGridPublicDispo.innerHTML = '';
            
            const year = currentCalendarDatePublicDispo.getFullYear();
            const month = currentCalendarDatePublicDispo.getMonth();
            currentMonthYearPublicDispoDisplay.textContent = `${new Intl.DateTimeFormat('fr-FR', { month: 'long', year: 'numeric' }).format(currentCalendarDatePublicDispo)}`;

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            let startingDay = firstDayOfMonth.getDay();
            startingDay = (startingDay === 0) ? 6 : startingDay - 1;

            const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            dayNames.forEach(name => {
                const dayHeader = document.createElement('div');
                dayHeader.classList.add('calendar-day', 'header');
                dayHeader.textContent = name;
                calendarGridPublicDispo.appendChild(dayHeader);
            });

            for (let i = 0; i < startingDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('calendar-day', 'other-month');
                calendarGridPublicDispo.appendChild(emptyCell);
            }

            const todayForDeadlineCheck = new Date();
            todayForDeadlineCheck.setHours(0,0,0,0); // For comparing dates only
            const deadlineDateObj = availabilityDeadline ? new Date(availabilityDeadline + "T23:59:59") : null;


            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day');
                const dayNumberSpan = document.createElement('span');
                dayNumberSpan.classList.add('day-number');
                dayNumberSpan.textContent = day;
                dayCell.appendChild(dayNumberSpan);

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayCell.dataset.date = dateStr;
                const currentDateObj = new Date(dateStr + "T00:00:00");


                let isEditable = true;
                if (currentDateObj < todayForDeadlineCheck) isEditable = false; // Past date
                if (deadlineDateObj && currentDateObj > deadlineDateObj) isEditable = false; // After deadline
                if (currentDateObj < planningStartDate || currentDateObj > planningEndDate) isEditable = false; // Outside planning period

                if (!isEditable) {
                    dayCell.classList.add('disabled');
                }


                const currentPersonnelId = selectedPersonnelIdForPublicCalendar;
                if (currentPersonnelId && disponibilités[currentPersonnelId]?.[dateStr]) {
                    dayCell.classList.add('available');
                }

                if(isEditable) {
                    dayCell.addEventListener('click', () => togglePublicDisponibilite(dateStr));
                }
                calendarGridPublicDispo.appendChild(dayCell);
            }
        }

        async function togglePublicDisponibilite(dateStr) {
            const personnelId = selectedPersonnelIdForPublicCalendar;
            if (!personnelId) {
                const typedName = personnelInputForPublicCalendar.value.trim();
                if(typedName) {
                     showNotification(`Personnel "${typedName}" non trouvé. Veuillez sélectionner votre nom dans la liste.`, 3500);
                } else {
                    showNotification("Veuillez rechercher et sélectionner votre nom.", 3000);
                }
                return;
            }

            const currentDateObj = new Date(dateStr + "T00:00:00");
            const todayForDeadlineCheck = new Date();
            todayForDeadlineCheck.setHours(0,0,0,0);
            const deadlineDateObj = availabilityDeadline ? new Date(availabilityDeadline + "T23:59:59") : null;

            if (currentDateObj < todayForDeadlineCheck) {
                showNotification("Vous ne pouvez pas modifier les disponibilités pour une date passée.", 3000);
                return;
            }
            if (deadlineDateObj && currentDateObj > deadlineDateObj) {
                showNotification(`La date limite de saisie (${deadlineDateObj.toLocaleDateString('fr-FR')}) est dépassée.`, 3000);
                return;
            }
            if (currentDateObj < planningStartDate || currentDateObj > planningEndDate) {
                 const options = { year: 'numeric', month: 'long', day: 'numeric' };
                 showNotification(`Disponibilités hors période (${planningStartDate.toLocaleDateString('fr-FR', options)} - ${planningEndDate.toLocaleDateString('fr-FR', options)}).`, 4000);
                 return;
             }

            const currentStatus = disponibilités[personnelId]?.[dateStr] || false;
            const newStatus = !currentStatus;

            try {
                await set(ref(database, `disponibilites/${personnelId}/${dateStr}`), newStatus);
                showNotification(`Disponibilité ${newStatus ? 'ajoutée' : 'supprimée'} pour ${personnels[personnelId].nom} le ${dateStr}.`);
                // onValue will refresh the calendar
            } catch (error) {
                console.error("Erreur màj disponibilité (public):", error);
                showNotification("Erreur lors de la mise à jour de la disponibilité.", 5000);
            }
        }
        
        prevMonthBtnPublicDispo.addEventListener('click', () => {
            currentCalendarDatePublicDispo.setMonth(currentCalendarDatePublicDispo.getMonth() - 1);
            renderPublicAvailabilityCalendar();
        });
        nextMonthBtnPublicDispo.addEventListener('click', () => {
            currentCalendarDatePublicDispo.setMonth(currentCalendarDatePublicDispo.getMonth() + 1);
            renderPublicAvailabilityCalendar();
        });
        jumpToCurrentMonthPublicDispoBtn.addEventListener('click', () => {
            const today = new Date();
            currentCalendarDatePublicDispo = new Date(Math.max(planningStartDate, Math.min(today, planningEndDate)));
            currentCalendarDatePublicDispo.setDate(1); // Start of the month
            renderPublicAvailabilityCalendar();
        });


        // --- MODAL Management (Admin) ---
        const teamDetailModal = document.getElementById('teamDetailModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalTeamDetailsContent = document.getElementById('modalTeamDetailsContent');

        async function openTeamDetailModal(dateStr) {
            if (!adminLoggedIn || !dateStr) return;
            currentModalDateStr = dateStr;

            const teamData = await generateAndCacheTeamsForDate(dateStr, false); 
            
            currentModalGiffTeam = JSON.parse(JSON.stringify(teamData.giffTeam)); 
            currentModalMprTeam = JSON.parse(JSON.stringify(teamData.mprTeam)); 

            await displayTeamDetailsInModal(dateStr, teamData.giffStatusDetails, teamData.mprStatusDetails); 
            teamDetailModal.style.display = "block";
            document.body.style.overflow = 'hidden'; 
        }

        function closeTeamDetailModal() {
            teamDetailModal.style.display = "none";
            document.body.style.overflow = 'auto'; 
            modalTeamDetailsContent.innerHTML = ""; 
            currentModalGiffTeam = []; 
            currentModalMprTeam = [];
            currentModalDateStr = null;
            
            if (adminLoggedIn && document.querySelector('#equipes.active')) {
                renderTeamsOverviewCalendar(); // Refresh overview calendar after modal close
            }
        }

        modalCloseBtn.addEventListener('click', closeTeamDetailModal);
        window.addEventListener('click', (event) => { 
            if (event.target == teamDetailModal) {
                closeTeamDetailModal();
            }
        });


        // --- Vue d'Ensemble Mensuelle des Équipes (CALENDRIER - Admin) ---
        const teamsOverviewCalendarGrid = document.getElementById('teamsOverviewCalendarGrid');
        const currentMonthYearTeamsOverviewDisplay = document.getElementById('currentMonthYearTeamsOverview');
        const prevMonthBtnTeamsOverview = document.getElementById('prevMonthBtnTeamsOverview');
        const nextMonthBtnTeamsOverview = document.getElementById('nextMonthBtnTeamsOverview');
        const jumpToCurrentMonthTeamsOverviewBtn = document.getElementById('jumpToCurrentMonthTeamsOverview');
        const teamsDateSelectDetail = document.getElementById('teamsDateSelectDetail');
        const generateTeamsForDayDetailBtn = document.getElementById('generateTeamsForDayDetailBtn');
        const filterCcfStatusSelect = document.getElementById('filterCcfStatus');
        const filterMprStatusSelect = document.getElementById('filterMprStatus');


        function populatePersonnelDatalistForTeamsSearch() { // Admin
            personnelDataListForTeamsSearch.innerHTML = ''; // Clear previous options
            const sortedPersonnel = Object.values(personnels)
                .sort((a, b) => a.nom.localeCompare(b.nom));

            sortedPersonnel.forEach(p => {
                const option = document.createElement('option');
                option.value = p.nom;
                personnelDataListForTeamsSearch.appendChild(option);
            });
        }


        searchPersonnelInTeamsInput.addEventListener('input', () => { // Changed to input for more responsive search
            if (!adminLoggedIn) return;
            const searchTerm = searchPersonnelInTeamsInput.value.trim().toLowerCase();
            searchedPersonnelIdForTeamsCalendar = null; 
            if (searchTerm) {
                const found = Object.entries(personnels).find(([id, p]) => p.nom.toLowerCase().includes(searchTerm)); // More flexible search
                if (found) {
                    searchedPersonnelIdForTeamsCalendar = found[0];
                } else {
                    // No notification for not found during typing, only if explicitly submitted or blurred
                }
            }
            renderTeamsOverviewCalendar(); 
        });
        // Optional: Add 'change' or 'blur' listener if you want a notification for "not found" after user finishes typing.
        searchPersonnelInTeamsInput.addEventListener('change', () => {
            if (!adminLoggedIn) return;
             const searchTerm = searchPersonnelInTeamsInput.value.trim().toLowerCase();
             if (searchTerm && !searchedPersonnelIdForTeamsCalendar) { // If search term exists but no ID found
                const found = Object.entries(personnels).find(([id, p]) => p.nom.toLowerCase() === searchTerm); // Exact match for notification
                if (!found) {
                    showNotification(`Personnel "${searchPersonnelInTeamsInput.value}" non trouvé.`, 3000);
                } else {
                     searchedPersonnelIdForTeamsCalendar = found[0]; // Ensure it's set on exact match
                     renderTeamsOverviewCalendar();
                }
             } else if (!searchTerm) { // If search cleared
                searchedPersonnelIdForTeamsCalendar = null;
                renderTeamsOverviewCalendar();
             }
        });
        filterCcfStatusSelect.addEventListener('change', () => { if (adminLoggedIn) renderTeamsOverviewCalendar() });
        filterMprStatusSelect.addEventListener('change', () => { if (adminLoggedIn) renderTeamsOverviewCalendar() });


        async function renderTeamsOverviewCalendar() { // Admin
            if(!adminLoggedIn || !teamsOverviewCalendarGrid || !teamsOverviewCalendarGrid.offsetParent) return; 
            teamsOverviewCalendarGrid.innerHTML = '';
            
            const year = currentCalendarDateTeamsOverview.getFullYear();
            const month = currentCalendarDateTeamsOverview.getMonth();
            currentMonthYearTeamsOverviewDisplay.textContent = `${new Intl.DateTimeFormat('fr-FR', { month: 'long', year: 'numeric' }).format(currentCalendarDateTeamsOverview)}`;

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            let startingDay = firstDayOfMonth.getDay();
            startingDay = (startingDay === 0) ? 6 : startingDay - 1;

            const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            dayNames.forEach(name => {
                const dayHeader = document.createElement('div');
                dayHeader.classList.add('calendar-day', 'header');
                dayHeader.textContent = name;
                teamsOverviewCalendarGrid.appendChild(dayHeader);
            });

            for (let i = 0; i < startingDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('calendar-day', 'other-month');
                teamsOverviewCalendarGrid.appendChild(emptyCell);
            }
            
            const selectedCcfFilter = filterCcfStatusSelect.value;
            const selectedMprFilter = filterMprStatusSelect.value;


            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day'); 
                const dayNumberSpan = document.createElement('span');
                dayNumberSpan.classList.add('day-number');
                dayNumberSpan.textContent = day;
                dayCell.appendChild(dayNumberSpan);

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayCell.dataset.date = dateStr;

                const teamOverviewContent = document.createElement('div');
                teamOverviewContent.classList.add('team-overview-content');

                // GIFF Info Div
                const giffInfoDiv = document.createElement('div');
                giffInfoDiv.classList.add('team-info'); 
                const giffNameStrong = document.createElement('strong');
                giffNameStrong.textContent = DISPLAY_NAME_GIFF;
                const giffStatusLabel = document.createElement('span');
                giffStatusLabel.classList.add('team-status-label');
                giffInfoDiv.appendChild(giffNameStrong);
                giffInfoDiv.appendChild(giffStatusLabel);
                teamOverviewContent.appendChild(giffInfoDiv);

                // MPR Info Div
                const mprInfoDiv = document.createElement('div');
                mprInfoDiv.classList.add('team-info');
                const mprNameStrong = document.createElement('strong');
                mprNameStrong.textContent = DISPLAY_NAME_MPR;
                const mprStatusLabel = document.createElement('span');
                mprStatusLabel.classList.add('team-status-label');
                mprInfoDiv.appendChild(mprNameStrong);
                mprInfoDiv.appendChild(mprStatusLabel);
                teamOverviewContent.appendChild(mprInfoDiv);
                
                dayCell.appendChild(teamOverviewContent);

                (async () => {
                    const teamData = await generateAndCacheTeamsForDate(dateStr, false); 
                    const { giffTeam, mprTeam, giffStatusDetails, mprStatusDetails } = teamData;

                    // Apply GIFF status
                    giffInfoDiv.className = 'team-info'; // Reset classes
                    giffInfoDiv.classList.add(`${teamTypeConfigs.giff.cssClassPrefix}-${giffStatusDetails.status}`);
                    if (giffStatusDetails.primaryDeficiencyRole && giffStatusDetails.status === 'partial') {
                        let deficiencyClass = `${teamTypeConfigs.giff.cssClassPrefix}-missing-${giffStatusDetails.primaryDeficiencyRole}`;
                         // Special for equipierFDF
                        if (giffStatusDetails.primaryDeficiencyRole === 'equipierFDF') {
                            const equipiersNeeded = teamTypeConfigs.giff.roles.find(r => r.key === 'equipierFDF').required;
                            const equipiersHave = giffTeam.filter(p => p.assignedRole === 'equipierFDF').length;
                            const equipiersMissing = equipiersNeeded - equipiersHave;
                            if (equipiersMissing === 1) deficiencyClass = `${teamTypeConfigs.giff.cssClassPrefix}-missing-equipierFDF-1`;
                            else if (equipiersMissing >= 2) deficiencyClass = `${teamTypeConfigs.giff.cssClassPrefix}-missing-equipierFDF-2-plus`;
                        }
                         giffInfoDiv.classList.add(deficiencyClass);
                    }
                    giffStatusLabel.textContent = giffStatusDetails.shortLabel || giffStatusDetails.label; // Short label for cell
                    
                    const giffColorVar = giffStatusDetails.colorVarName || (giffStatusDetails.status === 'complete' ? teamTypeConfigs.giff.colorCompleteVarName : teamTypeConfigs.giff.colorEmptyVarName);
                    giffInfoDiv.style.backgroundColor = `var(--${giffColorVar})`;

                    const giffTextColorVar = (giffStatusDetails.status === 'partial' && (giffColorVar === 'team-ccf-missing-equipierFDF-1' || giffColorVar === 'team-ccf-missing-equipierFDF-2-plus'))
                        ? teamTypeConfigs.giff.textOnPartialVarName
                        : teamTypeConfigs.giff.textOnColoredVarName;
                    giffInfoDiv.style.color = `var(--${giffTextColorVar})`;


                    // Apply MPR status
                    mprInfoDiv.className = 'team-info'; // Reset classes
                    mprInfoDiv.classList.add(`${teamTypeConfigs.mpr.cssClassPrefix}-${mprStatusDetails.status}`);
                     if (mprStatusDetails.primaryDeficiencyRole && mprStatusDetails.status === 'partial') {
                        mprInfoDiv.classList.add(`${teamTypeConfigs.mpr.cssClassPrefix}-missing-${mprStatusDetails.primaryDeficiencyRole}`);
                    }
                    mprStatusLabel.textContent = mprStatusDetails.shortLabel || mprStatusDetails.label; // Short label
                    
                    const mprColorVar = mprStatusDetails.colorVarName || (mprStatusDetails.status === 'complete' ? teamTypeConfigs.mpr.colorCompleteVarName : teamTypeConfigs.mpr.colorEmptyVarName);
                    mprInfoDiv.style.backgroundColor = `var(--${mprColorVar})`;
                    
                    const mprTextColorVar = (mprStatusDetails.status === 'partial' && mprColorVar !== teamTypeConfigs.mpr.colorEmptyVarName && mprColorVar !== teamTypeConfigs.mpr.colorCompleteVarName) // If it's a specific deficiency color
                        ? teamTypeConfigs.mpr.textOnPartialVarName
                        : teamTypeConfigs.mpr.textOnColoredVarName;
                    mprInfoDiv.style.color = `var(--${mprTextColorVar})`;

                    // Apply filters
                    let ccfMatchesFilter = true;
                    if (selectedCcfFilter !== "all") {
                        if (selectedCcfFilter === "complete") ccfMatchesFilter = giffStatusDetails.status === "complete";
                        else if (selectedCcfFilter === "partial") ccfMatchesFilter = giffStatusDetails.status === "partial";
                        else if (selectedCcfFilter === "empty") ccfMatchesFilter = giffStatusDetails.status === "empty";
                        else if (selectedCcfFilter.startsWith("missing-")) {
                            const roleKey = selectedCcfFilter.split("missing-")[1].replace("-1", "").replace("-2-plus", "");
                            ccfMatchesFilter = giffStatusDetails.primaryDeficiencyRole === roleKey || (roleKey === 'equipierFDF' && giffStatusDetails.primaryDeficiencyRole === 'equipierFDF'); // Simplified check
                        }
                    }

                    let mprMatchesFilter = true;
                    if (selectedMprFilter !== "all") {
                        if (selectedMprFilter === "complete") mprMatchesFilter = mprStatusDetails.status === "complete";
                        else if (selectedMprFilter === "partial") mprMatchesFilter = mprStatusDetails.status === "partial";
                        else if (selectedMprFilter === "empty") mprMatchesFilter = mprStatusDetails.status === "empty";
                        else if (selectedMprFilter.startsWith("missing-")) {
                            const roleKey = selectedMprFilter.split("missing-")[1];
                            mprMatchesFilter = mprStatusDetails.primaryDeficiencyRole === roleKey;
                        }
                    }
                    
                    dayCell.classList.remove('dimmed-day');
                    giffInfoDiv.classList.remove('dimmed-team');
                    mprInfoDiv.classList.remove('dimmed-team');

                    if (!ccfMatchesFilter && !mprMatchesFilter) { // If neither matches, dim the whole day
                        dayCell.classList.add('dimmed-day');
                    } else {
                        if (!ccfMatchesFilter) giffInfoDiv.classList.add('dimmed-team');
                        if (!mprMatchesFilter) mprInfoDiv.classList.add('dimmed-team');
                    }


                    if (searchedPersonnelIdForTeamsCalendar) {
                        const isInGiff = giffTeam.some(p => p.id === searchedPersonnelIdForTeamsCalendar);
                        const isInMpr = mprTeam.some(p => p.id === searchedPersonnelIdForTeamsCalendar);
                        if (isInGiff || isInMpr) {
                            dayCell.classList.add('personnel-assigned-highlight');
                        } else {
                            dayCell.classList.remove('personnel-assigned-highlight');
                        }
                    } else {
                         dayCell.classList.remove('personnel-assigned-highlight');
                    }

                })();

                dayCell.addEventListener('click', () => {
                    openTeamDetailModal(dateStr);
                });
                teamsOverviewCalendarGrid.appendChild(dayCell);
            }
            updateTeamsDeficiencySummary(year, month); // Update the summary after rendering the calendar
        }


        prevMonthBtnTeamsOverview.addEventListener('click', () => {
            if (!adminLoggedIn) return;
            currentCalendarDateTeamsOverview.setMonth(currentCalendarDateTeamsOverview.getMonth() - 1);
            renderTeamsOverviewCalendar();
        });
        
        nextMonthBtnTeamsOverview.addEventListener('click', () => {
            if (!adminLoggedIn) return;
            currentCalendarDateTeamsOverview.setMonth(currentCalendarDateTeamsOverview.getMonth() + 1);
            renderTeamsOverviewCalendar();
        });
        jumpToCurrentMonthTeamsOverviewBtn.addEventListener('click', () => {
            if (!adminLoggedIn) return;
            const today = new Date();
            currentCalendarDateTeamsOverview = new Date(Math.max(planningStartDate, Math.min(today, planningEndDate)));
            currentCalendarDateTeamsOverview.setDate(1); // Start of the month
            renderTeamsOverviewCalendar();
        });


        generateTeamsForDayDetailBtn.addEventListener('click', () => {
            if (!adminLoggedIn) return;
            const selectedDate = teamsDateSelectDetail.value;
            if (selectedDate) {
                openTeamDetailModal(selectedDate);
            } else {
                showNotification("Veuillez sélectionner une date pour afficher le détail.", 3000);
            }
        });

        // --- Team Generation Logic with new status determination ---
        function getTeamDeficiencies(teamMembers, config) {
            let deficiencies = [];
            const actualRolesCount = {};
            config.roles.forEach(roleDef => actualRolesCount[roleDef.key] = 0);

            teamMembers.forEach(member => {
                if (member.assignedRole && actualRolesCount.hasOwnProperty(member.assignedRole)) {
                    actualRolesCount[member.assignedRole]++;
                }
            });

            let isComplete = true;
            if (teamMembers.length === 0) {
                return { status: 'empty', deficiencies: [], colorVarName: config.colorEmptyVarName, label: "Vide", shortLabel: "Vide" };
            }

            config.roles.forEach(roleDef => {
                if (actualRolesCount[roleDef.key] < roleDef.required) {
                    isComplete = false;
                    const needed = roleDef.required - actualRolesCount[roleDef.key];
                    for (let i = 0; i < needed; i++) {
                        deficiencies.push({ 
                            role: roleDef.key, 
                            label: roleDef.label, 
                            short: roleDef.short,
                            priority: roleDef.priority,
                            colorVarName: roleDef.colorVarName, 
                            count: needed // Store how many of this specific role are missing
                        });
                    }
                }
            });

            if (isComplete) {
                return { status: 'complete', deficiencies: [], colorVarName: config.colorCompleteVarName, label: "Complet", shortLabel: "OK" };
            }

            deficiencies.sort((a, b) => a.priority - b.priority); // Sort by priority (lower is higher)
            
            const primaryDeficiency = deficiencies[0];
            let primaryColorVarName = primaryDeficiency.colorVarName; 

            // Special handling for CCF EquipierFDF colors based on count
            if (config.name === DISPLAY_NAME_GIFF && primaryDeficiency.role === 'equipierFDF') {
                const equipiersMissing = deficiencies.filter(d => d.role === 'equipierFDF').length; // Total missing equipiers
                if (equipiersMissing === 1) {
                    primaryColorVarName = 'team-ccf-missing-equipierFDF-1';
                } else if (equipiersMissing >= 2) {
                    primaryColorVarName = 'team-ccf-missing-equipierFDF-2-plus';
                }
            }

            const deficiencyLabels = [];
            const uniqueDeficiencies = {};
            deficiencies.forEach(d => {
                if (!uniqueDeficiencies[d.role]) uniqueDeficiencies[d.role] = 0;
                uniqueDeficiencies[d.role]++;
            });

            let shortLabel = "";
            Object.entries(uniqueDeficiencies).forEach(([roleKey, count]) => {
                const roleConfig = config.roles.find(r => r.key === roleKey);
                deficiencyLabels.push(`${count} ${roleConfig.label}`);
                if (!shortLabel) shortLabel = `-${roleConfig.short}x${count}`; // Show first critical shortage
            });
            if (!shortLabel && deficiencies.length > 0) shortLabel = `-${deficiencies[0].short}`;


            return {
                status: 'partial',
                primaryDeficiencyRole: primaryDeficiency.role,
                deficiencies: deficiencies, // Full list of missing roles
                colorVarName: primaryColorVarName,
                label: `Manque: ${deficiencyLabels.join(', ')}`,
                shortLabel: shortLabel || "Partiel"
            };
        }


        function getPersonnelWithAssignmentScores(personnelList, teamTypeKey = 'total') {
            return personnelList.map(p => {
                let score = 0;
                const assignments = personnels[p.id]?.assignments; 
                if (assignments) {
                    if (teamTypeKey === 'giff') { 
                        score = assignments.giff || 0;
                    } else if (teamTypeKey === 'mpr') { 
                        score = assignments.mpr || 0;
                    } else { 
                        score = assignments.total || 0;
                    }
                }
                return { 
                    ...p, 
                    assignmentScore: score + (Math.random() * 0.01) // Add jitter for tie-breaking
                };
            }).sort((a, b) => a.assignmentScore - b.assignmentScore); 
        }

        async function generateAndCacheTeamsForDate(dateStr, showAlerts = true) {
            // Check for persistent manual assignment first
            if (manualTeamAssignments[dateStr]) {
                 // If manually set teams are found in persistent storage, use them directly.
                // Ensure they have the correct structure (giffTeam, mprTeam, giffStatusDetails, mprStatusDetails)
                const persistedData = manualTeamAssignments[dateStr];
                dailyTeamAssignments[dateStr] = {
                    ...persistedData, // Contains giffTeam, mprTeam
                    giffStatusDetails: getTeamDeficiencies(persistedData.giffTeam || [], teamTypeConfigs.giff),
                    mprStatusDetails: getTeamDeficiencies(persistedData.mprTeam || [], teamTypeConfigs.mpr),
                    manuallySet: true, // Indicate it's from manual override
                    forceRecalculate: false
                };
                return dailyTeamAssignments[dateStr];
            }


            // Check session cache next, but only if not flagged for recalculation (e.g., after a modal clear not yet saved)
            if (dailyTeamAssignments[dateStr] && !dailyTeamAssignments[dateStr].forceRecalculate) {
                return dailyTeamAssignments[dateStr];
            }

            let personnelDispoCeJourSource = [];
            for (const pId in disponibilités) {
                if (disponibilités[pId][dateStr] && personnels[pId]) { 
                    personnelDispoCeJourSource.push({ id: pId, ...personnels[pId] });
                }
            }

            // --- GIFF Team (CCF4MHP37) ---
            let giffTeam = [];
            let assignedToGiffRoles = new Set(); 
            const giffConfig = teamTypeConfigs.giff;
            let personnelPourGiff = getPersonnelWithAssignmentScores(personnelDispoCeJourSource, 'giff');

            giffConfig.roles.forEach(roleDef => {
                for (let k = 0; k < roleDef.required; k++) { // Attempt to fill all required slots for this role
                    let foundMember = false;
                    for (let i = 0; i < personnelPourGiff.length; i++) {
                        const p = personnelPourGiff[i];
                        if (p.fonctions[roleDef.key] && !assignedToGiffRoles.has(p.id)) {
                            giffTeam.push({ ...p, assignedRole: roleDef.key });
                            assignedToGiffRoles.add(p.id);
                            foundMember = true;
                            break; 
                        }
                    }
                    if (!foundMember && showAlerts && adminLoggedIn) { // Only show admin alerts
                        // console.warn(`Could not find enough ${roleDef.label} for ${giffConfig.name} on ${dateStr}`);
                    }
                }
            });

            // --- MPR Team (MPR12) ---
            let personnelRestantPourMPRSource = personnelDispoCeJourSource.filter(p => !assignedToGiffRoles.has(p.id));
            let personnelPourMpr = getPersonnelWithAssignmentScores(personnelRestantPourMPRSource, 'mpr');
            
            let mprTeam = [];
            let assignedToMprRoles = new Set(); 
            const mprConfig = teamTypeConfigs.mpr;

            mprConfig.roles.forEach(roleDef => {
                 for (let k = 0; k < roleDef.required; k++) {
                    let foundMember = false;
                    for (let i = 0; i < personnelPourMpr.length; i++) {
                        const p = personnelPourMpr[i];
                        if (p.fonctions[roleDef.key] && !assignedToMprRoles.has(p.id)) {
                            mprTeam.push({ ...p, assignedRole: roleDef.key });
                            assignedToMprRoles.add(p.id);
                            foundMember = true;
                            break; 
                        }
                    }
                    if (!foundMember && showAlerts && adminLoggedIn) { // Only show admin alerts
                        // console.warn(`Could not find enough ${roleDef.label} for ${mprConfig.name} on ${dateStr}`);
                    }
                }
            });
            
            const giffStatusDetails = getTeamDeficiencies(giffTeam, giffConfig);
            const mprStatusDetails = getTeamDeficiencies(mprTeam, mprConfig);

            if (showAlerts && adminLoggedIn) { // Only show admin alerts
                if (giffStatusDetails.status === 'partial') {
                     showNotification(`${giffConfig.name} incomplet le ${dateStr}: ${giffStatusDetails.label}.`, 2500);
                }
                if (mprStatusDetails.status === 'partial') {
                    showNotification(`${mprConfig.name} incomplet le ${dateStr}: ${mprStatusDetails.label}.`, 2500);
                }
            }
            
            const result = { 
                giffTeam, 
                mprTeam, 
                giffStatusDetails, 
                mprStatusDetails, 
                manuallySet: false, // Auto-generated, not manually set (unless loaded from persistent manual)
                forceRecalculate: false // Reset flag after calculation
            };
            dailyTeamAssignments[dateStr] = result; 
            return result;
        }


        async function displayTeamDetailsInModal(dateStr, giffStatusDetailsExt = null, mprStatusDetailsExt = null) { // Admin Modal
            if (!adminLoggedIn) return;
            const displayDiv = modalTeamDetailsContent;
            const formattedDate = new Date(dateStr+'T00:00:00').toLocaleDateString('fr-FR',{ weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // Use provided status details or fetch them if not provided (e.g., if opening modal directly from date picker)
            let giffStatusDetails = giffStatusDetailsExt;
            let mprStatusDetails = mprStatusDetailsExt;

            if (!giffStatusDetails || !mprStatusDetails) {
                const teamData = await generateAndCacheTeamsForDate(dateStr, false); // This now respects manual assignments
                giffStatusDetails = teamData.giffStatusDetails;
                mprStatusDetails = teamData.mprStatusDetails;
                // Update currentModal teams based on what was loaded/generated
                currentModalGiffTeam = JSON.parse(JSON.stringify(teamData.giffTeam));
                currentModalMprTeam = JSON.parse(JSON.stringify(teamData.mprTeam));
            }


            displayDiv.innerHTML = `
                <h3 id="modalDateHeader">
                    <span id="modalDateText">Équipes pour le ${formattedDate}</span>
                    <div class="modal-actions-top">
                         <button id="saveManualAssignmentBtn" title="Sauvegarder cette composition manuelle pour ce jour." class="button-success">
                            <span class="icon">💾</span> Sauvegarder Manuellement
                        </button>
                        <button id="clearDayBtnInModal" title="Vider les affectations pour cette journée (auto et manuelles) et supprimer les disponibilités Firebase des personnels concernés." class="button-danger">
                            <span class="icon">🗑️</span> Vider Journée (Affectations & Dispos)
                        </button>
                    </div>
                </h3>
            `;

            // Section GIFF (CCF4MHP37)
            const giffDiv = document.createElement('div');
            giffDiv.classList.add('team-day-container');
            let giffHtml = `<h4>${DISPLAY_NAME_GIFF}</h4>`;
            giffHtml += `<p class="team-status-modal" style="color: var(--${giffStatusDetails.colorVarName});">${giffStatusDetails.label}</p>`; // Use colorVarName
            
            giffHtml += '<ul>';
            currentModalGiffTeam.forEach((p, index) => {
                giffHtml += `<li>
                                <span>${p.nom} (${getRoleName(p.assignedRole, 'name') || 'N/A'})</span>
                                <span class="team-member-actions">
                                    <button class="replace-member-btn button-secondary" data-team-type="giff" data-member-index="${index}" data-member-id="${p.id}" data-assigned-role="${p.assignedRole}">
                                        <span class="icon">🔄</span> Remplacer
                                    </button>
                                </span>
                            </li>`;
            });
            giffHtml += '</ul>';
            giffDiv.innerHTML = giffHtml;
            displayDiv.appendChild(giffDiv);

            // Section MPR (MPR12)
            const mprDiv = document.createElement('div');
            mprDiv.classList.add('team-day-container');
            let mprHtml = `<h4>${DISPLAY_NAME_MPR}</h4>`;
            mprHtml += `<p class="team-status-modal" style="color: var(--${mprStatusDetails.colorVarName});">${mprStatusDetails.label}</p>`; // Use colorVarName
            
            mprHtml += '<ul>';
            currentModalMprTeam.forEach((p, index) => {
                mprHtml += `<li>
                                <span>${p.nom} (${getRoleName(p.assignedRole, 'name') || 'N/A'})</span>
                                <span class="team-member-actions">
                                     <button class="replace-member-btn button-secondary" data-team-type="mpr" data-member-index="${index}" data-member-id="${p.id}" data-assigned-role="${p.assignedRole}">
                                        <span class="icon">🔄</span> Remplacer
                                    </button>
                                </span>
                            </li>`;
            });
            mprHtml += '</ul>';
            mprDiv.innerHTML = mprHtml;
            displayDiv.appendChild(mprDiv);

            // Section Autres Personnels Disponibles
            const autresDispoDiv = document.createElement('div');
            autresDispoDiv.classList.add('team-day-container');
            let autresDispoHtml = '<h4>Autres Personnels Disponibles pour Remplacement/Ajout</h4>';

            let personnelDispoCeJour = []; 
            for (const pId in disponibilités) {
                if (disponibilités[pId][currentModalDateStr] && personnels[pId]) {
                    personnelDispoCeJour.push({ id: pId, ...personnels[pId] });
                }
            }

            const assignedInModalIds = new Set([
                ...currentModalGiffTeam.map(p => p.id),
                ...currentModalMprTeam.map(p => p.id)
            ]);

            const autresPersonnelsNonAssignes = personnelDispoCeJour.filter(p => !assignedInModalIds.has(p.id));

            autresDispoHtml += '<ul>';
            if (autresPersonnelsNonAssignes.length > 0) {
                autresPersonnelsNonAssignes.sort((a,b) => a.nom.localeCompare(b.nom)).forEach(p => {
                    const fonctionsStr = Object.entries(p.fonctions || {})
                        .filter(([, value]) => value)
                        .map(([key]) => getRoleName(key,'abbr'))
                        .join(', ');

                    autresDispoHtml += `<li>
                                <span>${p.nom} (${fonctionsStr || 'N/A'})</span>
                                <span class="team-member-actions">
                                    <button class="add-member-to-team-btn button-success" data-personnel-id="${p.id}" data-personnel-nom="${p.nom}">
                                        <span class="icon">➕</span> Ajouter
                                    </button>
                                </span>
                            </li>`;
                });
            } else {
                autresDispoHtml += '<li>Aucun autre personnel disponible ce jour.</li>';
            }
            autresDispoHtml += '</ul>';
            autresDispoDiv.innerHTML = autresDispoHtml;
            displayDiv.appendChild(autresDispoDiv);

            // Add event listeners for modal buttons
            document.getElementById('saveManualAssignmentBtn').addEventListener('click', saveManualAssignment);
            document.getElementById('clearDayBtnInModal').addEventListener('click', clearAssignmentsAndAvailabilitiesForDay);
            document.querySelectorAll('.replace-member-btn').forEach(btn => btn.addEventListener('click', handleReplaceMember));
            document.querySelectorAll('.add-member-to-team-btn').forEach(btn => btn.addEventListener('click', handleAddMemberToTeam));
        }

        async function saveManualAssignment() { // Admin Modal
            if (!adminLoggedIn || !currentModalDateStr) return;

            const manualAssignmentData = {
                giffTeam: currentModalGiffTeam.map(p => ({ id: p.id, nom: p.nom, assignedRole: p.assignedRole })),
                mprTeam: currentModalMprTeam.map(p => ({ id: p.id, nom: p.nom, assignedRole: p.assignedRole }))
            };

            try {
                await set(ref(database, `manualTeamAssignments/${currentModalDateStr}`), manualAssignmentData);
                manualTeamAssignments[currentModalDateStr] = manualAssignmentData; // Update local cache
                
                // Update assignment counts for involved personnel
                const allAssignedIdsToday = new Set();
                currentModalGiffTeam.forEach(p => allAssignedIdsToday.add(p.id));
                currentModalMprTeam.forEach(p => allAssignedIdsToday.add(p.id));

                for (const pId of allAssignedIdsToday) {
                    if (personnels[pId] && personnels[pId].assignments) {
                        personnels[pId].assignments.giff = (personnels[pId].assignments.giff || 0) + (currentModalGiffTeam.some(member => member.id === pId) ? 1 : 0);
                        personnels[pId].assignments.mpr = (personnels[pId].assignments.mpr || 0) + (currentModalMprTeam.some(member => member.id === pId) ? 1 : 0);
                        personnels[pId].assignments.total = (personnels[pId].assignments.total || 0) + 1; // Assuming 1 assignment per day max for simplicity in this count
                        await update(ref(database, `personnels/${pId}/assignments`), personnels[pId].assignments);
                    }
                }

                showNotification(`Composition manuelle sauvegardée pour ${currentModalDateStr}.`);
                dailyTeamAssignments[currentModalDateStr] = null; // Force recalculation from manual data if reopened
                closeTeamDetailModal(); // This will trigger a refresh of the overview calendar
            } catch (error) {
                console.error("Erreur sauvegarde affectation manuelle:", error);
                showNotification("Erreur lors de la sauvegarde de l'affectation manuelle.", 5000);
            }
        }

        async function clearAssignmentsAndAvailabilitiesForDay() { // Admin Modal
            if (!adminLoggedIn || !currentModalDateStr) return;

            if (!confirm(`Êtes-vous sûr de vouloir vider TOUTES les affectations (CCF & MPR) ET supprimer les disponibilités Firebase des personnels concernés pour le ${currentModalDateStr} ? Cette action est irréversible.`)) {
                showNotification("Opération annulée.");
                return;
            }

            try {
                // 1. Collect all personnel IDs involved in the currentModal teams
                const personnelIdsToClearDispo = new Set();
                currentModalGiffTeam.forEach(p => personnelIdsToClearDispo.add(p.id));
                currentModalMprTeam.forEach(p => personnelIdsToClearDispo.add(p.id));

                // 2. Remove manual assignment for the day, if exists
                await remove(ref(database, `manualTeamAssignments/${currentModalDateStr}`));
                delete manualTeamAssignments[currentModalDateStr]; // Clear local cache

                // 3. Set availability to false for these personnel on this day
                const dispoUpdates = {};
                personnelIdsToClearDispo.forEach(pId => {
                    dispoUpdates[`disponibilites/${pId}/${currentModalDateStr}`] = false;
                });
                await update(ref(database), dispoUpdates);


                // 4. Clear local modal teams and session cache for the day
                currentModalGiffTeam = [];
                currentModalMprTeam = [];
                if (dailyTeamAssignments[currentModalDateStr]) {
                    dailyTeamAssignments[currentModalDateStr].forceRecalculate = true; // Force a fresh auto-generation if modal is reopened
                    dailyTeamAssignments[currentModalDateStr].giffTeam = [];
                    dailyTeamAssignments[currentModalDateStr].mprTeam = [];
                    // Status details will be re-evaluated by getTeamDeficiencies
                }


                showNotification(`Affectations et disponibilités Firebase réinitialisées pour le ${currentModalDateStr}.`, 4000);
                closeTeamDetailModal(); // This will trigger a refresh of the overview calendar
            } catch (error) {
                console.error("Erreur lors du vidage de la journée:", error);
                showNotification("Erreur lors du vidage de la journée.", 5000);
            }
        }


        async function handleReplaceMember(event) { // Admin Modal
            if (!adminLoggedIn) return;
            const teamType = event.target.dataset.teamType;
            const memberIndex = parseInt(event.target.dataset.memberIndex);
            const currentMemberId = event.target.dataset.memberId;
            const assignedRole = event.target.dataset.assignedRole;

            let teamToUpdate = teamType === 'giff' ? currentModalGiffTeam : currentModalMprTeam;
            const teamConfig = teamType === 'giff' ? teamTypeConfigs.giff : teamTypeConfigs.mpr;

            let personnelDispoPourRemplacement = [];
            for (const pId in disponibilités) {
                if (disponibilités[pId][currentModalDateStr] && personnels[pId] && personnels[pId].fonctions[assignedRole]) {
                    // Check if not already in EITHER team (unless it's the person being replaced)
                    const isInGiff = currentModalGiffTeam.some(m => m.id === pId && m.id !== currentMemberId);
                    const isInMpr = currentModalMprTeam.some(m => m.id === pId && m.id !== currentMemberId);
                    if (!isInGiff && !isInMpr) {
                        personnelDispoPourRemplacement.push({ id: pId, ...personnels[pId] });
                    }
                }
            }
            personnelDispoPourRemplacement.sort((a, b) => a.nom.localeCompare(b.nom));


            if (personnelDispoPourRemplacement.length === 0) {
                showNotification(`Aucun remplaçant disponible avec la fonction ${getRoleName(assignedRole, 'name')} pour ${currentModalDateStr}.`, 3000);
                return;
            }

            let optionsHtml = '<option value="">-- Choisir remplaçant --</option>';
            personnelDispoPourRemplacement.forEach(p => {
                optionsHtml += `<option value="${p.id}">${p.nom}</option>`;
            });

            const selectId = `replaceSelect-${teamType}-${memberIndex}`;
            const currentActionSpan = event.target.closest('.team-member-actions');
            currentActionSpan.innerHTML = `
                <select id="${selectId}" style="max-width:150px;">${optionsHtml}</select>
                <button class="confirm-replace-btn button-success" data-team-type="${teamType}" data-member-index="${memberIndex}" data-original-member-id="${currentMemberId}" data-assigned-role="${assignedRole}" style="padding:0.4rem 0.6rem;">OK</button>
                <button class="cancel-replace-btn button-outline" style="padding:0.4rem 0.6rem;">X</button>
            `;

            currentActionSpan.querySelector('.confirm-replace-btn').addEventListener('click', confirmReplacement);
            currentActionSpan.querySelector('.cancel-replace-btn').addEventListener('click', () => {
                // Re-render modal to restore original state or specific part
                const giffStatus = getTeamDeficiencies(currentModalGiffTeam, teamTypeConfigs.giff);
                const mprStatus = getTeamDeficiencies(currentModalMprTeam, teamTypeConfigs.mpr);
                displayTeamDetailsInModal(currentModalDateStr, giffStatus, mprStatus);
            });
        }

        async function confirmReplacement(event) { // Admin Modal
            if (!adminLoggedIn) return;
            const teamType = event.target.dataset.teamType;
            const memberIndex = parseInt(event.target.dataset.memberIndex);
            const originalMemberId = event.target.dataset.originalMemberId; // Could be useful for assignment score adjustments later
            const assignedRole = event.target.dataset.assignedRole;
            
            const selectElement = document.getElementById(`replaceSelect-${teamType}-${memberIndex}`);
            const newMemberId = selectElement.value;

            if (!newMemberId) {
                showNotification("Veuillez sélectionner un remplaçant.", 2000);
                return;
            }

            const newMember = personnels[newMemberId];
            let teamToUpdate = teamType === 'giff' ? currentModalGiffTeam : currentModalMprTeam;

            // Replace in the current modal's team structure
            teamToUpdate[memberIndex] = { ...newMember, id: newMemberId, assignedRole: assignedRole };

            // Re-evaluate team status and re-render the modal
            const giffStatus = getTeamDeficiencies(currentModalGiffTeam, teamTypeConfigs.giff);
            const mprStatus = getTeamDeficiencies(currentModalMprTeam, teamTypeConfigs.mpr);
            await displayTeamDetailsInModal(currentModalDateStr, giffStatus, mprStatus);
            showNotification(`Personnel remplacé dans l'équipe ${teamType === 'giff' ? DISPLAY_NAME_GIFF : DISPLAY_NAME_MPR}. N'oubliez pas de sauvegarder.`, 3000);
        }

        async function handleAddMemberToTeam(event) { // Admin Modal
            if (!adminLoggedIn) return;
            const personnelId = event.target.dataset.personnelId;
            const personnelNom = event.target.dataset.personnelNom;
            const personnelData = personnels[personnelId];

            const availableRolesForPerson = Object.entries(personnelData.fonctions || {})
                .filter(([, value]) => value)
                .map(([key]) => key);

            if (availableRolesForPerson.length === 0) {
                showNotification(`${personnelNom} n'a aucune fonction définie.`, 3000);
                return;
            }

            // Determine which teams they could be added to based on their roles and team needs
            let possibleAssignments = [];
            // Check GIFF
            teamTypeConfigs.giff.roles.forEach(roleDef => {
                if (personnelData.fonctions[roleDef.key]) {
                    // Check if team still needs this role
                    const currentCount = currentModalGiffTeam.filter(p => p.assignedRole === roleDef.key).length;
                    if (currentCount < roleDef.required) { // Or even if not strictly required, if you allow overmanning
                        possibleAssignments.push({ team: 'giff', role: roleDef.key, label: `Ajouter à ${DISPLAY_NAME_GIFF} comme ${getRoleName(roleDef.key, 'name')}` });
                    }
                }
            });
            // Check MPR
            teamTypeConfigs.mpr.roles.forEach(roleDef => {
                if (personnelData.fonctions[roleDef.key]) {
                    const currentCount = currentModalMprTeam.filter(p => p.assignedRole === roleDef.key).length;
                    if (currentCount < roleDef.required) {
                        possibleAssignments.push({ team: 'mpr', role: roleDef.key, label: `Ajouter à ${DISPLAY_NAME_MPR} comme ${getRoleName(roleDef.key, 'name')}` });
                    }
                }
            });


            if (possibleAssignments.length === 0) {
                showNotification(`${personnelNom} ne peut être ajouté à aucune équipe (soit rôles non compatibles, soit équipes déjà pleines pour ses rôles).`, 4000);
                return;
            }

            let optionsHtml = '<option value="">-- Choisir affectation --</option>';
            possibleAssignments.forEach(pa => {
                optionsHtml += `<option value="${pa.team}|${pa.role}">${pa.label}</option>`;
            });

            const selectId = `addSelect-${personnelId}`;
            const currentActionSpan = event.target.closest('.team-member-actions');
            currentActionSpan.innerHTML = `
                <select id="${selectId}" style="max-width:200px;">${optionsHtml}</select>
                <button class="confirm-add-member-btn button-success" data-personnel-id="${personnelId}" style="padding:0.4rem 0.6rem;">OK</button>
                <button class="cancel-add-member-btn button-outline" style="padding:0.4rem 0.6rem;">X</button>
            `;
            currentActionSpan.querySelector('.confirm-add-member-btn').addEventListener('click', confirmAddMember);
            currentActionSpan.querySelector('.cancel-add-member-btn').addEventListener('click', () => {
                const giffStatus = getTeamDeficiencies(currentModalGiffTeam, teamTypeConfigs.giff);
                const mprStatus = getTeamDeficiencies(currentModalMprTeam, teamTypeConfigs.mpr);
                displayTeamDetailsInModal(currentModalDateStr, giffStatus, mprStatus);
            });
        }

        async function confirmAddMember(event) { // Admin Modal
            if (!adminLoggedIn) return;
            const personnelId = event.target.dataset.personnelId;
            const selectElement = document.getElementById(`addSelect-${personnelId}`);
            const selectedValue = selectElement.value;

            if (!selectedValue) {
                showNotification("Veuillez choisir une affectation.", 2000);
                return;
            }

            const [teamType, assignedRole] = selectedValue.split('|');
            const newMember = personnels[personnelId];
            let teamToUpdate = teamType === 'giff' ? currentModalGiffTeam : currentModalMprTeam;

            teamToUpdate.push({ ...newMember, id: personnelId, assignedRole: assignedRole });

            // Re-evaluate and re-render
            const giffStatus = getTeamDeficiencies(currentModalGiffTeam, teamTypeConfigs.giff);
            const mprStatus = getTeamDeficiencies(currentModalMprTeam, teamTypeConfigs.mpr);
            await displayTeamDetailsInModal(currentModalDateStr, giffStatus, mprStatus);
            showNotification(`${newMember.nom} ajouté à l'équipe ${teamType === 'giff' ? DISPLAY_NAME_GIFF : DISPLAY_NAME_MPR}. N'oubliez pas de sauvegarder.`, 3000);
        }

        // --- Export & Print (Admin) ---
        const exportCSVBtn = document.getElementById('exportCSV');
        exportCSVBtn.addEventListener('click', async () => {
            if (!adminLoggedIn) return;
            const year = currentCalendarDateTeamsOverview.getFullYear();
            const month = currentCalendarDateTeamsOverview.getMonth();
            const monthName = new Intl.DateTimeFormat('fr-FR', { month: 'long' }).format(currentCalendarDateTeamsOverview);
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += `Planning Équipes ${DISPLAY_NAME_GIFF} & ${DISPLAY_NAME_MPR} - ${monthName} ${year}\n`;
            csvContent += "Date,Équipe,Rôle Assigné,Nom Personnel\n";

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const teamData = await generateAndCacheTeamsForDate(dateStr, false); // Use cached/generated

                teamData.giffTeam.forEach(p => {
                    csvContent += `${dateStr},${DISPLAY_NAME_GIFF},"${getRoleName(p.assignedRole, 'name')}","${p.nom}"\n`;
                });
                teamData.mprTeam.forEach(p => {
                    csvContent += `${dateStr},${DISPLAY_NAME_MPR},"${getRoleName(p.assignedRole, 'name')}","${p.nom}"\n`;
                });
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `planning_equipes_${monthName}_${year}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification("Export CSV du planning du mois généré.");
        });

        const printPlanningBtn = document.getElementById('printPlanning');
        printPlanningBtn.addEventListener('click', () => {
            if (!adminLoggedIn) return;
            if (!currentModalDateStr && !teamsDateSelectDetail.value) {
                showNotification("Veuillez d'abord sélectionner un jour (via calendrier ou sélecteur de date) pour imprimer son détail.", 4000);
                return;
            }
            const dateToPrint = teamsDateSelectDetail.value || currentModalDateStr;
            if (!dateToPrint) { // Should not happen if previous check passed
                showNotification("Aucune date sélectionnée pour l'impression.", 3000);
                return;
            }

            if (teamDetailModal.style.display !== 'block' || currentModalDateStr !== dateToPrint) {
                openTeamDetailModal(dateToPrint).then(() => {
                    setTimeout(triggerPrintModalContent, 200); // Wait for modal content
                });
            } else {
                triggerPrintModalContent();
            }
        });

        function triggerPrintModalContent(){
             const modalContentToPrint = modalTeamDetailsContent.innerHTML;
             const printWindow = window.open('', '_blank', 'height=600,width=800');
             printWindow.document.write('<html><head><title>Détail Équipes</title>');
             // Include necessary styles for printing the modal content
             const styles = Array.from(document.styleSheets)
                .map(styleSheet => {
                  try {
                    return Array.from(styleSheet.cssRules)
                      .map(rule => rule.cssText)
                      .join('');
                  } catch (e) { /* Ignore cross-origin stylesheets */ return ''; }
                }).join('\n');
             printWindow.document.write(`<style>${styles} 
                #modalDateHeader button, .team-member-actions { display: none !important; } 
                body { font-family: sans-serif; }
                .team-day-container { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
                h3, h4 { color: black; }
                ul { list-style: none; padding-left: 0;}
                li { padding: 5px 0; border-bottom: 1px dashed #eee;}
                .team-status-modal { font-weight: bold; }
             </style></head><body>`);
             printWindow.document.write(modalContentToPrint);
             printWindow.document.write('</body></html>');
             printWindow.document.close();
             printWindow.focus();
             setTimeout(() => { // Wait for content to load in new window
                printWindow.print();
                printWindow.close();
             }, 250);
        }
        
        const exportTeamsCalendarPDFBtn = document.getElementById('exportTeamsCalendarPDF');
        exportTeamsCalendarPDFBtn.addEventListener('click', async () => {
            if (!adminLoggedIn) return;
            showNotification("Préparation du PDF du calendrier des équipes...", 2000);

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'pt',
                format: 'a4'
            });

            const equipesSection = document.getElementById('equipes');
            const originalStyles = equipesSection.style.cssText; // Save original inline styles
            const calendarTitle = document.querySelector('#equipes > h2');
            const monthYearDisplay = document.getElementById('currentMonthYearTeamsOverview');
            const legendContainer = document.querySelector('.legend-container');

            // Temporarily modify for PDF generation
            document.body.classList.add('print-pdf-mode'); // You can add specific styles for this class
            if (calendarTitle) calendarTitle.style.display = 'block'; // Ensure visible for html2canvas
            if (monthYearDisplay) monthYearDisplay.style.display = 'block';
            if (legendContainer) legendContainer.style.display = 'flex'; // Ensure it's block for capture

            try {
                // Capture the calendar grid
                const canvasCalendar = await html2canvas(teamsOverviewCalendarGrid, {
                    scale: 2, // Increase scale for better quality
                    useCORS: true,
                    backgroundColor: '#ffffff', // Force white background for capture
                    onclone: (clonedDoc) => { // Apply print styles to the cloned document
                        // This is where you would re-apply specific print CSS if html2canvas doesn't pick them up correctly
                        // Forcing colors often needs to be done carefully.
                        // The @media print CSS provided earlier should handle this if `color-adjust: exact` is respected.
                    }
                });
                const imgDataCalendar = canvasCalendar.toDataURL('image/png');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const margin = 20;

                pdf.setFontSize(18);
                pdf.text(calendarTitle ? calendarTitle.textContent : "Calendrier des Équipes", pdfWidth / 2, margin + 10, { align: 'center' });
                pdf.setFontSize(14);
                pdf.text(monthYearDisplay ? monthYearDisplay.textContent : "", pdfWidth / 2, margin + 30, { align: 'center' });

                const imgPropsCalendar = pdf.getImageProperties(imgDataCalendar);
                const ratioCalendar = imgPropsCalendar.width / imgPropsCalendar.height;
                let imgWidthCalendar = pdfWidth - 2 * margin;
                let imgHeightCalendar = imgWidthCalendar / ratioCalendar;
                if (imgHeightCalendar > pdfHeight - (margin + 50) - margin) { // check if it fits
                    imgHeightCalendar = pdfHeight - (margin + 50) - margin;
                    imgWidthCalendar = imgHeightCalendar * ratioCalendar;
                }
                pdf.addImage(imgDataCalendar, 'PNG', margin, margin + 50, imgWidthCalendar, imgHeightCalendar);

                // Capture the legend
                if (legendContainer) {
                    pdf.addPage();
                    pdf.setFontSize(16);
                    pdf.text("Légende", pdfWidth / 2, margin + 10, { align: 'center' });
                    const canvasLegend = await html2canvas(legendContainer, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const imgDataLegend = canvasLegend.toDataURL('image/png');
                    const imgPropsLegend = pdf.getImageProperties(imgDataLegend);
                    const ratioLegend = imgPropsLegend.width / imgPropsLegend.height;
                    let imgWidthLegend = pdfWidth - 2 * margin;
                    let imgHeightLegend = imgWidthLegend / ratioLegend;
                    if (imgHeightLegend > pdfHeight - (margin + 30) - margin) {
                        imgHeightLegend = pdfHeight - (margin + 30) - margin;
                        imgWidthLegend = imgHeightLegend * ratioLegend;
                    }
                    pdf.addImage(imgDataLegend, 'PNG', margin, margin + 30, imgWidthLegend, imgHeightLegend);
                }

                pdf.save(`calendrier_equipes_${monthYearDisplay ? monthYearDisplay.textContent.replace(/\s+/g, '_') : 'mois_en_cours'}.pdf`);
                showNotification("PDF du calendrier des équipes généré.", 3000);

            } catch (error) {
                console.error("Erreur génération PDF calendrier:", error);
                showNotification("Erreur lors de la génération du PDF du calendrier.", 5000);
            } finally {
                // Restore original styles and visibility
                document.body.classList.remove('print-pdf-mode');
                equipesSection.style.cssText = originalStyles; // Restore original inline styles
                // If you changed display properties of title/monthYear, revert them here if needed.
                // The @media print styles should handle visibility for actual printing.
            }
        });


        // --- Statistiques (Admin) ---
        const statsContainer = document.getElementById('statsContainer');
        const statsMonthSelect = document.getElementById('statsMonthSelect');
        const calculateMonthlyStatsBtn = document.getElementById('calculateMonthlyStatsBtn');
        const calculateGlobalStatsBtn = document.getElementById('calculateGlobalJuneSeptStatsBtn');
        const personnelContributionList = document.getElementById('personnelContributionList');
        const searchContributionsInput = document.getElementById('searchContributions');


        function updateStats() { // General stats update
            if (!adminLoggedIn || !statsContainer || !statsContainer.offsetParent) return;

            // Total Personnel
            const totalPersonnel = Object.keys(personnels).length;
            document.getElementById('statsTotalPersonnel').textContent = totalPersonnel;
            // Simple progress bar, e.g., based on target number of personnel
            const targetPersonnel = 50; // Example target
            document.querySelector('#statsContainer .stats-card:nth-child(1) .progress-bar').style.width = `${Math.min(100, (totalPersonnel / targetPersonnel) * 100)}%`;

            // Total Disponibilités (All time for now)
            let totalDispo = 0;
            const dispoByMonth = {}; // For mini chart { 'YYYY-MM': count }
            for (const pId in disponibilités) {
                for (const dateStr in disponibilités[pId]) {
                    if (disponibilités[pId][dateStr]) {
                        totalDispo++;
                        const monthKey = dateStr.substring(0, 7); // YYYY-MM
                        dispoByMonth[monthKey] = (dispoByMonth[monthKey] || 0) + 1;
                    }
                }
            }
            document.getElementById('statsTotalDispo').textContent = totalDispo;
            renderMiniChart('dispoMiniChart', dispoByMonth, 'Disponibilités');


            // Polyvalence
            let multiRoleCount = 0;
            const roleCounts = {}; // For the table and distribution display
            Object.values(roleDefinitions).forEach(def => roleCounts[def.abbr] = { name: def.name, count: 0 });

            for (const pId in personnels) {
                const p = personnels[pId];
                let numRoles = 0;
                if (p.fonctions) {
                    Object.entries(p.fonctions).forEach(([roleKey, hasRole]) => {
                        if (hasRole) {
                            numRoles++;
                            const roleAbbr = getRoleName(roleKey, 'abbr');
                            if(roleCounts[roleAbbr]) roleCounts[roleAbbr].count++;
                        }
                    });
                }
                if (numRoles > 1) multiRoleCount++;
            }
            const multiRolePercent = totalPersonnel > 0 ? ((multiRoleCount / totalPersonnel) * 100).toFixed(1) : 0;
            document.getElementById('statsMultiRole').textContent = `${multiRolePercent}%`;

            // Role Distribution (simple list in the card)
            const roleDistributionDiv = document.getElementById('roleDistribution');
            roleDistributionDiv.innerHTML = '';
            Object.entries(roleCounts).forEach(([abbr, data]) => {
                if (data.count > 0) { // Only show roles with personnel
                    const item = document.createElement('div');
                    item.classList.add('stats-role-item');
                    const percentOfTotal = totalPersonnel > 0 ? ((data.count / totalPersonnel) * 100).toFixed(1) : 0;
                    item.innerHTML = `
                        <span class="stats-role-name">${abbr}</span>
                        <span class="stats-role-count">${data.count}</span>
                        <span class="stats-role-percent">(${percentOfTotal}%)</span>`;
                    roleDistributionDiv.appendChild(item);
                }
            });

            // Detailed Role Table
            const statsRoleDetailsBody = document.getElementById('statsRoleDetails');
            statsRoleDetailsBody.innerHTML = '';
            Object.values(roleDefinitions).forEach(roleDef => {
                const roleKey = Object.keys(roleDefinitions).find(key => roleDefinitions[key] === roleDef);
                const count = roleCounts[roleDef.abbr] ? roleCounts[roleDef.abbr].count : 0;
                const percent = totalPersonnel > 0 ? ((count / totalPersonnel) * 100).toFixed(1) : 0;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${roleDef.name}</td><td>${count}</td><td>${percent}%</td>`;
                statsRoleDetailsBody.appendChild(tr);
            });

            populateStatsMonthSelect();
        }

        function populateStatsMonthSelect() {
            statsMonthSelect.innerHTML = '';
            const months = ["Juin", "Juillet", "Août", "Septembre"]; // For 2025 planning period
            const year = 2025;
            months.forEach((monthName, index) => {
                const option = document.createElement('option');
                option.value = `${year}-${String(index + 6).padStart(2, '0')}`; // June is month 5 (0-indexed) + 1 = 6
                option.textContent = `${monthName} ${year}`;
                statsMonthSelect.appendChild(option);
            });
        }

        calculateMonthlyStatsBtn.addEventListener('click', () => calculateDetailedStats(statsMonthSelect.value));
        calculateGlobalStatsBtn.addEventListener('click', () => calculateDetailedStats('globalJuneSept'));
        searchContributionsInput.addEventListener('input', () => {
            // This assumes that the contributions are already calculated and displayed.
            // It will filter the currently displayed list.
            const searchTerm = searchContributionsInput.value.toLowerCase().trim();
            const items = personnelContributionList.querySelectorAll('li.personnel-contribution-item');
            items.forEach(item => {
                const name = item.querySelector('dt').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });


        async function calculateDetailedStats(period) { // period is 'YYYY-MM' or 'globalJuneSept'
            if (!adminLoggedIn) return;
            showNotification(`Calcul des statistiques pour ${period === 'globalJuneSept' ? 'Juin-Septembre' : period}...`, 2000);

            let startDate, endDate;
            let totalDaysInPeriod = 0;

            if (period === 'globalJuneSept') {
                startDate = new Date(2025, 5, 1); // June 1st
                endDate = new Date(2025, 8, 30); // Sept 30th
                totalDaysInPeriod = (endDate - startDate) / (1000 * 60 * 60 * 24) + 1;
            } else {
                const [year, month] = period.split('-').map(Number);
                startDate = new Date(year, month - 1, 1);
                endDate = new Date(year, month, 0); // Last day of the month
                totalDaysInPeriod = endDate.getDate();
            }

            let giffFullDays = 0;
            let giffPartialDays = 0;
            let mprFullDays = 0;
            let mprPartialDays = 0;
            let bothTeamsFullDays = 0;
            const personnelContributions = {}; // { personnelId: { giff: count, mpr: count, total: count } }
            const dailyGiffStatusForChart = {}; // { 'DD': status (0=empty, 0.5=partial, 1=full) }
            const dailyMprStatusForChart = {};


            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                const teamData = await generateAndCacheTeamsForDate(dateStr, false); // Don't show alerts during mass calculation

                const dayOfMonthForChart = String(d.getDate()).padStart(2, '0');

                if (teamData.giffStatusDetails.status === 'complete') {
                    giffFullDays++;
                    dailyGiffStatusForChart[dayOfMonthForChart] = 1;
                } else if (teamData.giffStatusDetails.status === 'partial') {
                    giffPartialDays++;
                    dailyGiffStatusForChart[dayOfMonthForChart] = 0.5;
                } else { // empty
                    dailyGiffStatusForChart[dayOfMonthForChart] = 0;
                }

                if (teamData.mprStatusDetails.status === 'complete') {
                    mprFullDays++;
                    dailyMprStatusForChart[dayOfMonthForChart] = 1;
                } else if (teamData.mprStatusDetails.status === 'partial') {
                    mprPartialDays++;
                    dailyMprStatusForChart[dayOfMonthForChart] = 0.5;
                } else { // empty
                    dailyMprStatusForChart[dayOfMonthForChart] = 0;
                }

                if (teamData.giffStatusDetails.status === 'complete' && teamData.mprStatusDetails.status === 'complete') {
                    bothTeamsFullDays++;
                }

                // Track personnel contributions
                teamData.giffTeam.forEach(p => {
                    if (!personnelContributions[p.id]) personnelContributions[p.id] = { giff: 0, mpr: 0, total: 0, nom: p.nom };
                    personnelContributions[p.id].giff++;
                    personnelContributions[p.id].total++;
                });
                teamData.mprTeam.forEach(p => {
                    if (!personnelContributions[p.id]) personnelContributions[p.id] = { giff: 0, mpr: 0, total: 0, nom: p.nom };
                    personnelContributions[p.id].mpr++;
                    personnelContributions[p.id].total++;
                });
            }

            // Update DOM
            document.getElementById('giffFullDays').textContent = giffFullDays;
            document.getElementById('giffPartialDays').textContent = giffPartialDays;
            document.getElementById('mprFullDays').textContent = mprFullDays;
            document.getElementById('mprPartialDays').textContent = mprPartialDays;
            
            const bothFullPercent = totalDaysInPeriod > 0 ? ((bothTeamsFullDays / totalDaysInPeriod) * 100).toFixed(1) : 0;
            document.getElementById('bothFullDays').textContent = `${bothFullPercent}%`;
            document.getElementById('bothFullProgress').style.width = `${bothFullPercent}%`;

            // Render mini charts for the selected month (if not global)
            if (period !== 'globalJuneSept') {
                renderMiniChart('giffMiniChart', dailyGiffStatusForChart, 'CCF Statut', totalDaysInPeriod, period);
                renderMiniChart('mprMiniChart', dailyMprStatusForChart, 'MPR Statut', totalDaysInPeriod, period);
            } else {
                // Clear or show placeholder for global period charts
                document.getElementById('giffMiniChart').innerHTML = '<p style="font-size:0.8em; text-align:center; color: var(--text-light);">Graphique journalier non applicable pour la période globale.</p>';
                document.getElementById('mprMiniChart').innerHTML = '<p style="font-size:0.8em; text-align:center; color: var(--text-light);">Graphique journalier non applicable pour la période globale.</p>';
            }


            // Personnel Contributions List
            personnelContributionList.innerHTML = ''; // Clear previous
            const sortedContributions = Object.entries(personnelContributions)
                .sort(([,a], [,b]) => b.total - a.total || a.nom.localeCompare(b.nom)); // Sort by total, then name

            if (sortedContributions.length === 0) {
                personnelContributionList.innerHTML = '<p>Aucune contribution à afficher pour cette période.</p>';
            } else {
                sortedContributions.forEach(([pId, data]) => {
                    const li = document.createElement('li');
                    li.classList.add('personnel-contribution-item');
                    li.innerHTML = `
                        <dl>
                            <dt>${data.nom}</dt>
                            <dd><strong>Total Jours Affectés:</strong> ${data.total}</dd>
                            <dd><strong>${DISPLAY_NAME_GIFF}:</strong> ${data.giff} jours</dd>
                            <dd><strong>${DISPLAY_NAME_MPR}:</strong> ${data.mpr} jours</dd>
                        </dl>
                    `;
                    personnelContributionList.appendChild(li);
                });
            }
            searchContributionsInput.value = ''; // Clear search on new calculation
        }

        function renderMiniChart(elementId, data, tooltipPrefix = 'Valeur', daysInMonth = 30, monthYear = null) {
            const chartDiv = document.getElementById(elementId);
            chartDiv.innerHTML = ''; // Clear previous
            const maxValue = 1; // Max is a full team

            let currentMonthName = "";
            if (monthYear) { // YYYY-MM
                const [year, monthNum] = monthYear.split('-');
                const dateForMonthName = new Date(parseInt(year), parseInt(monthNum) - 1, 1);
                currentMonthName = new Intl.DateTimeFormat('fr-FR', { month: 'short' }).format(dateForMonthName) + " ";
            }


            for (let i = 1; i <= daysInMonth; i++) {
                const dayKey = String(i).padStart(2, '0');
                const value = data[dayKey] || 0; // 0 for empty, 0.5 for partial, 1 for full
                const bar = document.createElement('div');
                bar.classList.add('mini-chart-bar');
                bar.style.height = `${(value / maxValue) * 100}%`;
                
                let barColor = 'var(--disabled-input-bg)'; // Default for 0 / empty
                if (value === 1) barColor = 'var(--success-color)'; // Full
                else if (value === 0.5) barColor = 'var(--warning-color)'; // Partial
                bar.style.backgroundColor = barColor;

                bar.dataset.tooltip = `${tooltipPrefix} ${currentMonthName}${i}: ${value === 1 ? 'Complet' : (value === 0.5 ? 'Partiel' : 'Vide')}`;
                chartDiv.appendChild(bar);
            }
        }

        // --- Résumé des Manquements (Admin Équipes Tab) ---
        const ccfDeficiencyList = document.querySelector('#ccfDeficiencySummary .deficiency-list');
        const mprDeficiencyList = document.querySelector('#mprDeficiencySummary .deficiency-list');

        async function updateTeamsDeficiencySummary(year, month) {
            if (!adminLoggedIn || !ccfDeficiencyList || !mprDeficiencyList) return;

            ccfDeficiencyList.innerHTML = '<li>Chargement...</li>';
            mprDeficiencyList.innerHTML = '<li>Chargement...</li>';

            const deficienciesByDayCCF = {}; // { 'YYYY-MM-DD': ['Manque CPL', 'Manque EQFDF'] }
            const deficienciesByDayMPR = {};

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const teamData = await generateAndCacheTeamsForDate(dateStr, false);

                if (teamData.giffStatusDetails.status === 'partial') {
                    deficienciesByDayCCF[dateStr] = teamData.giffStatusDetails.deficiencies.map(d => `${d.short} (x${d.count || 1})`);
                }
                if (teamData.mprStatusDetails.status === 'partial') {
                    deficienciesByDayMPR[dateStr] = teamData.mprStatusDetails.deficiencies.map(d => `${d.short} (x${d.count || 1})`);
                }
            }

            ccfDeficiencyList.innerHTML = '';
            Object.entries(deficienciesByDayCCF).forEach(([date, defs]) => {
                const li = document.createElement('li');
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
                li.innerHTML = `<strong>${formattedDate}:</strong> ${defs.join(', ')}`;
                ccfDeficiencyList.appendChild(li);
            });
            if (Object.keys(deficienciesByDayCCF).length === 0) ccfDeficiencyList.innerHTML = '<li>Aucun manquement CCF ce mois.</li>';

            mprDeficiencyList.innerHTML = '';
            Object.entries(deficienciesByDayMPR).forEach(([date, defs]) => {
                const li = document.createElement('li');
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
                li.innerHTML = `<strong>${formattedDate}:</strong> ${defs.join(', ')}`;
                mprDeficiencyList.appendChild(li);
            });
            if (Object.keys(deficienciesByDayMPR).length === 0) mprDeficiencyList.innerHTML = '<li>Aucun manquement MPR ce mois.</li>';
        }


        // --- Firebase Data Loading and Listeners ---
        onValue(ref(database, 'personnels'), (snapshot) => {
            personnels = snapshot.val() || {};
            if (adminLoggedIn && document.querySelector('#personnel.active')) renderPersonnels();
            if (adminLoggedIn && document.querySelector('#calendrier-admin.active')) {
                populatePersonnelDatalistForAdminCalendar();
                renderAdminCalendarDispo(); // Re-render if personnel data changes
            }
            if (document.querySelector('#mes-disponibilites.active')) {
                populatePersonnelDatalistForPublicCalendar();
                renderPublicAvailabilityCalendar();
            }
            if (adminLoggedIn && document.querySelector('#equipes.active')) {
                populatePersonnelDatalistForTeamsSearch();
                renderTeamsOverviewCalendar(); // Team structures might change if personnel roles change
            }
            if (adminLoggedIn && document.querySelector('#statistiques.active')) updateStats();
        });

        onValue(ref(database, 'disponibilites'), (snapshot) => {
            disponibilités = snapshot.val() || {};
            if (adminLoggedIn && document.querySelector('#calendrier-admin.active')) renderAdminCalendarDispo();
            if (document.querySelector('#mes-disponibilites.active')) renderPublicAvailabilityCalendar();
            if (adminLoggedIn && document.querySelector('#equipes.active')) {
                // Clear daily team cache as availabilities changed, then re-render
                dailyTeamAssignments = {};
                renderTeamsOverviewCalendar();
            }
            if (adminLoggedIn && document.querySelector('#personnel.active')) renderPersonnels(); // Update dispo counts in table
            if (adminLoggedIn && document.querySelector('#statistiques.active')) updateStats();
        });
        
        onValue(ref(database, 'manualTeamAssignments'), (snapshot) => {
            manualTeamAssignments = snapshot.val() || {};
            if (adminLoggedIn && document.querySelector('#equipes.active')) {
                // If manual assignments change, we need to re-render the teams overview
                // The generateAndCacheTeamsForDate function will now pick up these manual assignments first.
                dailyTeamAssignments = {}; // Clear session cache to ensure manual is preferred
                renderTeamsOverviewCalendar();
            }
            if (adminLoggedIn && document.querySelector('#statistiques.active')) {
                // Potentially recalculate stats if manual assignments affect them
                // For now, let the user trigger stat recalculation manually after such changes.
            }
        });

        // Load initial deadline for public view
        loadAvailabilityDeadlineForPublic();


        // --- Initial Load ---
        function initialLoad() {
            const activeLink = document.querySelector('nav ul li a.active');
            if (activeLink) {
                const targetHref = activeLink.getAttribute('href');
                const targetSection = document.querySelector(targetHref);
                if (targetSection) targetSection.classList.add('active');

                if (targetHref === '#mes-disponibilites') {
                    renderPublicAvailabilityCalendar();
                    populatePersonnelDatalistForPublicCalendar();
                    displayAvailabilityDeadline();
                }
                // Admin sections will be loaded if admin is logged in and the tab is active
                // This will typically happen via the nav link click logic after login.
            } else {
                // Default to "Mes Disponibilités" if no active link found (e.g., first load)
                document.querySelector('a[href="#mes-disponibilites"]').click();
            }
            adminNavItems.forEach(item => item.style.display = adminLoggedIn ? 'list-item' : 'none');
        }
        
        initialLoad();
        showNotification("Plateforme initialisée. Période de planification: 1er Juin - 30 Septembre 2025.");

    </script>
</body>
</html>