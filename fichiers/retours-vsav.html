<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gestion des Interventions | VSAV</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --info: #4895ef;
      --warning: #f8961e;
      --danger: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --white: #ffffff;
      --pharmacy: #198754; /* Nouvelle couleur pour la pharmacie */
      
      --border-radius: 10px;
      --box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      --transition: all 0.2s ease;
    }
    
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #f8fafd;
      color: var(--dark);
      line-height: 1.6;
      -webkit-tap-highlight-color: transparent;
      padding-bottom: 60px; /* Espace pour le menu mobile */
    }
    
    .vsav-app {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      background-color: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
    }
    
    .app-header {
      background-color: var(--primary);
      color: white;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .app-title {
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
    }
    
    .app-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .nav-tabs {
      border-bottom: none;
      background-color: #f1f3f9;
      padding: 0 1rem;
      overflow-x: auto;
      white-space: nowrap;
      flex-wrap: nowrap;
      display: flex;
      -webkit-overflow-scrolling: touch;
    }
    
    .nav-tabs .nav-link {
      color: var(--gray);
      font-weight: 600;
      border: none;
      padding: 0.75rem 1.25rem;
      transition: var(--transition);
      border-radius: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      position: relative;
      border-bottom: 3px solid transparent;
    }
    
    .nav-tabs .nav-link:hover {
      color: var(--primary);
      background-color: rgba(67, 97, 238, 0.05);
    }
    
    .nav-tabs .nav-link.active {
      color: var(--primary);
      background-color: transparent;
      border-bottom: 3px solid var(--primary);
    }
    
    /* Style spécifique pour l'onglet Pharmacie */
    .nav-tabs .nav-link#pharmacy-tab {
      color: var(--pharmacy);
    }
    
    .nav-tabs .nav-link#pharmacy-tab:hover {
      color: var(--pharmacy);
      background-color: rgba(25, 135, 84, 0.05);
    }
    
    .nav-tabs .nav-link#pharmacy-tab.active {
      color: var(--pharmacy);
      border-bottom-color: var(--pharmacy);
    }
    
    .tab-content {
      padding: 1.5rem;
    }
    
    .form-label {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    .form-control, .form-select {
      border-radius: 8px;
      padding: 0.75rem;
      border: 1px solid rgba(0,0,0,0.1);
      transition: var(--transition);
      font-size: 0.9rem;
      background-color: #f8fafd;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-light);
      box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.15);
      background-color: var(--white);
    }
    
    .badge {
      font-weight: 500;
      padding: 0.4em 0.75em;
      border-radius: 50px;
      font-size: 0.75rem;
    }
    
    .badge-en-cours { 
      background-color: var(--primary); 
      color: white;
    }
    .badge-termine { 
      background-color: var(--success); 
      color: white;
    }
    .badge-termine-reappro { 
      background-color: #198754;
      color: white;
    }
    .badge-en-attente { 
      background-color: var(--warning); 
      color: var(--dark); 
    }
    .badge-urgent {
      background-color: var(--danger);
      color: white;
    }
    .badge-critique {
      background-color: #6a040f;
      color: white;
    }
    
    .photo-thumbnail {
      max-height: 100px;
      cursor: pointer;
      transition: var(--transition);
      border-radius: var(--border-radius);
      border: 1px solid rgba(0,0,0,0.1);
      object-fit: cover;
    }
    
    .photo-thumbnail:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow);
    }
    
    .table {
      --bs-table-bg: transparent;
      --bs-table-striped-bg: rgba(0,0,0,0.02);
      border-radius: var(--border-radius);
      overflow: hidden;
      font-size: 0.85rem;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .table th {
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.5px;
      padding: 0.75rem;
      vertical-align: middle;
    }
    
    .table td {
      padding: 0.75rem;
      vertical-align: middle;
      border-color: rgba(0,0,0,0.05);
    }
    
    .btn {
      font-weight: 600;
      padding: 0.6rem 1rem;
      border-radius: 8px;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }
    
    .btn-sm {
      padding: 0.4rem 0.75rem;
      font-size: 0.8rem;
    }
    
    .btn i {
      font-size: 1em;
    }
    
    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-primary:hover {
      background-color: var(--secondary);
      border-color: var(--secondary);
    }
    
    .btn-outline-primary {
      color: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-outline-primary:hover {
      background-color: var(--primary);
      color: white;
    }
    
    .status-select {
      padding: 0.4rem;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,0.1);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      min-width: 100px;
      font-size: 0.8rem;
    }
    
    .status-select:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.15);
    }
    
    .sortable-header {
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      white-space: nowrap;
    }
    
    .sortable-header:hover {
      color: white;
      opacity: 0.9;
    }
    
    .search-box {
      position: relative;
      margin-bottom: 1rem;
      width: 100%;
    }
    
    .search-box i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }
    
    .search-box input {
      padding-left: 2.5rem;
      border-radius: 50px;
      border: 1px solid rgba(0,0,0,0.1);
      font-size: 0.9rem;
      background-color: #f8fafd;
    }
    
    .stats-card {
      background-color: white;
      border-radius: var(--border-radius);
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: var(--box-shadow);
      border-left: 4px solid var(--primary);
      transition: var(--transition);
    }
    
    .stats-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    
    .stats-card h5 {
      color: var(--gray);
      font-size: 0.8rem;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .stats-card p {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
      margin: 0;
    }
    
    .stats-card.en-cours { border-left-color: var(--primary); }
    .stats-card.termine { border-left-color: var(--success); }
    .stats-card.en-attente { border-left-color: var(--warning); }
    .stats-card.archive { border-left-color: var(--danger); }
    
    .toast-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1100;
      max-width: 90%;
    }
    
    .toast {
      border-radius: var(--border-radius);
      border: none;
      box-shadow: var(--box-shadow);
      font-size: 0.9rem;
    }
    
    .material-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background-color: rgba(67, 97, 238, 0.1);
      color: var(--primary);
      padding: 0.4rem 0.75rem;
      border-radius: 50px;
      font-weight: 500;
      margin: 0.2rem;
      font-size: 0.8rem;
    }
    
    .material-badge .btn-close {
      font-size: 0.5rem;
      opacity: 0.7;
    }
    
    .material-badge .btn-close:hover {
      opacity: 1;
    }
    
    .archived {
      opacity: 0.7;
      background-color: rgba(0,0,0,0.02);
    }
    
    .archived:hover {
      opacity: 1;
    }
    
    .action-buttons {
      display: flex;
      gap: 0.3rem;
      flex-wrap: wrap;
    }
    
    /* Styles pour le menu déroulant des filtres */
    .filter-dropdown .dropdown-menu {
      padding: 0.5rem;
      min-width: 200px;
      border-radius: var(--border-radius);
      border: none;
      box-shadow: var(--box-shadow);
    }
    
    .filter-dropdown .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      margin-bottom: 0.25rem;
      font-size: 0.85rem;
      transition: var(--transition);
    }
    
    .filter-dropdown .dropdown-item:last-child {
      margin-bottom: 0;
    }
    
    .filter-dropdown .dropdown-item.active {
      background-color: rgba(67, 97, 238, 0.1);
      color: var(--primary);
      font-weight: 500;
    }
    
    /* Styles pour la carte d'intervention */
    .intervention-card {
      border-radius: var(--border-radius);
      border: 1px solid rgba(0,0,0,0.1);
      transition: var(--transition);
      margin-bottom: 1rem;
      overflow: hidden;
      background-color: white;
      box-shadow: var(--box-shadow);
    }
    
    .intervention-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    
    .intervention-card-header {
      background-color: rgba(0,0,0,0.03);
      padding: 0.75rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .intervention-card-body {
      padding: 1rem;
    }
    
    .intervention-card-footer {
      background-color: rgba(0,0,0,0.03);
      padding: 0.75rem;
      border-top: 1px solid rgba(0,0,0,0.1);
      display: flex;
      justify-content: flex-end;
    }
    
    /* Styles pour la vue calendrier */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }
    
    .calendar-day-header {
      text-align: center;
      font-weight: 600;
      padding: 0.75rem;
      color: var(--primary);
      font-size: 0.75rem;
      text-transform: uppercase;
    }
    
    .calendar-day {
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: var(--border-radius);
      min-height: 100px;
      padding: 0.5rem;
      background-color: white;
      font-size: 0.8rem;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }
    
    .calendar-day.empty {
      background-color: rgba(0,0,0,0.02);
      border: 1px dashed rgba(0,0,0,0.1);
    }
    
    .calendar-day-header, .calendar-day {
      height: 100%;
    }
    
    .calendar-date {
      font-weight: 600;
      margin-bottom: 0.3rem;
      text-align: center;
      font-size: 0.8rem;
      color: var(--dark);
    }
    
    .calendar-event {
      font-size: 0.7rem;
      padding: 0.3rem 0.5rem;
      margin-bottom: 0.3rem;
      border-radius: 4px;
      background-color: rgba(67, 97, 238, 0.1);
      color: var(--primary);
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: var(--transition);
    }
    
    .calendar-event:hover {
      background-color: rgba(67, 97, 238, 0.2);
    }
    
    .calendar-event.urgent {
      background-color: rgba(247, 37, 133, 0.1);
      color: var(--danger);
    }
    
    .calendar-event.urgent:hover {
      background-color: rgba(247, 37, 133, 0.2);
    }
    
    .calendar-event.critique {
      background-color: rgba(106, 4, 15, 0.1);
      color: #6a040f;
    }
    
    .calendar-event.critique:hover {
      background-color: rgba(106, 4, 15, 0.2);
    }
    
    /* Styles pour la vue Kanban */
    .kanban-board {
      display: grid;
      grid-template-columns: repeat(1, 1fr);
      gap: 1rem;
    }
    
    .kanban-column {
      background-color: rgba(0,0,0,0.02);
      border-radius: var(--border-radius);
      padding: 0.75rem;
      box-shadow: var(--box-shadow);
    }
    
    .kanban-column-header {
      font-weight: 600;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      border-radius: 6px;
      text-align: center;
    }
    
    .kanban-column.en-attente .kanban-column-header {
      background-color: rgba(248, 150, 30, 0.2);
      color: var(--warning);
    }
    
    .kanban-column.en-cours .kanban-column-header {
      background-color: rgba(67, 97, 238, 0.2);
      color: var(--primary);
    }
    
    .kanban-column.termine .kanban-column-header {
      background-color: rgba(76, 201, 240, 0.2);
      color: var(--success);
    }
    
    .kanban-item {
      background-color: white;
      border-radius: var(--border-radius);
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      box-shadow: var(--box-shadow);
      cursor: move;
      transition: var(--transition);
    }
    
    .kanban-item:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .kanban-item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    
    .kanban-item-title {
      font-weight: 600;
      margin: 0;
      font-size: 0.9rem;
    }
    
    .kanban-item-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.75rem;
    }
    
    /* Styles pour la vue carte */
    .card-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    
    /* Styles pour la géolocalisation */
    .map-container {
      height: 300px;
      border-radius: var(--border-radius);
      overflow: hidden;
      margin-bottom: 1rem;
      box-shadow: var(--box-shadow);
    }
    
    /* Styles pour les indicateurs de performance */
    .kpi-card {
      background-color: white;
      border-radius: var(--border-radius);
      padding: 1.25rem;
      box-shadow: var(--box-shadow);
      text-align: center;
      transition: var(--transition);
    }
    
    .kpi-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    
    .kpi-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0.5rem 0;
    }
    
    .kpi-label {
      color: var(--gray);
      font-size: 0.8rem;
      margin: 0;
    }
    
    .kpi-trend.up {
      color: var(--success);
      font-size: 0.8rem;
    }
    
    .kpi-trend.down {
      color: var(--danger);
      font-size: 0.8rem;
    }
    
    /* Styles pour les notifications */
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      font-size: 0.6rem;
      background-color: var(--danger);
      color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Styles pour les exports */
    .export-dropdown .dropdown-menu {
      min-width: 200px;
      padding: 0.5rem;
      border-radius: var(--border-radius);
      border: none;
      box-shadow: var(--box-shadow);
    }
    
    .export-dropdown .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: var(--transition);
    }
    
    /* Modal mobile */
    .modal-dialog {
      margin: 0.5rem auto;
      max-width: 95%;
    }
    
    /* Swipe pour changer d'onglet */
    .tab-content {
      overflow-x: hidden;
      touch-action: pan-y;
    }
    
    /* Optimisation des formulaires pour mobile */
    .input-group-text {
      font-size: 0.9rem;
    }
    
    /* Amélioration de la lisibilité */
    .text-small {
      font-size: 0.8rem;
    }
    
    /* Animation pour les interactions */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    
    /* Commentaires sur les interventions */
    .comment-section {
      margin-top: 1rem;
      border-top: 1px solid rgba(0,0,0,0.1);
      padding-top: 1rem;
    }
    
    .comment-list {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    
    .comment-item {
      background-color: rgba(0,0,0,0.03);
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }
    
    .comment-author {
      font-weight: 600;
      font-size: 0.8rem;
    }
    
    .comment-date {
      font-size: 0.7rem;
      color: var(--gray);
    }
    
    .comment-text {
      margin-top: 0.3rem;
      font-size: 0.85rem;
    }
    
    /* Correction pour le voile modal */
    .modal-backdrop {
      z-index: 1040 !important;
    }
    
    /* Matériel section */
    .material-card {
      background-color: white;
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }
    
    .material-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    
    .material-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    
    .material-name {
      font-weight: 600;
      margin: 0;
    }
    
    .material-count {
      font-weight: 700;
      color: var(--primary);
    }
    
    .material-details {
      font-size: 0.85rem;
      color: var(--gray);
    }
    
    .material-interventions {
      margin-top: 0.5rem;
      font-size: 0.8rem;
    }
    
    .material-intervention {
      display: flex;
      justify-content: space-between;
      padding: 0.3rem 0;
      border-bottom: 1px dashed rgba(0,0,0,0.1);
    }
    
    .material-intervention:last-child {
      border-bottom: none;
    }
    
    /* Timeline des interventions */
    .timeline {
      position: relative;
      padding-left: 1.5rem;
      margin-left: 1rem;
    }
    
    .timeline::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: rgba(67, 97, 238, 0.2);
    }
    
    .timeline-item {
      position: relative;
      padding-bottom: 1.5rem;
    }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -1.7rem;
      top: 0.25rem;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--primary);
      border: 2px solid white;
      z-index: 1;
    }
    
    .timeline-item.urgent::before {
      background-color: var(--danger);
    }
    
    .timeline-item.critique::before {
      background-color: #6a040f;
    }
    
    .timeline-item.termine::before {
      background-color: var(--success);
    }
    
    .timeline-item.en-attente::before {
      background-color: var(--warning);
    }
    
    .timeline-content {
      background-color: white;
      border-radius: var(--border-radius);
      padding: 1rem;
      box-shadow: var(--box-shadow);
    }
    
    .timeline-date {
      font-size: 0.75rem;
      color: var(--gray);
      margin-bottom: 0.25rem;
    }
    
    .timeline-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .timeline-details {
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }
    
    .timeline-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    /* Menu mobile en bas */
    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background-color: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: none;
    }
    
    .mobile-nav-items {
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
    }
    
    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: var(--gray);
      font-size: 0.7rem;
      padding: 0.5rem;
      transition: var(--transition);
      flex: 1;
    }
    
    .mobile-nav-item i {
      font-size: 1.2rem;
      margin-bottom: 0.25rem;
    }
    
    .mobile-nav-item.active {
      color: var(--primary);
    }
    
    /* Style spécifique pour l'onglet Pharmacie mobile */
    .mobile-nav-item[data-tab="pharmacy-tab"] {
      color: var(--pharmacy);
    }
    
    .mobile-nav-item[data-tab="pharmacy-tab"].active {
      color: var(--pharmacy);
    }
    
    /* Nouveaux styles pour le suivi matériel */
    .material-status {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status-disponible {
      background-color: rgba(25, 135, 84, 0.1);
      color: #198754;
    }
    
    .status-commande {
      background-color: rgba(253, 126, 20, 0.1);
      color: #fd7e14;
    }
    
    .status-epuise {
      background-color: rgba(220, 53, 69, 0.1);
      color: #dc3545;
    }
    
    .status-archive {
      background-color: rgba(108, 117, 125, 0.1);
      color: #6c757d;
    }
    
    .status-attente {
      background-color: rgba(255, 193, 7, 0.1);
      color: #ffc107;
    }
    
    .status-recu {
      background-color: rgba(25, 135, 84, 0.1);
      color: #198754;
    }
    
    .status-reconditionne {
      background-color: rgba(13, 110, 253, 0.1);
      color: #0d6efd;
    }
    
    /* Password modal */
    .password-modal .modal-content {
      border-radius: var(--border-radius);
      border: none;
      box-shadow: var(--box-shadow);
    }
    
    .password-modal .modal-header {
      border-bottom: none;
    }
    
    .password-modal .modal-body {
      padding: 2rem;
    }
    
    .password-modal .form-control {
      padding: 0.75rem 1rem;
      font-size: 1rem;
    }
    
    .password-modal .btn {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
    }
    
    /* Checkbox pour sélection multiple */
    .select-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    /* Bouton pour suppression multiple */
    .delete-selected-btn {
      position: fixed;
      bottom: 80px;
      right: 20px;
      z-index: 1000;
      display: none;
    }
    
    /* Media queries spécifiques */
    @media (min-width: 576px) {
      .kanban-board {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .calendar-day {
        min-height: 120px;
      }
      
      .timeline {
        padding-left: 2rem;
        margin-left: 1.5rem;
      }
    }
    
    @media (min-width: 768px) {
      .app-title {
        font-size: 1.5rem;
      }
      
      .nav-tabs .nav-link {
        font-size: 0.9rem;
      }
      
      .calendar-day {
        min-height: 140px;
      }
      
      .mobile-actions {
        display: none;
      }
      
      .card-view {
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      }
    }
    
    @media (min-width: 1200px) {
      .card-view {
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      }
    }
    
    @media (max-width: 991px) {
      .nav-tabs {
        display: none;
      }
      
      .mobile-bottom-nav {
        display: block;
      }
      
      body {
        padding-bottom: 60px;
      }
    }
    
    @media (min-width: 992px) {
      .vsav-app {
        margin: 1rem auto;
      }
    }
  </style>
</head>
<body>
  <div class="vsav-app">
    <header class="app-header">
      <h1 class="app-title">
        <i class="bi bi-clipboard2-pulse-fill"></i> 
        Gestion des Interventions VSAV
      </h1>
      <div class="app-actions d-none d-md-flex">
        <button class="btn btn-sm btn-outline-light" id="refreshBtn">
          <i class="bi bi-arrow-clockwise"></i> Actualiser
        </button>
      </div>
    </header>
    
    <ul class="nav nav-tabs" id="interventionTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form" type="button" role="tab">
          <i class="bi bi-plus-lg"></i> Nouvelle
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="current-tab" data-bs-toggle="tab" data-bs-target="#current" type="button" role="tab">
          <i class="bi bi-list-ul"></i> Actives
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="archive-tab" data-bs-toggle="tab" data-bs-target="#archive" type="button" role="tab">
          <i class="bi bi-archive"></i> Archives
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="pharmacy-tab" data-bs-toggle="tab" data-bs-target="#pharmacy" type="button" role="tab">
          <i class="bi bi-capsule"></i> Pharmacie
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab">
          <i class="bi bi-bar-chart"></i> Statistiques
        </button>
      </li>
    </ul>
    
    <div class="tab-content" id="interventionTabsContent">
      <!-- Formulaire -->
      <div class="tab-pane fade show active" id="form" role="tabpanel">
        <form id="interventionForm" class="row g-3 needs-validation" novalidate>
          <div class="col-12">
            <label for="numero" class="form-label">
              <i class="bi bi-123"></i> N° Intervention
            </label>
            <input type="text" class="form-control" id="numero" required>
            <div class="invalid-feedback">Numéro requis</div>
          </div>
          
          <div class="col-md-6">
            <label for="date" class="form-label">
              <i class="bi bi-calendar-date"></i> Date
            </label>
            <input type="date" class="form-control" id="date" required>
            <div class="invalid-feedback">Date requise</div>
          </div>
          <div class="col-md-6">
            <label for="heure" class="form-label">
              <i class="bi bi-clock"></i> Heure
            </label>
            <input type="time" class="form-control" id="heure" required>
            <div class="invalid-feedback">Heure requise</div>
          </div>
          
          <div class="col-12">
            <label for="nom" class="form-label">
              <i class="bi bi-person-badge"></i> Responsable
            </label>
            <input type="text" class="form-control" id="nom" required>
            <div class="invalid-feedback">Nom requis</div>
          </div>
          
          <div class="col-md-8">
            <label for="lieu" class="form-label">
              <i class="bi bi-geo-alt"></i> Adresse
            </label>
            <div class="input-group mb-3">
              <input type="text" class="form-control" id="lieu" placeholder="Adresse">
              <button class="btn btn-outline-primary" type="button" id="geolocateBtn">
                <i class="bi bi-geo"></i>
              </button>
            </div>
            <div id="mapContainer" class="map-container d-none mb-3"></div>
          </div>
          
          <div class="col-md-4">
            <label for="commune" class="form-label">
              <i class="bi bi-building"></i> Commune
            </label>
            <input type="text" class="form-control" id="commune" placeholder="Commune">
          </div>
          
          <div class="col-md-4">
            <label for="statut" class="form-label">
              <i class="bi bi-info-circle"></i> Statut
            </label>
            <select class="form-select" id="statut">
              <option value="En attente" selected>En attente</option>
              <option value="En cours">En cours</option>
              <option value="Terminé">Terminé</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="urgence" class="form-label">
              <i class="bi bi-exclamation-triangle"></i> Urgence
            </label>
            <select class="form-select" id="urgence">
              <option value="Normal" selected>Normal</option>
              <option value="Urgent">Urgent</option>
              <option value="Critique">Critique</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="categorie" class="form-label">
              <i class="bi bi-tags"></i> Catégorie
            </label>
            <select class="form-select" id="categorie">
              <option value="Incendie">Incendie</option>
              <option value="Accident" selected>Accident</option>
              <option value="Secours">Secours</option>
              <option value="Formation">Formation</option>
              <option value="Autre">Autre</option>
            </select>
          </div>
          
          <div class="col-12">
            <label for="materiels" class="form-label">
              <i class="bi bi-tools"></i> Matériels utilisés
            </label>
            <div class="input-group mb-3">
              <input type="text" class="form-control" id="materielInput" placeholder="Ajouter un matériel">
              <button class="btn btn-outline-primary" type="button" id="ajouterMateriel">
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>
            <div id="materielsList" class="d-flex flex-wrap gap-2 mb-3"></div>
          </div>
          
          <div class="col-12">
            <label for="equipe" class="form-label">
              <i class="bi bi-people"></i> Équipe
            </label>
            <div class="input-group mb-3">
              <input type="text" class="form-control" id="membreInput" placeholder="Ajouter un membre">
              <button class="btn btn-outline-primary" type="button" id="ajouterMembre">
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>
            <div id="equipeList" class="d-flex flex-wrap gap-2 mb-3"></div>
          </div>
          
          <div class="col-12">
            <label for="commentaire" class="form-label">
              <i class="bi bi-chat-left-text"></i> Commentaire
            </label>
            <textarea class="form-control" id="commentaire" rows="3" placeholder="Détails..."></textarea>
          </div>
          
          <div class="col-12">
            <label for="photo" class="form-label">
              <i class="bi bi-camera"></i> Photos
            </label>
            <input class="form-control" type="file" id="photo" accept="image/*" multiple>
            <div class="text-small text-muted mt-1">Max 15MB par photo</div>
            <div id="photoPreview" class="mt-2 d-flex flex-wrap gap-2"></div>
          </div>
          
          <div class="col-12 d-flex justify-content-between mt-3">
            <button type="submit" class="btn btn-primary px-4">
              <i class="bi bi-save"></i> Enregistrer
            </button>
            <button type="button" class="btn btn-outline-secondary" id="resetForm">
              <i class="bi bi-arrow-counterclockwise"></i> Réinitialiser
            </button>
          </div>
          <input type="hidden" id="interventionId">
          <input type="hidden" id="latitude">
          <input type="hidden" id="longitude">
        </form>
      </div>
      
      <!-- Interventions en cours -->
      <div class="tab-pane fade" id="current" role="tabpanel">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
          <div class="search-box flex-grow-1">
            <i class="bi bi-search"></i>
            <input type="text" id="currentSearch" class="form-control" placeholder="Rechercher...">
          </div>
          
          <div class="d-flex gap-2">
            <!-- Menu déroulant des filtres -->
            <div class="filter-dropdown dropdown">
              <button class="btn btn-outline-primary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-funnel"></i> Filtres
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="filterDropdown">
                <li>
                  <a class="dropdown-item ${!currentFilterStatus ? 'active' : ''}" href="#" data-filter="all">
                    <i class="bi bi-collection"></i> Toutes
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item ${currentFilterStatus === 'En cours' ? 'active' : ''}" href="#" data-filter="En cours">
                    <i class="bi bi-hourglass-split"></i> En cours
                  </a>
                </li>
                <li>
                  <a class="dropdown-item ${currentFilterStatus === 'Terminé' ? 'active' : ''}" href="#" data-filter="Terminé">
                    <i class="bi bi-check-circle"></i> Terminé
                  </a>
                </li>
                <li>
                  <a class="dropdown-item ${currentFilterStatus === 'En attente' ? 'active' : ''}" href="#" data-filter="En attente">
                    <i class="bi bi-pause-circle"></i> En attente
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item ${currentFilterStatus === 'Urgent' ? 'active' : ''}" href="#" data-filter="Urgent">
                    <i class="bi bi-exclamation-triangle"></i> Urgent
                  </a>
                </li>
                <li>
                  <a class="dropdown-item ${currentFilterStatus === 'Critique' ? 'active' : ''}" href="#" data-filter="Critique">
                    <i class="bi bi-exclamation-octagon"></i> Critique
                  </a>
                </li>
              </ul>
            </div>
            
            <!-- Menu déroulant des exports -->
            <div class="export-dropdown dropdown">
              <button class="btn btn-outline-success dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-download"></i> Exporter
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="exportDropdown">
                <li>
                  <a class="dropdown-item" href="#" id="exportExcel">
                    <i class="bi bi-file-earmark-excel"></i> Excel
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#" id="exportPDF">
                    <i class="bi bi-file-earmark-pdf"></i> PDF
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#" id="exportCSV">
                    <i class="bi bi-file-earmark-text"></i> CSV
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Vue cartes -->
        <div class="card-view" id="cardView">
          <div id="currentInterventionsCards" class="card-view">
            <!-- Rempli dynamiquement -->
          </div>
          <div class="d-flex justify-content-center mt-3">
            <nav aria-label="Pagination">
              <ul class="pagination pagination-sm" id="currentCardsPagination">
                <!-- Rempli dynamiquement -->
              </ul>
            </nav>
          </div>
        </div>
      </div>
      
      <!-- Archives -->
      <div class="tab-pane fade" id="archive" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="search-box flex-grow-1 me-2">
            <i class="bi bi-search"></i>
            <input type="text" id="archiveSearch" class="form-control" placeholder="Rechercher...">
          </div>
          <button class="btn btn-danger" id="deleteSelectedBtn">
            <i class="bi bi-trash"></i> Supprimer sélection
          </button>
        </div>
        
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead>
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" id="selectAllCheckbox" class="select-checkbox">
                </th>
                <th class="sortable-header" data-sort="numero_intervention">
                  N° <i class="bi bi-arrow-down-up ms-1"></i>
                </th>
                <th>Responsable</th>
                <th class="sortable-header" data-sort="date">
                  Date <i class="bi bi-arrow-down-up ms-1"></i>
                </th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="archivedInterventions">
              <!-- Rempli dynamiquement -->
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-center mt-3">
          <nav aria-label="Pagination">
            <ul class="pagination pagination-sm" id="archivePagination">
              <!-- Rempli dynamiquement -->
            </ul>
          </nav>
        </div>
      </div>
      
      <!-- Pharmacie -->
      <div class="tab-pane fade" id="pharmacy" role="tabpanel">
        <div id="pharmacyContent" class="d-none">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Gestion de la Pharmacie</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary" id="addMaterialBtn">
                <i class="bi bi-plus-lg"></i> Ajouter
              </button>
              <button class="btn btn-outline-success" id="exportPharmacyBtn">
                <i class="bi bi-download"></i> Exporter
              </button>
            </div>
          </div>
          
          <div class="search-box mb-3">
            <i class="bi bi-search"></i>
            <input type="text" id="pharmacySearch" class="form-control" placeholder="Rechercher...">
          </div>
          
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead>
                <tr>
                  <th>N° Intervention</th>
                  <th>Date</th>
                  <th>Responsable</th>
                  <th>Commune</th>
                  <th>Matériels</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="pharmacyInterventions">
                <!-- Rempli dynamiquement -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div id="pharmacyLogin" class="d-flex flex-column align-items-center justify-content-center py-5">
          <div class="card shadow-sm" style="width: 100%; max-width: 400px;">
            <div class="card-body p-4">
              <h5 class="card-title text-center mb-4">
                <i class="bi bi-shield-lock"></i> Accès Pharmacie
              </h5>
              <form id="pharmacyLoginForm">
                <div class="mb-3">
                  <label for="pharmacyPassword" class="form-label">Mot de passe</label>
                  <input type="password" class="form-control" id="pharmacyPassword" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                  <i class="bi bi-unlock"></i> Se connecter
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Statistiques -->
      <div class="tab-pane fade" id="stats" role="tabpanel">
        <div class="row mb-3">
          <div class="col-6 col-md-3">
            <div class="stats-card en-cours">
              <h5><i class="bi bi-hourglass-split"></i> En cours</h5>
              <p id="stats-en-cours">0</p>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stats-card termine">
              <h5><i class="bi bi-check-circle"></i> Terminé</h5>
              <p id="stats-termine">0</p>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stats-card en-attente">
              <h5><i class="bi bi-pause-circle"></i> En attente</h5>
              <p id="stats-en-attente">0</p>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stats-card archive">
              <h5><i class="bi bi-archive"></i> Archivées</h5>
              <p id="stats-archive">0</p>
            </div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-12 col-md-4">
            <div class="kpi-card">
              <h6 class="kpi-label">Temps moyen</h6>
              <div class="kpi-value" id="avgDuration">--:--</div>
              <p class="kpi-trend up mb-0"><i class="bi bi-arrow-up"></i> 5% vs mois dernier</p>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="kpi-card">
              <h6 class="kpi-label">Urgentes</h6>
              <div class="kpi-value" id="urgentCount">0</div>
              <p class="kpi-trend down mb-0"><i class="bi bi-arrow-down"></i> 10% vs mois dernier</p>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="kpi-card">
              <h6 class="kpi-label">Taux résolution</h6>
              <div class="kpi-value" id="resolutionRate">0%</div>
              <p class="kpi-trend up mb-0"><i class="bi bi-arrow-up"></i> 3% vs mois dernier</p>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-12">
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-header bg-white border-0">
                <h6 class="card-title mb-0"><i class="bi bi-calendar-week"></i> Interventions par mois</h6>
              </div>
              <div class="card-body">
                <canvas id="monthlyChart" height="250"></canvas>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-header bg-white border-0">
                <h6 class="card-title mb-0"><i class="bi bi-pie-chart"></i> Répartition par statut</h6>
              </div>
              <div class="card-body">
                <canvas id="statusChart" height="250"></canvas>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-header bg-white border-0">
                <h6 class="card-title mb-0"><i class="bi bi-tags"></i> Par catégorie</h6>
              </div>
              <div class="card-body">
                <canvas id="categoryChart" height="250"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Menu mobile en bas -->
  <nav class="mobile-bottom-nav d-lg-none">
    <div class="mobile-nav-items">
      <a href="#" class="mobile-nav-item active" data-tab="form-tab">
        <i class="bi bi-plus-lg"></i>
        <span>Nouvelle</span>
      </a>
      <a href="#" class="mobile-nav-item" data-tab="current-tab">
        <i class="bi bi-list-ul"></i>
        <span>Actives</span>
      </a>
      <a href="#" class="mobile-nav-item" data-tab="archive-tab">
        <i class="bi bi-archive"></i>
        <span>Archives</span>
      </a>
      <a href="#" class="mobile-nav-item" data-tab="pharmacy-tab">
        <i class="bi bi-capsule"></i>
        <span>Pharmacie</span>
      </a>
      <a href="#" class="mobile-nav-item" data-tab="stats-tab">
        <i class="bi bi-bar-chart"></i>
        <span>Stats</span>
      </a>
    </div>
  </nav>

  <!-- Modal pour afficher les détails -->
  <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h6 class="modal-title">
            <i class="bi bi-info-circle-fill"></i> Détails de l'intervention
          </h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- Contenu dynamique -->
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Fermer
          </button>
          <button type="button" class="btn btn-primary" id="printIntervention">
            <i class="bi bi-printer"></i> Imprimer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour afficher la photo en grand -->
  <div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h6 class="modal-title">
            <i class="bi bi-image-fill"></i> Photo
          </h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center p-0">
          <img id="fullPhoto" src="" class="img-fluid" style="max-height: 70vh; width: auto;">
        </div>
        <div class="modal-footer border-0 justify-content-center">
          <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Fermer
          </button>
          <button type="button" class="btn btn-primary" id="downloadPhoto">
            <i class="bi bi-download"></i> Télécharger
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour la carte géographique -->
  <div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h6 class="modal-title">
            <i class="bi bi-map"></i> Localisation
          </h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <div id="interventionMap" class="map-container" style="height: 60vh;"></div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Fermer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour ajouter un commentaire -->
  <div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h6 class="modal-title">
            <i class="bi bi-chat-left-text"></i> Ajouter un commentaire
          </h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="commentInterventionId">
          <div class="mb-3">
            <label for="commentAuthor" class="form-label">Votre nom</label>
            <input type="text" class="form-control" id="commentAuthor" required>
          </div>
          <div class="mb-3">
            <label for="commentText" class="form-label">Commentaire</label>
            <textarea class="form-control" id="commentText" rows="3" required></textarea>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Annuler
          </button>
          <button type="button" class="btn btn-primary" id="saveCommentBtn">
            <i class="bi bi-save"></i> Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour gérer le matériel en pharmacie -->
  <div class="modal fade" id="pharmacyMaterialModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h6 class="modal-title">
            <i class="bi bi-capsule"></i> Gestion du matériel
          </h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="pharmacyInterventionId">
          <h6 class="mb-3">Matériels utilisés</h6>
          <div id="pharmacyMaterialList" class="mb-4">
            <!-- Rempli dynamiquement -->
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Fermer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour gérer un matériel spécifique -->
  <div class="modal fade" id="materialManagementModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h6 class="modal-title">
            <i class="bi bi-box-seam"></i> Gestion du matériel
          </h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="materialInterventionId">
          <input type="hidden" id="materialNameValue">
          <div class="mb-3">
            <label class="form-label">Matériel</label>
            <p class="form-control-static fw-bold" id="materialNameDisplay"></p>
          </div>
          <div class="mb-3">
            <label for="materialStatusSelect" class="form-label">Statut</label>
            <select class="form-select" id="materialStatusSelect">
              <option value="attente">En attente</option>
              <option value="commande">En commande</option>
              <option value="reapprovisionne">Réapprovisionné</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="materialAuthor" class="form-label">Auteur du commentaire</label>
            <input type="text" class="form-control" id="materialAuthor">
          </div>
          <div class="mb-3">
            <label for="materialComment" class="form-label">Commentaire</label>
            <textarea class="form-control" id="materialComment" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Annuler
          </button>
          <button type="button" class="btn btn-primary" id="saveMaterialManagementBtn">
            <i class="bi bi-save"></i> Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour ajouter un matériel manuellement -->
  <div class="modal fade" id="addMaterialModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h6 class="modal-title">
            <i class="bi bi-plus-lg"></i> Ajouter un matériel
          </h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="newMaterialName" class="form-label">Nom du matériel</label>
            <input type="text" class="form-control" id="newMaterialName" required>
          </div>
          <div class="mb-3">
            <label for="newMaterialQuantity" class="form-label">Quantité</label>
            <input type="number" class="form-control" id="newMaterialQuantity" min="1" value="1" required>
          </div>
          <div class="mb-3">
            <label for="newMaterialStatus" class="form-label">Statut</label>
            <select class="form-select" id="newMaterialStatus" required>
              <option value="attente">En attente</option>
              <option value="commande">En commande</option>
              <option value="reapprovisionne">Réapprovisionné</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="newMaterialAuthor" class="form-label">Auteur</label>
            <input type="text" class="form-control" id="newMaterialAuthor" required>
          </div>
          <div class="mb-3">
            <label for="newMaterialComment" class="form-label">Commentaire</label>
            <textarea class="form-control" id="newMaterialComment" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Annuler
          </button>
          <button type="button" class="btn btn-primary" id="saveNewMaterialBtn">
            <i class="bi bi-save"></i> Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour supprimer une intervention archivée -->
  <div class="modal fade" id="deleteArchiveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-danger text-white">
          <h6 class="modal-title">
            <i class="bi bi-exclamation-triangle"></i> Confirmation
          </h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="deleteInterventionId">
          <div class="mb-3">
            <label for="deletePassword" class="form-label">Mot de passe</label>
            <input type="password" class="form-control" id="deletePassword" required>
            <div class="form-text">Mot de passe requis pour supprimer définitivement</div>
          </div>
          <p class="text-danger">Êtes-vous sûr de vouloir supprimer définitivement cette intervention ?</p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Annuler
          </button>
          <button type="button" class="btn btn-danger" id="confirmDeleteArchiveBtn">
            <i class="bi bi-trash"></i> Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour supprimer plusieurs interventions archivées -->
  <div class="modal fade" id="deleteMultipleArchiveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-danger text-white">
          <h6 class="modal-title">
            <i class="bi bi-exclamation-triangle"></i> Confirmation
          </h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="deleteMultiplePassword" class="form-label">Mot de passe</label>
            <input type="password" class="form-control" id="deleteMultiplePassword" required>
            <div class="form-text">Mot de passe requis pour supprimer définitivement</div>
          </div>
          <p class="text-danger">Êtes-vous sûr de vouloir supprimer définitivement les interventions sélectionnées ?</p>
          <p id="selectedCount" class="fw-bold"></p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Annuler
          </button>
          <button type="button" class="btn btn-danger" id="confirmDeleteMultipleArchiveBtn">
            <i class="bi bi-trash"></i> Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container" id="toastContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Luxon pour les dates -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
  <!-- Chart.js plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <!-- SheetJS pour les exports Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF pour les exports PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
  <!-- Drag and Drop pour Kanban -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- Leaflet pour les cartes -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  
  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDmnua63SSMYhjaTdgRAoMIpPl215jgyo4",
      authDomain: "retour-intervention-vsav.firebaseapp.com",
      databaseURL: "https://retour-intervention-vsav-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "retour-intervention-vsav",
      messagingSenderId: "314826866332",
      appId: "1:314826866332:web:e02ff593621bef09eb3759",
      measurementId: "G-VBJC5RWF15"
    };

    // Initialisation Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // Variables globales
    let materiels = [];
    let equipe = [];
    let photosBase64 = [];
    let currentEditingId = null;
    const MAX_PHOTO_SIZE = 15 * 1024 * 1024; // 15MB
    let currentSortField = 'createdAt';
    let currentSortDirection = 'desc';
    let currentFilterStatus = null;
    let currentPage = 1;
    let archivePage = 1;
    const ITEMS_PER_PAGE = 6;
    let monthlyChart = null;
    let statusChart = null;
    let categoryChart = null;
    let allInterventions = {};
    let allMaterials = {};
    let map = null;
    let interventionMarkers = {};
    let touchStartX = 0;
    let touchEndX = 0;
    const PHARMACY_PASSWORD = "018A";
    const DELETE_PASSWORD = "Aspf66220*";
    let isPharmacyAuthenticated = false;
    let selectedInterventions = [];
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      initForm();
      loadInterventions();
      setupRealtime();
      setupSearch();
      setupSorting();
      setupFilters();
      setupExports();
      setupPharmacyTab();
      setupMobileNavigation();
      setupCommentModal();
      setupMaterialManagementModal();
      setupDeleteArchiveModal();
      setDefaultDateTime();
      setupBulkDelete();
      
      // Détection du swipe pour changer d'onglet
      setupSwipeNavigation();
      
      // Bouton refresh
      document.getElementById('refreshBtn').addEventListener('click', loadInterventions);
    });
    
    function initForm() {
      // Validation du formulaire
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', function(event) {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          
          form.classList.add('was-validated');
        }, false);
      });
      
      // Gestion des matériels
      document.getElementById('ajouterMateriel').addEventListener('click', function() {
        const input = document.getElementById('materielInput');
        const value = input.value.trim();
        if (value) {
          materiels.push(value);
          updateMaterielsDisplay();
          input.value = '';
          input.focus();
        }
      });
      
      // Entrée pour ajouter un matériel
      document.getElementById('materielInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('ajouterMateriel').click();
        }
      });

      // Gestion des membres d'équipe
      document.getElementById('ajouterMembre').addEventListener('click', function() {
        const input = document.getElementById('membreInput');
        const value = input.value.trim();
        if (value) {
          equipe.push(value);
          updateEquipeDisplay();
          input.value = '';
          input.focus();
        }
      });
      
      // Entrée pour ajouter un membre
      document.getElementById('membreInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('ajouterMembre').click();
        }
      });

      // Prévisualisation photos
      document.getElementById('photo').addEventListener('change', function(e) {
        const files = e.target.files;
        if (!files || files.length === 0) return;
        
        photosBase64 = [];
        const previewContainer = document.getElementById('photoPreview');
        previewContainer.innerHTML = '';
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          
          if (file.size > MAX_PHOTO_SIZE) {
            continue;
          }
          
          const reader = new FileReader();
          reader.onload = function(event) {
            photosBase64.push(event.target.result);
            
            previewContainer.innerHTML += `
              <div class="position-relative">
                <img src="${event.target.result}" class="img-thumbnail photo-thumbnail mb-2" style="height: 80px; width: auto;">
                <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 remove-photo" data-index="${photosBase64.length - 1}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            `;
            
            // Ajouter les événements pour supprimer les photos
            document.querySelectorAll('.remove-photo').forEach(btn => {
              btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                photosBase64.splice(index, 1);
                updatePhotosDisplay();
              });
            });
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Géolocalisation
      document.getElementById('geolocateBtn').addEventListener('click', function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              document.getElementById('latitude').value = latitude;
              document.getElementById('longitude').value = longitude;
              
              // Afficher la carte
              const mapContainer = document.getElementById('mapContainer');
              mapContainer.classList.remove('d-none');
              
              if (!map) {
                map = L.map('mapContainer').setView([latitude, longitude], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
              } else {
                map.setView([latitude, longitude], 15);
              }
              
              // Supprimer les marqueurs existants
              map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                  map.removeLayer(layer);
                }
              });
              
              // Ajouter un nouveau marqueur
              L.marker([latitude, longitude]).addTo(map)
                .bindPopup('Votre position actuelle')
                .openPopup();
              
              // Récupérer l'adresse
              fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
                .then(response => response.json())
                .then(data => {
                  const address = data.display_name || 'Position géolocalisée';
                  document.getElementById('lieu').value = address;
                })
                .catch(() => {
                  document.getElementById('lieu').value = `${latitude}, ${longitude}`;
                });
            },
            (error) => {
              console.error("Erreur de géolocalisation:", error);
            },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        } else {
          console.log('La géolocalisation n\'est pas supportée');
        }
      });
      
      // Soumission du formulaire
      document.getElementById('interventionForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (!this.checkValidity()) {
          return;
        }
        
        const nom = document.getElementById('nom').value.trim();
        const numero = document.getElementById('numero').value.trim();
        const date = document.getElementById('date').value;
        const heure = document.getElementById('heure').value;
        const lieu = document.getElementById('lieu').value.trim();
        const commune = document.getElementById('commune').value.trim();
        const commentaire = document.getElementById('commentaire').value.trim();
        const statut = document.getElementById('statut').value;
        const urgence = document.getElementById('urgence').value;
        const categorie = document.getElementById('categorie').value;
        const latitude = document.getElementById('latitude').value;
        const longitude = document.getElementById('longitude').value;
        
        const interventionData = {
          nom,
          numero_intervention: numero,
          date,
          heure,
          lieu,
          commune,
          materiels: [...materiels],
          equipe: [...equipe],
          commentaire,
          statut,
          urgence,
          categorie,
          archived: false,
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        if (latitude && longitude) {
          interventionData.latitude = parseFloat(latitude);
          interventionData.longitude = parseFloat(longitude);
        }
        
        if (photosBase64.length > 0) {
          interventionData.photos = [...photosBase64];
        }
        
        try {
          if (currentEditingId) {
            await database.ref('interventions/' + currentEditingId).update(interventionData);
          } else {
            await database.ref('interventions').push().set(interventionData);
          }
          resetForm();
          
          // Revenir à l'onglet des interventions après soumission
          const currentTab = new bootstrap.Tab(document.getElementById('current-tab'));
          currentTab.show();
        } catch (error) {
          console.error("Erreur Firebase:", error);
        }
      });
      
      // Réinitialisation du formulaire
      document.getElementById('resetForm').addEventListener('click', resetForm);
      
      // Téléchargement de photo
      document.getElementById('downloadPhoto').addEventListener('click', function() {
        const photoSrc = document.getElementById('fullPhoto').src;
        const link = document.createElement('a');
        link.href = photoSrc;
        link.download = `photo-intervention-${new Date().toISOString().slice(0, 10)}.jpg`;
        link.click();
      });
      
      // Impression d'intervention
      document.getElementById('printIntervention').addEventListener('click', function() {
        const modalBody = document.getElementById('modalBody').cloneNode(true);
        
        // Créer une fenêtre d'impression
        const printWindow = window.open('', '', 'width=800,height=600');
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Fiche d'intervention</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
              body { padding: 10px; font-size: 14px; }
              .print-header { text-align: center; margin-bottom: 15px; }
              .print-section { margin-bottom: 10px; }
              .print-section h5 { border-bottom: 1px solid #ddd; padding-bottom: 5px; }
              @media print {
                .no-print { display: none; }
                body { padding: 0; font-size: 12px; }
              }
            </style>
          </head>
          <body>
            <div class="print-header">
              <h4>Fiche d'intervention VSAV</h4>
              <p>${new Date().toLocaleDateString('fr-FR')}</p>
            </div>
            ${modalBody.innerHTML}
            <div class="no-print mt-3 text-center">
              <button onclick="window.print()" class="btn btn-primary me-2">
                <i class="bi bi-printer"></i> Imprimer
              </button>
              <button onclick="window.close()" class="btn btn-secondary">
                <i class="bi bi-x-lg"></i> Fermer
              </button>
            </div>
          </body>
          </html>
        `);
        printWindow.document.close();
      });
    }
    
    function setupBulkDelete() {
      // Sélection/désélection de toutes les interventions
      document.getElementById('selectAllCheckbox').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('#archivedInterventions .select-checkbox');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
          const id = checkbox.getAttribute('data-id');
          if (this.checked && !selectedInterventions.includes(id)) {
            selectedInterventions.push(id);
          } else if (!this.checked) {
            selectedInterventions = selectedInterventions.filter(i => i !== id);
          }
        });
        toggleDeleteSelectedButton();
      });
      
      // Bouton pour supprimer plusieurs interventions
      document.getElementById('deleteSelectedBtn').addEventListener('click', function() {
        if (selectedInterventions.length === 0) {
          showToast('Aucune intervention sélectionnée', 'warning');
          return;
        }
        
        document.getElementById('selectedCount').textContent = `${selectedInterventions.length} intervention(s) sélectionnée(s)`;
        const modal = new bootstrap.Modal(document.getElementById('deleteMultipleArchiveModal'));
        modal.show();
      });
      
      // Confirmation de suppression multiple
      document.getElementById('confirmDeleteMultipleArchiveBtn').addEventListener('click', async function() {
        const password = document.getElementById('deleteMultiplePassword').value;
        
        if (password !== DELETE_PASSWORD) {
          document.getElementById('deleteMultiplePassword').classList.add('is-invalid');
          return;
        }
        
        try {
          // Supprimer chaque intervention sélectionnée
          const deletePromises = selectedInterventions.map(id => 
            database.ref('interventions/' + id).remove()
          );
          
          await Promise.all(deletePromises);
          
          // Réinitialiser la sélection
          selectedInterventions = [];
          document.getElementById('selectAllCheckbox').checked = false;
          
          // Fermer le modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('deleteMultipleArchiveModal'));
          modal.hide();
          
          showToast('Interventions supprimées avec succès');
        } catch (error) {
          console.error("Erreur:", error);
          showToast('Erreur lors de la suppression', 'danger');
        }
      });
    }
    
    function toggleDeleteSelectedButton() {
      const btn = document.getElementById('deleteSelectedBtn');
      if (selectedInterventions.length > 0) {
        btn.style.display = 'block';
      } else {
        btn.style.display = 'none';
      }
    }
    
    function setupMobileNavigation() {
      // Navigation via les boutons mobiles
      document.querySelectorAll('.mobile-nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const tabId = this.getAttribute('data-tab');
          const tab = new bootstrap.Tab(document.getElementById(tabId));
          tab.show();
          
          // Mettre à jour l'item actif
          document.querySelectorAll('.mobile-nav-item').forEach(i => {
            i.classList.remove('active');
          });
          this.classList.add('active');
          
          // Faire défiler vers le haut
          window.scrollTo(0, 0);
        });
      });
      
      // Mettre à jour l'item actif lors du changement d'onglet
      document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function() {
          const tabId = this.id;
          document.querySelectorAll('.mobile-nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-tab') === tabId) {
              item.classList.add('active');
            }
          });
        });
      });
    }
    
    function setupCommentModal() {
      document.getElementById('saveCommentBtn').addEventListener('click', async function() {
        const interventionId = document.getElementById('commentInterventionId').value;
        const author = document.getElementById('commentAuthor').value.trim();
        const text = document.getElementById('commentText').value.trim();
        
        if (!author || !text) {
          return;
        }
        
        try {
          const newComment = {
            author,
            text,
            date: new Date().toISOString()
          };
          
          await database.ref(`interventions/${interventionId}/comments`).push().set(newComment);
          
          // Fermer le modal et réinitialiser
          const modal = bootstrap.Modal.getInstance(document.getElementById('commentModal'));
          modal.hide();
          
          document.getElementById('commentAuthor').value = '';
          document.getElementById('commentText').value = '';
          
          // Recharger les détails si la modal est ouverte
          if (document.getElementById('detailsModal').classList.contains('show')) {
            showDetailsModal(interventionId);
          }
        } catch (error) {
          console.error("Erreur:", error);
        }
      });
      
      // Gestion de la fermeture propre du modal
      document.getElementById('commentModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('commentAuthor').value = '';
        document.getElementById('commentText').value = '';
      });
    }
    
    function setupPharmacyTab() {
      // Connexion à la pharmacie
      document.getElementById('pharmacyLoginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const password = document.getElementById('pharmacyPassword').value;
        
        if (password === PHARMACY_PASSWORD) {
          isPharmacyAuthenticated = true;
          document.getElementById('pharmacyLogin').classList.add('d-none');
          document.getElementById('pharmacyContent').classList.remove('d-none');
          updatePharmacyInterventions();
        } else {
          document.getElementById('pharmacyPassword').classList.add('is-invalid');
        }
      });
      
      // Recherche dans la pharmacie
      document.getElementById('pharmacySearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#pharmacyInterventions tr');
        
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
      });
      
      // Export pharmacie
      document.getElementById('exportPharmacyBtn').addEventListener('click', exportPharmacyToExcel);
      
      // Ajout manuel de matériel
      document.getElementById('addMaterialBtn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('addMaterialModal'));
        modal.show();
      });
      
      // Sauvegarde du nouveau matériel
      document.getElementById('saveNewMaterialBtn').addEventListener('click', async function() {
        const name = document.getElementById('newMaterialName').value.trim();
        const quantity = parseInt(document.getElementById('newMaterialQuantity').value);
        const status = document.getElementById('newMaterialStatus').value;
        const author = document.getElementById('newMaterialAuthor').value.trim();
        const comment = document.getElementById('newMaterialComment').value.trim();
        
        if (!name || !author || isNaN(quantity) || quantity < 1) {
          return;
        }
        
        try {
          // Créer une nouvelle intervention factice pour le matériel manuel
          const interventionRef = database.ref('interventions').push();
          
          const interventionData = {
            nom: author,
            numero_intervention: 'MANUEL-' + new Date().getTime(),
            date: new Date().toISOString().split('T')[0],
            heure: '00:00',
            lieu: 'Ajout manuel',
            commune: '',
            materiels: [name],
            equipe: [],
            commentaire: '',
            statut: 'Terminé',
            urgence: 'Normal',
            categorie: 'Autre',
            archived: false,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
          };
          
          await interventionRef.set(interventionData);
          
          // Ajouter les détails du matériel en pharmacie
          const materialData = {};
          for (let i = 0; i < quantity; i++) {
            const materialKey = name + (quantity > 1 ? ` (${i+1})` : '');
            materialData[materialKey] = {
              status,
              author,
              comment,
              updatedAt: firebase.database.ServerValue.TIMESTAMP
            };
          }
          
          await database.ref(`interventions/${interventionRef.key}/pharmacyMaterials`).set(materialData);
          
          // Fermer le modal et réinitialiser
          const modal = bootstrap.Modal.getInstance(document.getElementById('addMaterialModal'));
          modal.hide();
          
          document.getElementById('newMaterialName').value = '';
          document.getElementById('newMaterialQuantity').value = '1';
          document.getElementById('newMaterialStatus').value = 'attente';
          document.getElementById('newMaterialAuthor').value = '';
          document.getElementById('newMaterialComment').value = '';
          
          showToast('Matériel ajouté avec succès');
        } catch (error) {
          console.error("Erreur:", error);
          showToast('Erreur lors de l\'ajout du matériel', 'danger');
        }
      });
    }
    
    function setupMaterialManagementModal() {
      document.getElementById('saveMaterialManagementBtn').addEventListener('click', async function() {
        const interventionId = document.getElementById('materialInterventionId').value;
        const materialName = document.getElementById('materialNameValue').value;
        const status = document.getElementById('materialStatusSelect').value;
        const author = document.getElementById('materialAuthor').value.trim();
        const comment = document.getElementById('materialComment').value.trim();
        
        try {
          // Mettre à jour le statut du matériel
          const materialData = {
            status,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
          };
          
          if (author) {
            materialData.author = author;
          }
          
          if (comment) {
            materialData.comment = comment;
          }
          
          await database.ref(`interventions/${interventionId}/pharmacyMaterials/${materialName}`).update(materialData);
          
          // Vérifier si tous les matériels sont réapprovisionnés
          const snapshot = await database.ref(`interventions/${interventionId}/pharmacyMaterials`).once('value');
          const materials = snapshot.val();
          
          const allReapprovisioned = Object.values(materials).every(m => m.status === 'reapprovisionne');
          
          if (allReapprovisioned) {
            await database.ref(`interventions/${interventionId}`).update({
              archived: true,
              statut: 'Terminé & Réapprovisionné',
              updatedAt: firebase.database.ServerValue.TIMESTAMP
            });
          }
          
          // Fermer le modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('materialManagementModal'));
          modal.hide();
          
          // Recharger la liste des matériels
          showPharmacyMaterialsModal(interventionId);
        } catch (error) {
          console.error("Erreur:", error);
        }
      });
      
      // Gestion de la fermeture propre du modal
      document.getElementById('materialManagementModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('materialAuthor').value = '';
        document.getElementById('materialComment').value = '';
      });
    }
    
    function setupDeleteArchiveModal() {
      document.getElementById('confirmDeleteArchiveBtn').addEventListener('click', async function() {
        const id = document.getElementById('deleteInterventionId').value;
        const password = document.getElementById('deletePassword').value;
        
        if (password !== DELETE_PASSWORD) {
          document.getElementById('deletePassword').classList.add('is-invalid');
          return;
        }
        
        try {
          await database.ref('interventions/' + id).remove();
          
          // Fermer le modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('deleteArchiveModal'));
          modal.hide();
        } catch (error) {
          console.error("Erreur:", error);
        }
      });
    }
    
    function setupSwipeNavigation() {
      const tabContent = document.getElementById('interventionTabsContent');
      
      tabContent.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
      }, false);
      
      tabContent.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      }, false);
    }
    
    function handleSwipe() {
      const tabs = ['form-tab', 'current-tab', 'archive-tab', 'pharmacy-tab', 'stats-tab'];
      const currentActiveIndex = tabs.findIndex(tab => document.getElementById(tab).classList.contains('active'));
      
      // Seuil de swipe (50px)
      if (touchStartX - touchEndX > 50) {
        // Swipe gauche - aller à l'onglet suivant
        if (currentActiveIndex < tabs.length - 1) {
          const nextTab = new bootstrap.Tab(document.getElementById(tabs[currentActiveIndex + 1]));
          nextTab.show();
        }
      } else if (touchEndX - touchStartX > 50) {
        // Swipe droit - aller à l'onglet précédent
        if (currentActiveIndex > 0) {
          const prevTab = new bootstrap.Tab(document.getElementById(tabs[currentActiveIndex - 1]));
          prevTab.show();
        }
      }
    }
    
    function setDefaultDateTime() {
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      document.getElementById('date').value = dateStr;
      
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      document.getElementById('heure').value = `${hours}:${minutes}`;
    }
    
    function resetForm() {
      const form = document.getElementById('interventionForm');
      form.reset();
      form.classList.remove('was-validated');
      document.getElementById('photoPreview').innerHTML = '';
      document.getElementById('mapContainer').classList.add('d-none');
      materiels = [];
      equipe = [];
      photosBase64 = [];
      updateMaterielsDisplay();
      updateEquipeDisplay();
      currentEditingId = null;
      document.getElementById('statut').value = 'En attente';
      document.getElementById('urgence').value = 'Normal';
      document.getElementById('categorie').value = 'Accident';
      setDefaultDateTime();
    }
    
    function updateMaterielsDisplay() {
      const container = document.getElementById('materielsList');
      container.innerHTML = materiels.map(m => `
        <span class="material-badge">
          ${m}
          <button type="button" class="btn-close" data-materiel="${m}" aria-label="Supprimer"></button>
        </span>
      `).join('');
      
      document.querySelectorAll('[data-materiel]').forEach(btn => {
        btn.addEventListener('click', function() {
          const mat = this.getAttribute('data-materiel');
          materiels = materiels.filter(m => m !== mat);
          updateMaterielsDisplay();
        });
      });
    }
    
    function updateEquipeDisplay() {
      const container = document.getElementById('equipeList');
      container.innerHTML = equipe.map(m => `
        <span class="material-badge">
          ${m}
          <button type="button" class="btn-close" data-membre="${m}" aria-label="Supprimer"></button>
        </span>
      `).join('');
      
      document.querySelectorAll('[data-membre]').forEach(btn => {
        btn.addEventListener('click', function() {
          const membre = this.getAttribute('data-membre');
          equipe = equipe.filter(m => m !== membre);
          updateEquipeDisplay();
        });
      });
    }
    
    function updatePhotosDisplay() {
      const previewContainer = document.getElementById('photoPreview');
      previewContainer.innerHTML = '';
      
      photosBase64.forEach((photo, index) => {
        previewContainer.innerHTML += `
          <div class="position-relative">
            <img src="${photo}" class="img-thumbnail photo-thumbnail mb-2" style="height: 80px; width: auto;">
            <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 remove-photo" data-index="${index}">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `;
      });
      
      // Ajouter les événements pour supprimer les photos
      document.querySelectorAll('.remove-photo').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          photosBase64.splice(index, 1);
          updatePhotosDisplay();
        });
      });
    }
    
    async function loadInterventions() {
      try {
        const snapshot = await database.ref('interventions').once('value');
        allInterventions = snapshot.val() || {};
        
        displayInterventions(allInterventions);
        updateStats(allInterventions);
        updateCharts(allInterventions);
        updatePharmacyInterventions();
      } catch (error) {
        console.error("Erreur de chargement:", error);
      }
    }
    
    function displayInterventions(interventions) {
      const currentContainer = document.getElementById('currentInterventionsCards');
      const archiveContainer = document.getElementById('archivedInterventions');
      
      currentContainer.innerHTML = '';
      archiveContainer.innerHTML = '';
      
      // Convertir en tableau et trier
      let interventionsArray = Object.entries(interventions).map(([id, data]) => ({ id, ...data }));
      
      // Trier
      interventionsArray.sort((a, b) => {
        if (a[currentSortField] < b[currentSortField]) {
          return currentSortDirection === 'asc' ? -1 : 1;
        }
        if (a[currentSortField] > b[currentSortField]) {
          return currentSortDirection === 'asc' ? 1 : -1;
        }
        return 0;
      });
      
      // Filtrer
      const currentInterventions = interventionsArray.filter(i => !i.archived && i.statut !== 'Terminé' && i.statut !== 'Terminé & Réapprovisionné');
      const archivedInterventions = interventionsArray.filter(i => i.archived || i.statut === 'Terminé & Réapprovisionné');
      
      // Appliquer le filtre de statut si défini
      const filteredCurrent = currentFilterStatus 
        ? currentInterventions.filter(i => i.statut === currentFilterStatus || i.urgence === currentFilterStatus)
        : currentInterventions;
      
      // Pagination pour les interventions actuelles
      const currentTotalPages = Math.ceil(filteredCurrent.length / ITEMS_PER_PAGE);
      const currentStartIndex = (currentPage - 1) * ITEMS_PER_PAGE;
      const currentPaginated = filteredCurrent.slice(currentStartIndex, currentStartIndex + ITEMS_PER_PAGE);
      
      // Pagination pour les archives
      const archiveTotalPages = Math.ceil(archivedInterventions.length / ITEMS_PER_PAGE);
      const archiveStartIndex = (archivePage - 1) * ITEMS_PER_PAGE;
      const archivePaginated = archivedInterventions.slice(archiveStartIndex, archiveStartIndex + ITEMS_PER_PAGE);
      
      // Afficher les interventions actuelles (vue cartes)
      currentPaginated.forEach(intervention => {
        currentContainer.innerHTML += createInterventionCard(intervention);
      });
      
      // Afficher les archives
      archivePaginated.forEach(intervention => {
        archiveContainer.innerHTML += createInterventionRow(intervention);
      });
      
      // Mettre à jour la pagination
      updatePagination('currentCardsPagination', currentPage, currentTotalPages, 'current');
      updatePagination('archivePagination', archivePage, archiveTotalPages, 'archive');
      
      // Ajouter les événements
      addInterventionEvents();
      
      // Mettre à jour le menu déroulant des filtres
      updateFilterDropdown();
      
      // Gestion des cases à cocher pour la suppression multiple
      setupCheckboxes();
    }
    
    function createInterventionRow(intervention) {
      const statusText = intervention.statut === 'Terminé & Réapprovisionné' ? 'Terminé & Réappro' : intervention.statut;
      const statusClass = intervention.statut === 'Terminé & Réapprovisionné' ? 'badge-termine-reappro' : getStatusBadgeClass(intervention.statut);
      
      return `
        <tr class="${intervention.archived ? 'archived' : ''}" data-id="${intervention.id}">
          <td>
            <input type="checkbox" class="select-checkbox" data-id="${intervention.id}">
          </td>
          <td>${intervention.numero_intervention}</td>
          <td>${intervention.nom}</td>
          <td>${formatDate(intervention.date)}</td>
          <td>
            <span class="badge ${statusClass}">
              ${statusText}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm btn-outline-primary view-btn" data-id="${intervention.id}" title="Voir">
                <i class="bi bi-eye"></i>
              </button>
              ${intervention.archived || intervention.statut === 'Terminé & Réapprovisionné' ? `
                <button class="btn btn-sm btn-outline-success unarchive-btn" data-id="${intervention.id}" title="Désarchiver">
                  <i class="bi bi-box-arrow-up"></i>
                </button>
              ` : ''}
              <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${intervention.id}" title="Supprimer">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }
    
    function createInterventionCard(intervention) {
      const photoThumb = intervention.photos?.[0] 
        ? `<img src="${intervention.photos[0]}" class="card-img-top photo-thumbnail" style="height: 160px; object-fit: cover;" data-full="${intervention.photos[0]}">`
        : '<div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 160px;"><i class="bi bi-image text-muted" style="font-size: 2rem;"></i></div>';
      
      const materielsDisplay = intervention.materiels?.slice(0, 3).join(', ') || 'Aucun matériel';
      const equipeDisplay = intervention.equipe?.slice(0, 3).join(', ') || 'Aucun membre';
      
      return `
        <div class="card intervention-card animate-fade-in" data-id="${intervention.id}">
          ${photoThumb}
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h5 class="card-title mb-0">${intervention.numero_intervention}</h5>
              <select class="status-select ${getStatusBadgeClass(intervention.statut)}" data-id="${intervention.id}" data-current="${intervention.statut}">
                <option value="En attente" ${intervention.statut === 'En attente' ? 'selected' : ''}>En attente</option>
                <option value="En cours" ${intervention.statut === 'En cours' ? 'selected' : ''}>En cours</option>
                <option value="Terminé" ${intervention.statut === 'Terminé' ? 'selected' : ''}>Terminé</option>
              </select>
            </div>
            <p class="card-text text-muted mb-1"><small>${formatDateTime(intervention.date, intervention.heure)}</small></p>
            <p class="card-text"><strong>${intervention.nom}</strong></p>
            <p class="card-text text-truncate"><small>${intervention.lieu || 'Non spécifié'}</small></p>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <span class="badge ${getUrgenceBadgeClass(intervention.urgence)}">
                ${intervention.urgence}
              </span>
              <div class="action-buttons">
                <button class="btn btn-sm btn-outline-primary view-btn" data-id="${intervention.id}" title="Voir">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary edit-btn" data-id="${intervention.id}" title="Modifier">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-info comment-btn" data-id="${intervention.id}" title="Commenter">
                  <i class="bi bi-chat-left-text"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    function setupCheckboxes() {
      // Gestion des cases à cocher individuelles
      document.querySelectorAll('#archivedInterventions .select-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const id = this.getAttribute('data-id');
          if (this.checked && !selectedInterventions.includes(id)) {
            selectedInterventions.push(id);
          } else {
            selectedInterventions = selectedInterventions.filter(i => i !== id);
          }
          
          // Mettre à jour la case "Tout sélectionner"
          const allCheckboxes = document.querySelectorAll('#archivedInterventions .select-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          document.getElementById('selectAllCheckbox').checked = allChecked;
          
          toggleDeleteSelectedButton();
        });
      });
    }
    
    function addInterventionEvents() {
      // Bouton Voir
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          showDetailsModal(id);
        });
      });
      
      // Bouton Modifier
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          editIntervention(id);
        });
      });
      
      // Bouton Commenter
      document.querySelectorAll('.comment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          document.getElementById('commentInterventionId').value = id;
          const commentModal = new bootstrap.Modal(document.getElementById('commentModal'));
          commentModal.show();
        });
      });
      
      // Changement de statut
      document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', async function() {
          const id = this.getAttribute('data-id');
          const newStatus = this.value;
          
          try {
            await database.ref('interventions/' + id).update({ 
              statut: newStatus,
              updatedAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Mettre à jour le style du select
            this.className = `status-select ${getStatusBadgeClass(newStatus)}`;
            
            // Si le statut est "Terminé", ajouter les matériels à la pharmacie
            if (newStatus === 'Terminé') {
              const intervention = allInterventions[id];
              if (intervention.materiels && intervention.materiels.length > 0) {
                const pharmacyMaterials = {};
                intervention.materiels.forEach(material => {
                  pharmacyMaterials[material] = {
                    status: 'attente',
                    comment: '',
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                  };
                });
                
                await database.ref(`interventions/${id}/pharmacyMaterials`).set(pharmacyMaterials);
              }
            }
          } catch (error) {
            // Revert to previous value
            const previousStatus = this.getAttribute('data-current');
            this.value = previousStatus;
          }
        });
      });
      
      // Bouton Désarchiver
      document.querySelectorAll('.unarchive-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const id = this.getAttribute('data-id');
          try {
            await database.ref('interventions/' + id).update({ 
              archived: false,
              statut: 'En attente', // Remettre en statut "En attente"
              updatedAt: firebase.database.ServerValue.TIMESTAMP
            });
          } catch (error) {
            console.error("Erreur:", error);
          }
        });
      });
      
      // Bouton Supprimer
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          document.getElementById('deleteInterventionId').value = id;
          const deleteModal = new bootstrap.Modal(document.getElementById('deleteArchiveModal'));
          deleteModal.show();
        });
      });
      
      // Clic sur les miniatures photo
      document.querySelectorAll('.photo-thumbnail').forEach(img => {
        img.addEventListener('click', function() {
          const fullPhoto = this.getAttribute('data-full') || this.src;
          document.getElementById('fullPhoto').src = fullPhoto;
          const photoModal = new bootstrap.Modal(document.getElementById('photoModal'));
          photoModal.show();
        });
      });
    }
    
    async function showDetailsModal(id) {
      try {
        const snapshot = await database.ref('interventions/' + id).once('value');
        const intervention = snapshot.val();
        
        if (!intervention) {
          return;
        }
        
        const photosHtml = intervention.photos?.length 
          ? `<div class="d-flex flex-wrap gap-2 mb-3">${intervention.photos.map(photo => 
              `<img src="${photo}" class="img-thumbnail photo-thumbnail" style="height: 80px; cursor: pointer;">`
            ).join('')}</div>`
          : '<p class="text-muted">Aucune photo</p>';
        
        const materielsHtml = intervention.materiels?.length 
          ? `<ul class="list-group mb-3">${intervention.materiels.map(m => `<li class="list-group-item py-2">${m}</li>`).join('')}</ul>`
          : '<p class="text-muted">Aucun matériel</p>';
        
        const equipeHtml = intervention.equipe?.length 
          ? `<ul class="list-group mb-3">${intervention.equipe.map(m => `<li class="list-group-item py-2">${m}</li>`).join('')}</ul>`
          : '<p class="text-muted">Aucun membre</p>';
        
        const mapButton = intervention.latitude && intervention.longitude 
          ? `<button class="btn btn-outline-primary mb-3 w-100" id="showOnMapBtn" data-lat="${intervention.latitude}" data-lng="${intervention.longitude}">
               <i class="bi bi-map"></i> Voir sur la carte
             </button>`
          : '';
        
        // Récupérer les commentaires
        let commentsHtml = '<p class="text-muted">Aucun commentaire</p>';
        if (intervention.comments) {
          const commentsArray = Object.values(intervention.comments);
          if (commentsArray.length > 0) {
            commentsHtml = `
              <div class="comment-list">
                ${commentsArray.sort((a, b) => new Date(b.date) - new Date(a.date)).map(comment => `
                  <div class="comment-item">
                    <div class="d-flex justify-content-between">
                      <span class="comment-author">${comment.author}</span>
                      <span class="comment-date">${formatDateTime(comment.date.split('T')[0], '00:00')}</span>
                    </div>
                    <p class="comment-text">${comment.text}</p>
                    <button class="btn btn-sm btn-outline-danger btn-block mt-2 delete-comment-btn" data-id="${id}" data-comment-id="${Object.keys(intervention.comments).find(key => intervention.comments[key] === comment)}">
                      <i class="bi bi-trash"></i> Supprimer
                    </button>
                  </div>
                `).join('')}
              </div>
            `;
          }
        }
        
        document.getElementById('modalBody').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <h6 class="text-muted">Responsable</h6>
                <p>${intervention.nom}</p>
              </div>
              <div class="mb-3">
                <h6 class="text-muted">Numéro</h6>
                <p>${intervention.numero_intervention}</p>
              </div>
              <div class="mb-3">
                <h6 class="text-muted">Date et heure</h6>
                <p>${formatDateTime(intervention.date, intervention.heure)}</p>
              </div>
              <div class="mb-3">
                <h6 class="text-muted">Lieu</h6>
                <p>${intervention.lieu || 'Non spécifié'}</p>
                ${mapButton}
              </div>
              <div class="mb-3">
                <h6 class="text-muted">Commune</h6>
                <p>${intervention.commune || 'Non spécifié'}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <h6 class="text-muted">Statut</h6>
                <span class="badge ${intervention.statut === 'Terminé & Réapprovisionné' ? 'badge-termine-reappro' : getStatusBadgeClass(intervention.statut)}">
                  ${intervention.statut === 'Terminé & Réapprovisionné' ? 'Terminé & Réappro' : intervention.statut}
                </span>
              </div>
              <div class="mb-3">
                <h6 class="text-muted">Urgence</h6>
                <span class="badge ${getUrgenceBadgeClass(intervention.urgence)}">${intervention.urgence}</span>
              </div>
              <div class="mb-3">
                <h6 class="text-muted">Catégorie</h6>
                <p>${intervention.categorie || 'Non spécifié'}</p>
              </div>
            </div>
            <div class="col-12">
              <div class="mb-3">
                <h6 class="text-muted">Matériels</h6>
                ${materielsHtml}
              </div>
              <div class="mb-3">
                <h6 class="text-muted">Équipe</h6>
                ${equipeHtml}
              </div>
              <div class="mb-3">
                <h6 class="text-muted">Photos</h6>
                ${photosHtml}
              </div>
              <div class="mb-3">
                <h6 class="text-muted">Commentaire principal</h6>
                <p>${intervention.commentaire || 'Aucun commentaire'}</p>
              </div>
              <div class="comment-section">
                <h6 class="text-muted">Commentaires</h6>
                ${commentsHtml}
                <button class="btn btn-sm btn-primary mt-2" id="addCommentBtn" data-id="${id}">
                  <i class="bi bi-plus-lg"></i> Ajouter un commentaire
                </button>
              </div>
            </div>
          </div>
        `;
        
        // Ajouter l'événement pour les photos
        document.querySelectorAll('#modalBody .photo-thumbnail').forEach(photo => {
          photo.addEventListener('click', function() {
            document.getElementById('fullPhoto').src = this.src;
            const photoModal = new bootstrap.Modal(document.getElementById('photoModal'));
            photoModal.show();
          });
        });
        
        // Ajouter l'événement pour le bouton de carte
        const mapBtn = document.getElementById('showOnMapBtn');
        if (mapBtn) {
          mapBtn.addEventListener('click', function() {
            const lat = parseFloat(this.getAttribute('data-lat'));
            const lng = parseFloat(this.getAttribute('data-lng'));
            
            // Initialiser la carte
            const mapElement = document.getElementById('interventionMap');
            if (!mapElement._leaflet_map) {
              const interventionMap = L.map('interventionMap').setView([lat, lng], 15);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
              }).addTo(interventionMap);
              
              // Ajouter le marqueur
              L.marker([lat, lng]).addTo(interventionMap)
                .bindPopup('Lieu de l\'intervention')
                .openPopup();
            } else {
              const interventionMap = mapElement._leaflet_map;
              interventionMap.setView([lat, lng], 15);
              
              // Supprimer les anciens marqueurs et en ajouter un nouveau
              interventionMap.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                  interventionMap.removeLayer(layer);
                }
              });
              
              L.marker([lat, lng]).addTo(interventionMap)
                .bindPopup('Lieu de l\'intervention')
                .openPopup();
            }
            
            const mapModal = new bootstrap.Modal(document.getElementById('mapModal'));
            mapModal.show();
          });
        }
        
        // Ajouter l'événement pour le bouton de commentaire
        document.getElementById('addCommentBtn').addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          document.getElementById('commentInterventionId').value = id;
          const commentModal = new bootstrap.Modal(document.getElementById('commentModal'));
          commentModal.show();
        });
        
        // Ajouter les événements pour supprimer les commentaires
        document.querySelectorAll('.delete-comment-btn').forEach(btn => {
          btn.addEventListener('click', async function() {
            const interventionId = this.getAttribute('data-id');
            const commentId = this.getAttribute('data-comment-id');
            
            if (confirm("Supprimer ce commentaire ?")) {
              try {
                await database.ref(`interventions/${interventionId}/comments/${commentId}`).remove();
                showDetailsModal(interventionId);
              } catch (error) {
                console.error("Erreur:", error);
              }
            }
          });
        });

        const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
        detailsModal.show();
      } catch (error) {
        console.error("Erreur:", error);
      }
    }

    async function editIntervention(id) {
      try {
        const snapshot = await database.ref('interventions/' + id).once('value');
        const intervention = snapshot.val();
        
        if (!intervention) {
          return;
        }
        
        // Remplir le formulaire
        document.getElementById('interventionId').value = id;
        document.getElementById('numero').value = intervention.numero_intervention;
        document.getElementById('date').value = intervention.date;
        document.getElementById('heure').value = intervention.heure;
        document.getElementById('nom').value = intervention.nom;
        document.getElementById('lieu').value = intervention.lieu || '';
        document.getElementById('commune').value = intervention.commune || '';
        document.getElementById('commentaire').value = intervention.commentaire || '';
        document.getElementById('statut').value = intervention.statut === 'Terminé & Réapprovisionné' ? 'Terminé' : intervention.statut || 'En attente';
        document.getElementById('urgence').value = intervention.urgence || 'Normal';
        document.getElementById('categorie').value = intervention.categorie || 'Accident';
        
        if (intervention.latitude && intervention.longitude) {
          document.getElementById('latitude').value = intervention.latitude;
          document.getElementById('longitude').value = intervention.longitude;
          
          // Afficher la carte si des coordonnées existent
          const mapContainer = document.getElementById('mapContainer');
          mapContainer.classList.remove('d-none');
          
          if (!map) {
            map = L.map('mapContainer').setView([intervention.latitude, intervention.longitude], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
          } else {
            map.setView([intervention.latitude, intervention.longitude], 15);
          }
          
          // Supprimer les marqueurs existants
          map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
              map.removeLayer(layer);
            }
          });
          
          // Ajouter un nouveau marqueur
          L.marker([intervention.latitude, intervention.longitude]).addTo(map)
            .bindPopup('Position de l\'intervention')
            .openPopup();
        }
        
        // Mettre à jour les matériels et l'équipe
        materiels = intervention.materiels || [];
        equipe = intervention.equipe || [];
        updateMaterielsDisplay();
        updateEquipeDisplay();
        
        // Mettre à jour les photos
        photosBase64 = intervention.photos || [];
        updatePhotosDisplay();
        
        currentEditingId = id;
        
        // Basculer vers l'onglet de formulaire
        const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
        formTab.show();
        
        // Faire défiler vers le haut
        window.scrollTo(0, 0);
      } catch (error) {
        console.error("Erreur:", error);
      }
    }

    function updatePagination(elementId, currentPage, totalPages, type) {
      const pagination = document.getElementById(elementId);
      pagination.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      // Bouton précédent
      pagination.innerHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage - 1}" data-type="${type}">
            <i class="bi bi-chevron-left"></i>
          </a>
        </li>
      `;
      
      // Pages
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      if (startPage > 1) {
        pagination.innerHTML += `
          <li class="page-item">
            <a class="page-link" href="#" data-page="1" data-type="${type}">1</a>
          </li>
          ${startPage > 2 ? '<li class="page-item disabled"><span class="page-link">...</span></li>' : ''}
        `;
      }
      
      for (let i = startPage; i <= endPage; i++) {
        pagination.innerHTML += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}" data-type="${type}">${i}</a>
          </li>
        `;
      }
      
      if (endPage < totalPages) {
        pagination.innerHTML += `
          ${endPage < totalPages - 1 ? '<li class="page-item disabled"><span class="page-link">...</span></li>' : ''}
          <li class="page-item">
            <a class="page-link" href="#" data-page="${totalPages}" data-type="${type}">${totalPages}</a>
          </li>
        `;
      }
      
      // Bouton suivant
      pagination.innerHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage + 1}" data-type="${type}">
            <i class="bi bi-chevron-right"></i>
          </a>
        </li>
      `;
      
      // Ajouter les événements
      document.querySelectorAll(`#${elementId} .page-link`).forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const page = parseInt(this.getAttribute('data-page'));
          const type = this.getAttribute('data-type');
          
          if (type === 'current') {
            currentPage = page;
          } else {
            archivePage = page;
          }
          
          displayInterventions(allInterventions);
        });
      });
    }

    function updateFilterDropdown() {
      const allItems = document.querySelectorAll('#filterDropdown + .dropdown-menu .dropdown-item');
      allItems.forEach(item => {
        const filterValue = item.getAttribute('data-filter');
        item.classList.toggle('active', filterValue === currentFilterStatus);
      });
    }

    function setupRealtime() {
      database.ref('interventions').on('value', (snapshot) => {
        allInterventions = snapshot.val() || {};
        displayInterventions(allInterventions);
        updateStats(allInterventions);
        updateCharts(allInterventions);
        updatePharmacyInterventions();
      });
    }

    function setupSearch() {
      // Recherche dans les interventions actuelles
      document.getElementById('currentSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const cards = document.querySelectorAll('#currentInterventionsCards .card');
        
        cards.forEach(card => {
          const text = card.textContent.toLowerCase();
          card.style.display = text.includes(searchTerm) ? '' : 'none';
        });
      });
      
      // Recherche dans les archives
      document.getElementById('archiveSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#archivedInterventions tr');
        
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
      });
    }

    function setupSorting() {
      document.querySelectorAll('.sortable-header').forEach(header => {
        header.addEventListener('click', function() {
          const field = this.getAttribute('data-sort');
          
          if (currentSortField === field) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            currentSortField = field;
            currentSortDirection = 'desc';
          }
          
          displayInterventions(allInterventions);
        });
      });
    }

    function setupFilters() {
      document.querySelectorAll('[data-filter]').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          currentFilterStatus = this.getAttribute('data-filter') === 'all' ? null : this.getAttribute('data-filter');
          currentPage = 1;
          displayInterventions(allInterventions);
        });
      });
    }

    function setupExports() {
      // Export Excel
      document.getElementById('exportExcel').addEventListener('click', function(e) {
        e.preventDefault();
        exportToExcel();
      });
      
      // Export PDF
      document.getElementById('exportPDF').addEventListener('click', function(e) {
        e.preventDefault();
        exportToPDF();
      });
      
      // Export CSV
      document.getElementById('exportCSV').addEventListener('click', function(e) {
        e.preventDefault();
        exportToCSV();
      });
    }

    function exportToExcel() {
      try {
        // Filtrer les interventions non archivées
        const interventionsArray = Object.entries(allInterventions)
          .filter(([id, data]) => !data.archived && data.statut !== 'Terminé' && data.statut !== 'Terminé & Réapprovisionné')
          .map(([id, data]) => ({ id, ...data }));
        
        // Créer un tableau de données
        const data = [
          ['N° Intervention', 'Responsable', 'Date', 'Heure', 'Lieu', 'Commune', 'Statut', 'Urgence', 'Catégorie', 'Matériels', 'Équipe']
        ];
        
        interventionsArray.forEach(intervention => {
          data.push([
            intervention.numero_intervention,
            intervention.nom,
            formatDate(intervention.date),
            intervention.heure,
            intervention.lieu || '',
            intervention.commune || '',
            intervention.statut,
            intervention.urgence,
            intervention.categorie,
            intervention.materiels?.join(', ') || '',
            intervention.equipe?.join(', ') || ''
          ]);
        });
        
        // Créer un classeur Excel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, 'Interventions');
        
        // Exporter
        XLSX.writeFile(wb, `interventions_vsav_${new Date().toISOString().slice(0, 10)}.xlsx`);
      } catch (error) {
        console.error("Erreur d'export Excel:", error);
        showToast('Erreur lors de l\'export Excel', 'danger');
      }
    }

    function exportToPDF() {
      try {
        // Filtrer les interventions non archivées
        const interventionsArray = Object.entries(allInterventions)
          .filter(([id, data]) => !data.archived && data.statut !== 'Terminé' && data.statut !== 'Terminé & Réapprovisionné')
          .map(([id, data]) => ({ id, ...data }));
        
        // Créer un nouveau document PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Titre
        doc.setFontSize(18);
        doc.text('Liste des Interventions VSAV', 105, 15, { align: 'center' });
        doc.setFontSize(12);
        doc.text(`Généré le ${new Date().toLocaleDateString('fr-FR')}`, 105, 22, { align: 'center' });
        
        // En-têtes de colonnes
        const headers = [
          'N° Intervention',
          'Responsable',
          'Date',
          'Statut',
          'Urgence'
        ];
        
        // Données
        const data = interventionsArray.map(intervention => [
          intervention.numero_intervention,
          intervention.nom,
          formatDate(intervention.date),
          intervention.statut,
          intervention.urgence
        ]);
        
        // Tableau
        doc.autoTable({
          head: [headers],
          body: data,
          startY: 30,
          styles: {
            fontSize: 10,
            cellPadding: 2
          },
          headStyles: {
            fillColor: [67, 97, 238],
            textColor: 255,
            fontStyle: 'bold'
          },
          alternateRowStyles: {
            fillColor: [248, 250, 253]
          }
        });
        
        // Enregistrer
        doc.save(`interventions_vsav_${new Date().toISOString().slice(0, 10)}.pdf`);
      } catch (error) {
        console.error("Erreur d'export PDF:", error);
        showToast('Erreur lors de l\'export PDF', 'danger');
      }
    }

    function exportToCSV() {
      try {
        // Filtrer les interventions non archivées
        const interventionsArray = Object.entries(allInterventions)
          .filter(([id, data]) => !data.archived && data.statut !== 'Terminé' && data.statut !== 'Terminé & Réapprovisionné')
          .map(([id, data]) => ({ id, ...data }));
        
        // En-têtes CSV
        let csv = 'N° Intervention,Responsable,Date,Heure,Lieu,Commune,Statut,Urgence,Catégorie,Matériels,Équipe\n';
        
        // Données
        interventionsArray.forEach(intervention => {
          csv += `"${intervention.numero_intervention}","${intervention.nom}","${formatDate(intervention.date)}","${intervention.heure}","${intervention.lieu || ''}","${intervention.commune || ''}","${intervention.statut}","${intervention.urgence}","${intervention.categorie}","${intervention.materiels?.join(', ') || ''}","${intervention.equipe?.join(', ') || ''}"\n`;
        });
        
        // Créer un blob et le télécharger
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `interventions_vsav_${new Date().toISOString().slice(0, 10)}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (error) {
        console.error("Erreur d'export CSV:", error);
        showToast('Erreur lors de l\'export CSV', 'danger');
      }
    }

    function exportPharmacyToExcel() {
      try {
        // Filtrer les interventions avec matériels en pharmacie
        const interventionsArray = Object.entries(allInterventions)
          .filter(([id, data]) => data.pharmacyMaterials)
          .map(([id, data]) => ({ id, ...data }));
        
        // Créer un tableau de données
        const data = [
          ['N° Intervention', 'Date', 'Responsable', 'Commune', 'Matériel', 'Statut', 'Auteur', 'Commentaire']
        ];
        
        interventionsArray.forEach(intervention => {
          Object.entries(intervention.pharmacyMaterials).forEach(([material, details]) => {
            data.push([
              intervention.numero_intervention,
              formatDate(intervention.date),
              intervention.nom,
              intervention.commune || '',
              material,
              getMaterialStatusText(details.status),
              details.author || '',
              details.comment || ''
            ]);
          });
        });
        
        // Créer un classeur Excel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, 'Pharmacie');
        
        // Exporter
        XLSX.writeFile(wb, `pharmacie_vsav_${new Date().toISOString().slice(0, 10)}.xlsx`);
      } catch (error) {
        console.error("Erreur d'export Excel:", error);
        showToast('Erreur lors de l\'export de la pharmacie', 'danger');
      }
    }

    function updateStats(interventions) {
      const interventionsArray = Object.values(interventions);
      
      // Compteurs de statut
      const enCours = interventionsArray.filter(i => !i.archived && i.statut === 'En cours').length;
      const termine = interventionsArray.filter(i => i.statut === 'Terminé').length;
      const termineReappro = interventionsArray.filter(i => i.statut === 'Terminé & Réapprovisionné').length;
      const enAttente = interventionsArray.filter(i => !i.archived && i.statut === 'En attente').length;
      const archive = interventionsArray.filter(i => i.archived).length;
      
      document.getElementById('stats-en-cours').textContent = enCours;
      document.getElementById('stats-termine').textContent = termine + termineReappro;
      document.getElementById('stats-en-attente').textContent = enAttente;
      document.getElementById('stats-archive').textContent = archive;
      
      // KPI
      const urgentCount = interventionsArray.filter(i => i.urgence === 'Urgent').length;
      const critiqueCount = interventionsArray.filter(i => i.urgence === 'Critique').length;
      document.getElementById('urgentCount').textContent = urgentCount + critiqueCount;
      
      // Taux de résolution (pourcentage de Terminé)
      const total = interventionsArray.length;
      const resolved = termine + termineReappro;
      const resolutionRate = total > 0 ? Math.round((resolved / total) * 100) : 0;
      document.getElementById('resolutionRate').textContent = `${resolutionRate}%`;
      
      // Temps moyen (simulé)
      const avgMinutes = total > 0 ? Math.floor(Math.random() * 120) + 30 : 0;
      document.getElementById('avgDuration').textContent = 
        `${Math.floor(avgMinutes / 60)}h${String(avgMinutes % 60).padStart(2, '0')}`;
    }

    function updateCharts(interventions) {
      const interventionsArray = Object.values(interventions);
      
      // Données mensuelles (12 derniers mois)
      const monthlyData = getMonthlyData(interventionsArray);
      
      // Données par statut
      const statusData = {
        'En attente': interventionsArray.filter(i => !i.archived && i.statut === 'En attente').length,
        'En cours': interventionsArray.filter(i => !i.archived && i.statut === 'En cours').length,
        'Terminé': interventionsArray.filter(i => i.statut === 'Terminé').length,
        'Terminé & Réappro': interventionsArray.filter(i => i.statut === 'Terminé & Réapprovisionné').length,
        'Archivé': interventionsArray.filter(i => i.archived).length
      };
      
      // Données par catégorie
      const categoryData = {};
      interventionsArray.forEach(i => {
        categoryData[i.categorie] = (categoryData[i.categorie] || 0) + 1;
      });
      
      // Chart.js configuration
      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      };
      
      // Chart mensuel
      const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
      
      if (monthlyChart) {
        monthlyChart.destroy();
      }
      
      monthlyChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: monthlyData.labels,
          datasets: [{
            label: 'Interventions par mois',
            data: monthlyData.values,
            backgroundColor: '#4361ee',
            borderColor: '#3f37c9',
            borderWidth: 1
          }]
        },
        options: chartOptions
      });
      
      // Chart par statut
      const statusCtx = document.getElementById('statusChart').getContext('2d');
      
      if (statusChart) {
        statusChart.destroy();
      }
      
      statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(statusData),
          datasets: [{
            data: Object.values(statusData),
            backgroundColor: [
              '#f8961e', // En attente
              '#4361ee', // En cours
              '#4cc9f0', // Terminé
              '#198754', // Terminé & Réappro
              '#f72585'  // Archivé
            ],
            borderWidth: 1
          }]
        },
        options: chartOptions
      });
      
      // Chart par catégorie
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      
      if (categoryChart) {
        categoryChart.destroy();
      }
      
      categoryChart = new Chart(categoryCtx, {
        type: 'pie',
        data: {
          labels: Object.keys(categoryData),
          datasets: [{
            data: Object.values(categoryData),
            backgroundColor: [
              '#4361ee',
              '#4cc9f0',
              '#f8961e',
              '#f72585',
              '#4895ef',
              '#3f37c9'
            ],
            borderWidth: 1
          }]
        },
        options: chartOptions
      });
    }

    function getMonthlyData(interventions) {
      const now = new Date();
      const months = [];
      const counts = [];
      
      for (let i = 11; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthYear = date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' });
        months.push(monthYear);
        
         const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
        const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        
        const count = interventions.filter(i => {
          const interventionDate = new Date(i.date);
          return interventionDate >= monthStart && interventionDate <= monthEnd;
        }).length;
        
        counts.push(count);
      }
      
      return {
        labels: months,
        values: counts
      };
    }

    function updatePharmacyInterventions() {
      if (!isPharmacyAuthenticated) return;
      
      const interventionsArray = Object.entries(allInterventions)
        .filter(([id, data]) => data.pharmacyMaterials)
        .map(([id, data]) => ({ id, ...data }));
      
      const container = document.getElementById('pharmacyInterventions');
      container.innerHTML = '';
      
      interventionsArray.forEach(intervention => {
        const materialsCount = Object.keys(intervention.pharmacyMaterials).length;
        const pendingMaterials = Object.values(intervention.pharmacyMaterials).filter(m => m.status === 'attente').length;
        const orderedMaterials = Object.values(intervention.pharmacyMaterials).filter(m => m.status === 'commande').length;
        const receivedMaterials = Object.values(intervention.pharmacyMaterials).filter(m => m.status === 'reapprovisionne').length;
        
        container.innerHTML += `
          <tr>
            <td>${intervention.numero_intervention}</td>
            <td>${formatDate(intervention.date)}</td>
            <td>${intervention.nom}</td>
            <td>${intervention.commune || ''}</td>
            <td>
              <span class="badge bg-light text-dark">Total: ${materialsCount}</span>
              <span class="badge status-attente">En attente: ${pendingMaterials}</span>
              <span class="badge status-commande">Commandé: ${orderedMaterials}</span>
              <span class="badge status-recu">Reçu: ${receivedMaterials}</span>
            </td>
            <td>
              <button class="btn btn-sm btn-outline-primary manage-materials-btn" data-id="${intervention.id}">
                <i class="bi bi-box-seam"></i> Gérer
              </button>
            </td>
          </tr>
        `;
      });
      
      // Ajouter les événements pour gérer les matériels
      document.querySelectorAll('.manage-materials-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          showPharmacyMaterialsModal(id);
        });
      });
    }

    async function showPharmacyMaterialsModal(interventionId) {
      try {
        const snapshot = await database.ref(`interventions/${interventionId}`).once('value');
        const intervention = snapshot.val();
        
        if (!intervention || !intervention.pharmacyMaterials) {
          return;
        }
        
        document.getElementById('pharmacyInterventionId').value = interventionId;
        const container = document.getElementById('pharmacyMaterialList');
        container.innerHTML = '';
        
        Object.entries(intervention.pharmacyMaterials).forEach(([material, details]) => {
          container.innerHTML += `
            <div class="material-card">
              <div class="material-header">
                <h6 class="material-name">${material}</h6>
                <span class="material-status ${getMaterialStatusClass(details.status)}">
                  ${getMaterialStatusText(details.status)}
                </span>
              </div>
              <div class="material-details">
                <p><small>Dernière mise à jour: ${formatDateTime(new Date(details.updatedAt).toISOString().split('T')[0])}</small></p>
                ${details.comment ? `<p class="text-muted">${details.comment}</p>` : ''}
              </div>
              <button class="btn btn-sm btn-outline-primary w-100 manage-material-btn" 
                      data-id="${interventionId}" 
                      data-material="${material}">
                <i class="bi bi-pencil"></i> Modifier
              </button>
            </div>
          `;
        });
        
        // Ajouter les événements pour modifier les matériels
        document.querySelectorAll('.manage-material-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const material = this.getAttribute('data-material');
            showMaterialManagementModal(id, material);
          });
        });
        
        const modal = new bootstrap.Modal(document.getElementById('pharmacyMaterialModal'));
        modal.show();
      } catch (error) {
        console.error("Erreur:", error);
      }
    }

    function showMaterialManagementModal(interventionId, materialName) {
      const intervention = allInterventions[interventionId];
      if (!intervention || !intervention.pharmacyMaterials || !intervention.pharmacyMaterials[materialName]) {
        return;
      }
      
      const materialDetails = intervention.pharmacyMaterials[materialName];
      
      document.getElementById('materialInterventionId').value = interventionId;
      document.getElementById('materialNameValue').value = materialName;
      document.getElementById('materialNameDisplay').textContent = materialName;
      document.getElementById('materialStatusSelect').value = materialDetails.status;
      document.getElementById('materialAuthor').value = materialDetails.author || '';
      document.getElementById('materialComment').value = materialDetails.comment || '';
      
      const modal = new bootstrap.Modal(document.getElementById('materialManagementModal'));
      modal.show();
    }

    function getMaterialStatusClass(status) {
      switch (status) {
        case 'attente': return 'status-attente';
        case 'commande': return 'status-commande';
        case 'reapprovisionne': return 'status-recu';
        default: return '';
      }
    }

    function getMaterialStatusText(status) {
      switch (status) {
        case 'attente': return 'En attente';
        case 'commande': return 'En commande';
        case 'reapprovisionne': return 'Réapprovisionné';
        default: return status;
      }
    }

    function getStatusBadgeClass(status) {
      switch (status) {
        case 'En cours': return 'badge-en-cours';
        case 'Terminé': return 'badge-termine';
        case 'En attente': return 'badge-en-attente';
        default: return 'badge-secondary';
      }
    }

    function getUrgenceBadgeClass(urgence) {
      switch (urgence) {
        case 'Urgent': return 'badge-urgent';
        case 'Critique': return 'badge-critique';
        default: return 'badge-secondary';
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR');
    }

    function formatDateTime(dateStr, timeStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return `${date.toLocaleDateString('fr-FR')} à ${timeStr || '00:00'}`;
    }

    function showToast(message, type = 'success') {
      const toastContainer = document.getElementById('toastContainer');
      const toastId = 'toast-' + Date.now();
      
      const toast = document.createElement('div');
      toast.className = `toast show align-items-center text-white bg-${type} border-0`;
      toast.role = 'alert';
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.id = toastId;
      
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      // Supprimer le toast après 5 secondes
      setTimeout(() => {
        const toastElement = document.getElementById(toastId);
        if (toastElement) {
          toastElement.classList.remove('show');
          setTimeout(() => toastElement.remove(), 150);
        }
      }, 5000);
    }
  </script>
</body>
</html>